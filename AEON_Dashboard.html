<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AEON-Delta v3.2 ‚Äî Production Control Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Oxanium:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060810; --bg2:#0a0d14; --surface:#0e1220; --surface2:#141826;
  --surface3:#1a1f30; --border:#1e2535; --border2:#252d40;
  --accent:#00d4ff; --accent-dim:rgba(0,212,255,0.1); --accent-glow:rgba(0,212,255,0.22);
  --purple:#7c3aed; --purple-dim:rgba(124,58,237,0.1);
  --green:#10b981; --green-dim:rgba(16,185,129,0.1);
  --warn:#f59e0b; --warn-dim:rgba(245,158,11,0.1);
  --danger:#ef4444; --danger-dim:rgba(239,68,68,0.1);
  --text:#e2e8f0; --text2:#94a3b8; --text3:#64748b;
  --mono:'JetBrains Mono',monospace; --display:'Oxanium',sans-serif;
  --r:10px; --rlg:14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--mono);font-size:13px;line-height:1.5;overflow-x:hidden;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

.shell{display:grid;grid-template-columns:220px 1fr;grid-template-rows:50px 1fr;min-height:100vh;}

/* TOPBAR */
.topbar{grid-column:1/-1;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:12px;position:sticky;top:0;z-index:200;}
.logo{font-family:var(--display);font-weight:800;font-size:17px;letter-spacing:2px;background:linear-gradient(90deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.ver{font-size:10px;color:var(--text3);border:1px solid var(--border2);padding:2px 8px;border-radius:4px;}
.spacer{flex:1;}
.conn-badge{display:flex;align-items:center;gap:6px;font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid;transition:all 0.3s;cursor:pointer;}
.conn-badge.connected{background:var(--green-dim);border-color:rgba(16,185,129,0.3);color:var(--green);}
.conn-badge.disconnected{background:var(--danger-dim);border-color:rgba(239,68,68,0.3);color:var(--danger);}
.conn-badge.connecting{background:var(--warn-dim);border-color:rgba(245,158,11,0.3);color:var(--warn);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
.dot.pulse{animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.dev-badge{display:flex;align-items:center;gap:6px;font-size:11px;background:var(--accent-dim);border:1px solid rgba(0,212,255,0.2);color:var(--accent);padding:4px 12px;border-radius:6px;}
.tb-btn{background:var(--surface3);border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:6px;font-family:var(--mono);font-size:11px;cursor:pointer;}
.tb-btn:hover{color:var(--text);border-color:var(--border2);}
#clock{font-size:11px;color:var(--text3);}

/* SIDEBAR */
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:14px 0;overflow-y:auto;position:sticky;top:50px;height:calc(100vh - 50px);}
.nav-group{margin-bottom:6px;}
.nav-label{font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;padding:8px 14px 4px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 12px;margin:1px 6px;border-radius:var(--r);cursor:pointer;color:var(--text3);font-size:12px;transition:all 0.12s;border:1px solid transparent;user-select:none;}
.nav-item:hover{background:var(--surface3);color:var(--text);border-color:var(--border);}
.nav-item.active{background:var(--accent-dim);color:var(--accent);border-color:rgba(0,212,255,0.25);}
.nav-icon{width:16px;text-align:center;font-size:13px;flex-shrink:0;}
.nav-badge{margin-left:auto;font-size:9px;padding:1px 6px;border-radius:10px;background:var(--danger-dim);color:var(--danger);}
.nav-badge.green{background:var(--green-dim);color:var(--green);}

/* MAIN */
.main{overflow-y:auto;height:calc(100vh - 50px);}
.panel{display:none;padding:22px;animation:fadeIn 0.18s ease;}
.panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}

/* COMPONENTS */
.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
.ph-title{font-family:var(--display);font-size:20px;font-weight:700;}
.ph-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.btns{display:flex;gap:8px;flex-wrap:wrap;}

.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--r);font-family:var(--mono);font-size:12px;cursor:pointer;border:1px solid transparent;transition:all 0.12s;white-space:nowrap;}
.btn-primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
.btn-primary:hover{background:#1ae0ff;box-shadow:0 0 14px var(--accent-glow);}
.btn-secondary{background:var(--accent-dim);color:var(--accent);border-color:rgba(0,212,255,0.25);}
.btn-secondary:hover{background:rgba(0,212,255,0.16);}
.btn-danger{background:var(--danger-dim);color:var(--danger);border-color:rgba(239,68,68,0.25);}
.btn-ghost{background:transparent;color:var(--text3);border-color:var(--border);}
.btn-ghost:hover{background:var(--surface3);color:var(--text);}
.btn-green{background:var(--green-dim);color:var(--green);border-color:rgba(16,185,129,0.25);}
.btn-purple{background:var(--purple-dim);color:#a78bfa;border-color:rgba(124,58,237,0.25);}
.btn:disabled{opacity:0.35;cursor:not-allowed;pointer-events:none;}
.spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(0,0,0,0.2);border-top-color:currentColor;border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;}
@media(max-width:1200px){.g5,.g4{grid-template-columns:1fr 1fr} .g3{grid-template-columns:1fr 1fr}}
@media(max-width:760px){.g2,.g3,.g4,.g5{grid-template-columns:1fr}.shell{grid-template-columns:1fr}.sidebar{display:none}}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:16px;transition:border-color 0.2s;}
.card:hover{border-color:var(--border2);}
.card.ca{border-left:3px solid var(--accent);}
.card.cg{border-left:3px solid var(--green);}
.card.cp{border-left:3px solid var(--purple);}
.card.cw{border-left:3px solid var(--warn);}
.card.cd{border-left:3px solid var(--danger);}
.ct{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
.cv{font-family:var(--display);font-size:26px;font-weight:700;line-height:1;}
.cv.ca{color:var(--accent);} .cv.cg{color:var(--green);} .cv.cp{color:var(--purple);} .cv.cw{color:var(--warn);}
.cm-t{font-size:10px;color:var(--text3);margin-top:3px;}
.mbar{height:3px;background:var(--surface3);border-radius:2px;margin-top:8px;overflow:hidden;}
.mfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--purple));transition:width 0.8s cubic-bezier(0.4,0,0.2,1);}
.mfill.g{background:var(--green);}.mfill.w{background:var(--warn);}.mfill.d{background:var(--danger);}

.stitle{font-family:var(--display);font-size:12px;font-weight:600;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin:20px 0 10px;display:flex;align-items:center;gap:10px;}
.stitle::after{content:'';flex:1;height:1px;background:var(--border);}

/* FORM */
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
.fl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;}
.fh{font-size:10px;color:var(--text3);margin-top:2px;line-height:1.4;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;}
.fr4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:10px;}
input[type=text],input[type=number],select,textarea{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:6px 9px;color:var(--text);font-family:var(--mono);font-size:12px;width:100%;transition:border-color 0.12s;-webkit-appearance:none;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-dim);}
textarea{resize:vertical;min-height:70px;}
.tog-row{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
.tog-row:last-child{border-bottom:none;}
.tog-info{flex:1;padding-right:10px;}
.tog-name{font-size:12px;color:var(--accent);}
.tog-desc{font-size:10px;color:var(--text3);margin-top:1px;}
.tog-def{font-size:9px;color:var(--warn);}
.tog{position:relative;width:36px;height:19px;flex-shrink:0;}
.tog input{display:none;}
.tog-track{position:absolute;inset:0;background:var(--surface3);border:1px solid var(--border2);border-radius:10px;cursor:pointer;transition:all 0.2s;}
.tog-track::after{content:'';position:absolute;top:2px;left:2px;width:13px;height:13px;border-radius:50%;background:var(--text3);transition:all 0.2s;}
.tog input:checked+.tog-track{background:rgba(0,212,255,0.18);border-color:var(--accent);}
.tog input:checked+.tog-track::after{transform:translateX(17px);background:var(--accent);box-shadow:0 0 5px var(--accent);}
.rr{display:flex;align-items:center;gap:8px;}
input[type=range]{-webkit-appearance:none;height:3px;background:var(--surface3);border-radius:2px;border:none;padding:0;flex:1;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--accent);cursor:pointer;}
.rv{font-size:11px;color:var(--accent);width:46px;text-align:right;flex-shrink:0;}

/* TABS */
.tbar{display:flex;gap:3px;border-bottom:1px solid var(--border);margin-bottom:18px;overflow-x:auto;}
.tbtn{padding:7px 14px;border-radius:var(--r) var(--r) 0 0;cursor:pointer;font-family:var(--mono);font-size:11px;color:var(--text3);border:1px solid transparent;border-bottom:none;transition:all 0.12s;white-space:nowrap;background:transparent;}
.tbtn:hover{color:var(--text);background:var(--surface3);}
.tbtn.active{background:var(--surface);color:var(--accent);border-color:var(--border);border-bottom-color:var(--surface);margin-bottom:-1px;}
.tpanel{display:none;}.tpanel.active{display:block;}

/* LOGS */
.log-wrap{background:#040608;border:1px solid var(--border);border-radius:var(--rlg);height:460px;overflow-y:auto;padding:10px;font-size:11px;}
.log-e{display:flex;gap:8px;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.015);animation:lf 0.2s ease;}
@keyframes lf{from{opacity:0;transform:translateX(-3px)}to{opacity:1;transform:translateX(0)}}
.lt{color:var(--text3);white-space:nowrap;flex-shrink:0;width:60px;}
.ll{font-weight:600;width:52px;flex-shrink:0;font-size:10px;text-transform:uppercase;}
.ll.INFO{color:var(--accent)}.ll.WARNING,.ll.WARN{color:var(--warn)}.ll.ERROR{color:var(--danger)}.ll.DEBUG{color:var(--text3)}.ll.SUCCESS{color:var(--green)}
.ls{color:var(--purple);width:80px;flex-shrink:0;font-size:10px;overflow:hidden;text-overflow:ellipsis;}
.lm{color:var(--text2);flex:1;word-break:break-all;}
.log-tb{display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.chip{padding:3px 9px;border-radius:10px;border:1px solid var(--border);font-size:10px;cursor:pointer;color:var(--text3);transition:all 0.12s;user-select:none;}
.chip.on-INFO{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.chip.on-WARN,.chip.on-WARNING{border-color:var(--warn);color:var(--warn);background:var(--warn-dim)}
.chip.on-ERROR{border-color:var(--danger);color:var(--danger);background:var(--danger-dim)}
.chip.on-DEBUG{border-color:var(--border2);color:var(--text2);background:var(--surface3)}
.chip.on-SUCCESS{border-color:var(--green);color:var(--green);background:var(--green-dim)}

/* CODE */
.cb{position:relative;background:#040608;border:1px solid var(--border);border-radius:var(--r);padding:14px;font-size:12px;line-height:1.7;overflow-x:auto;}
.cc{position:absolute;top:7px;right:7px;background:var(--surface3);border:1px solid var(--border);color:var(--text3);padding:2px 9px;border-radius:5px;font-size:10px;cursor:pointer;}
.cc:hover{color:var(--accent);border-color:var(--accent);}

/* ALERT */
.alert{display:flex;gap:10px;padding:10px 14px;border-radius:var(--r);font-size:12px;margin-bottom:10px;line-height:1.5;}
.alert-blue{background:var(--accent-dim);border:1px solid rgba(0,212,255,0.18);color:var(--text2);}
.alert-yellow{background:var(--warn-dim);border:1px solid rgba(245,158,11,0.18);color:var(--text2);}
.alert-green{background:var(--green-dim);border:1px solid rgba(16,185,129,0.18);color:var(--text2);}
.alert-danger{background:var(--danger-dim);border:1px solid rgba(239,68,68,0.18);color:var(--text2);}

/* BADGE */
.badge{display:inline-flex;align-items:center;font-size:9px;letter-spacing:0.8px;text-transform:uppercase;padding:2px 6px;border-radius:4px;font-weight:600;}
.bg{background:var(--green-dim);color:var(--green);border:1px solid rgba(16,185,129,0.2);}
.ba{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,212,255,0.2);}
.bw{background:var(--warn-dim);color:var(--warn);border:1px solid rgba(245,158,11,0.2);}
.br{background:var(--danger-dim);color:var(--danger);border:1px solid rgba(239,68,68,0.2);}
.bp{background:var(--purple-dim);color:#a78bfa;border:1px solid rgba(124,58,237,0.2);}

/* PROGRESS */
.prog-track{height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;}
.prog-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--purple));transition:width 0.4s ease;position:relative;overflow:hidden;}
.prog-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.18),transparent);animation:sh 1.4s infinite;}
@keyframes sh{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}

/* OUTPUT */
.out-box{background:#040608;border:1px solid var(--border);border-radius:var(--r);padding:14px;min-height:120px;font-size:12px;line-height:1.7;color:var(--text2);}
.cursor{display:inline-block;width:2px;height:13px;background:var(--accent);animation:bl 0.8s infinite;vertical-align:text-bottom;}
@keyframes bl{0%,100%{opacity:1}50%{opacity:0}}

/* HEALTH RING */
.hring{position:relative;width:90px;height:90px;margin:0 auto;}
.hring svg{transform:rotate(-90deg);}
.hrval{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:var(--display);font-size:18px;font-weight:700;}
.hrlbl{font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}

/* SUBSYS */
.ss-list{display:flex;flex-direction:column;gap:5px;}
.ss-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--surface3);border-radius:7px;font-size:11px;}
.ss-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.ss-name{flex:1;color:var(--text2);}
.ss-val{color:var(--accent);font-weight:600;}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;}
.tbl th,.tbl td{padding:7px 11px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px;text-align:left;}
.tbl th{color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1px;background:var(--surface3);}
.tbl tr:hover td{background:rgba(255,255,255,0.015);}

/* CODEBOOK */
.cbk{display:grid;grid-template-columns:repeat(32,1fr);gap:2px;margin-top:8px;}
.cbk-c{aspect-ratio:1;border-radius:2px;}

/* CHART */
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:14px;}
.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.chart-title{font-size:12px;color:var(--text2);font-weight:600;}
canvas{display:block;width:100%;}

/* ARCH FLOW */
.arch-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);padding:20px;overflow-x:auto;margin-bottom:18px;}
.flow{display:flex;align-items:center;gap:0;min-width:900px;}
.fn{background:var(--bg2);border:1px solid var(--border2);border-radius:7px;padding:8px 12px;font-size:11px;text-align:center;white-space:nowrap;transition:all 0.18s;cursor:default;}
.fn:hover{transform:scale(1.05);z-index:2;box-shadow:0 0 12px rgba(0,212,255,0.15);}
.fn .fn-n{font-weight:600;}
.fn .fn-s{font-size:9px;color:var(--text3);margin-top:2px;}
.fn.hot{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.05);}
.fn.warm{border-color:var(--purple);color:#a78bfa;background:rgba(124,58,237,0.05);}
.fn.cool{border-color:var(--green);color:var(--green);background:rgba(16,185,129,0.05);}
.fa{color:var(--text3);font-size:15px;padding:0 5px;flex-shrink:0;}
.fb{display:flex;flex-direction:column;gap:5px;}
.fb .fn{font-size:10px;padding:5px 8px;}

/* BENCHMARK BARS */
.bench-bar{display:flex;align-items:center;gap:8px;margin:4px 0;}
.bench-label{font-size:10px;color:var(--text3);width:80px;flex-shrink:0;}
.bench-track{flex:1;height:8px;background:var(--surface3);border-radius:4px;overflow:hidden;}
.bench-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--purple));transition:width 0.6s ease;}
.bench-val{font-size:11px;color:var(--accent);width:60px;text-align:right;flex-shrink:0;}

/* TEST RESULT */
.test-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface3);border-radius:8px;margin-bottom:6px;}
.test-icon{font-size:16px;flex-shrink:0;}
.test-name{flex:1;font-size:12px;color:var(--text);}
.test-score{font-family:var(--display);font-size:16px;font-weight:700;width:60px;text-align:right;}
.test-bar-wrap{width:120px;}
.test-detail{font-size:10px;color:var(--text3);margin-top:2px;}

/* MODULE INSPECTOR */
.mod-row{padding:10px 12px;background:var(--surface3);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background 0.12s;}
.mod-row:hover{background:var(--surface2);}
.mod-header{display:flex;align-items:center;gap:10px;}
.mod-name{font-size:12px;color:var(--accent);font-weight:600;flex:1;}
.mod-type{font-size:10px;color:var(--purple);}
.mod-params{font-family:var(--display);font-size:14px;color:var(--text2);}
.mod-sub{display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.mod-stat{display:inline-flex;gap:4px;align-items:center;font-size:10px;color:var(--text3);margin-right:12px;}
.mod-stat span{color:var(--text2);}

/* SPARKLINE */
.sparkline{display:inline-block;vertical-align:middle;}

/* JSON EDITOR */
.json-editor{background:#040608;border:1px solid var(--border);border-radius:var(--r);padding:14px;font-family:var(--mono);font-size:12px;color:var(--text2);width:100%;min-height:300px;resize:vertical;}

/* VQ HEATMAP */
.vq-grid{display:grid;gap:1px;margin-top:8px;}
.vq-cell{aspect-ratio:1;border-radius:1px;transition:transform 0.1s;}
.vq-cell:hover{transform:scale(2);z-index:5;outline:1px solid var(--accent);}

/* VQ ACADEMIC DIAGNOSTICS */
.vq-diag-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:14px;}
@media(max-width:1200px){.vq-diag-grid{grid-template-columns:repeat(3,1fr);}}
.vq-metric{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;text-align:center;}
.vq-metric .vm-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.6px;}
.vq-metric .vm-val{font-family:var(--display);font-size:18px;font-weight:700;margin:4px 0 2px;}
.vq-metric .vm-sub{font-size:9px;color:var(--text3);}
.vq-risk-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;}
.vq-risk-badge.critical{background:var(--danger-dim);color:var(--danger);border:1px solid rgba(239,68,68,0.3);}
.vq-risk-badge.high{background:var(--warn-dim);color:var(--warn);border:1px solid rgba(245,158,11,0.3);}
.vq-risk-badge.moderate{background:var(--warn-dim);color:var(--warn);border:1px solid rgba(245,158,11,0.2);}
.vq-risk-badge.low{background:var(--green-dim);color:var(--green);border:1px solid rgba(16,185,129,0.2);}
.vq-risk-badge.minimal{background:var(--green-dim);color:var(--green);border:1px solid rgba(16,185,129,0.3);}
.vq-risk-badge.unknown{background:var(--surface3);color:var(--text3);border:1px solid var(--border);}
.vq-code-tbl{max-height:300px;overflow-y:auto;}
.vq-code-tbl .tbl td.dead{color:var(--danger);}
.vq-code-tbl .tbl td.rare{color:var(--warn);}
.vq-code-tbl .tbl td.low{color:var(--text3);}
.vq-code-tbl .tbl td.active{color:var(--green);}
.vq-hp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.vq-hp-item{display:flex;justify-content:space-between;font-size:11px;padding:4px 8px;background:var(--surface3);border-radius:6px;}
.vq-hp-item .hp-k{color:var(--text3);}.vq-hp-item .hp-v{color:var(--accent);font-weight:600;}
.vq-topk-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;}
.vq-topk-row .tk-bar{flex:1;height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;}
.vq-topk-row .tk-fill{height:100%;border-radius:2px;}

/* ARCHITECTURE ENHANCED */
.arch-node{position:relative;}
.arch-node .arch-pulse{position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;}
.arch-pulse.ok{background:var(--green);box-shadow:0 0 4px var(--green);animation:pulse 2s infinite;}
.arch-pulse.warn{background:var(--warn);box-shadow:0 0 4px var(--warn);animation:pulse 1.2s infinite;}
.arch-pulse.err{background:var(--danger);box-shadow:0 0 4px var(--danger);animation:pulse 0.8s infinite;}
.arch-pulse.off{background:var(--text3);box-shadow:none;animation:none;opacity:0.4;}
.arch-module-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:12px;}
.arch-mod-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;cursor:pointer;transition:all 0.15s;}
.arch-mod-card:hover{border-color:var(--accent);box-shadow:0 0 8px var(--accent-dim);}
.arch-mod-card .amc-head{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.arch-mod-card .amc-name{font-size:12px;color:var(--accent);font-weight:600;flex:1;}
.arch-mod-card .amc-type{font-size:10px;color:var(--purple);}
.arch-mod-card .amc-stats{display:flex;flex-wrap:wrap;gap:10px;font-size:10px;color:var(--text3);}
.arch-mod-card .amc-stats span{color:var(--text2);}
.arch-mod-detail{display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--text3);}
.arch-mod-detail.open{display:block;}
.arch-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;}
@media(max-width:1000px){.arch-summary-grid{grid-template-columns:repeat(2,1fr);}}

hr{border:none;border-top:1px solid var(--border);margin:16px 0;}

  /* ‚îÄ‚îÄ‚îÄ Test Suite v3.3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .ts-tab { background:none; border:none; border-bottom:2px solid transparent;
    padding:7px 14px; font-size:12px; color:var(--text3); cursor:pointer; transition:.15s; }
  .ts-tab:hover { color:var(--text); }
  .ts-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .ts-section-hdr { display:flex; align-items:center; gap:8px;
    padding:8px 10px; cursor:pointer; border-radius:6px; transition:.1s;
    border:1px solid transparent; margin-bottom:3px; }
  .ts-section-hdr:hover { background:var(--surface2); border-color:var(--bord); }
  .ts-section-hdr.ts-has-failures { border-color:var(--danger)!important; background:rgba(239,68,68,.06)!important; }
  .ts-section-body { display:none; padding:4px 0 8px 22px; }
  .ts-section-body.open { display:block; }
  .ts-test-row { display:flex; align-items:center; gap:8px;
    padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;
    transition:.1s; margin-bottom:2px; }
  .ts-test-row:hover { background:var(--surface2); }
  .ts-test-row .ts-status { width:14px; text-align:center; font-size:12px; }
  .ts-test-row .ts-name { flex:1; color:var(--text); font-family:var(--mono); }
  .ts-test-row .ts-ms { color:var(--text3); font-size:10px; min-width:50px; text-align:right; }
  .ts-result-card { background:var(--surface2); border:1px solid var(--bord);
    border-radius:6px; padding:10px 12px; margin-bottom:6px; cursor:pointer; transition:.1s; }
  .ts-result-card:hover { border-color:var(--accent); }
  .ts-result-card.passed { border-left:3px solid var(--green); }
  .ts-result-card.failed { border-left:3px solid var(--danger); }
  .ts-result-card.error { border-left:3px solid var(--warn); }
  .ts-result-card.skipped { border-left:3px solid var(--text3); }
  .ts-result-card .ts-rc-hdr { display:flex; align-items:center; gap:8px; }
  .ts-result-card .ts-rc-name { font-family:var(--mono); font-size:11px; flex:1; color:var(--text); }
  .ts-result-card .ts-rc-ms { font-size:10px; color:var(--text3); }
  .ts-result-card .ts-rc-sec { font-size:10px; color:var(--text3); }
  .ts-result-card .ts-rc-err { font-size:11px; color:var(--danger); margin-top:5px;
    font-family:var(--mono); background:rgba(239,68,68,.08); padding:4px 8px;
    border-radius:4px; overflow-x:auto; }
  .ts-result-card .ts-rc-detail { display:none; margin-top:8px; }
  .ts-result-card.expanded .ts-rc-detail { display:block; }
  .ts-log-block { background:var(--bg); border:1px solid var(--bord); border-radius:4px;
    padding:8px; font-size:10px; font-family:var(--mono); color:var(--text);
    white-space:pre; overflow-x:auto; max-height:200px; overflow-y:auto; margin-top:6px; }
  .ts-failure-card { background:var(--surface2); border:1px solid var(--danger);
    border-radius:6px; padding:10px 12px; margin-bottom:8px; }
  .ts-failure-card .ts-fc-name { font-family:var(--mono); font-size:12px; color:var(--text); margin-bottom:4px; }
  .ts-failure-card .ts-fc-sec { font-size:10px; color:var(--text3); margin-bottom:6px; }
  .ts-failure-card .ts-fc-msg { font-size:11px; color:var(--danger); font-family:var(--mono);
    background:rgba(239,68,68,.08); padding:6px 8px; border-radius:4px; }
  .ts-failure-card .ts-fc-tb { font-size:10px; color:var(--text3); font-family:var(--mono);
    margin-top:6px; white-space:pre; overflow-x:auto; max-height:160px; overflow-y:auto; }
  .ts-run-btn-sec { background:var(--surface2); border:1px solid var(--bord);
    border-radius:4px; padding:2px 8px; font-size:10px; color:var(--text3);
    cursor:pointer; transition:.1s; margin-left:auto; }
  .ts-run-btn-sec:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
</style>
</head>
<body>
<div class="shell">

<!-- TOPBAR -->
<header class="topbar">
  <div class="logo">AEON</div>
  <div class="ver">Delta RMT v3.2.0</div>
  <div class="spacer"></div>
  <button class="tb-btn" onclick="exportSession()" title="Export session to JSON">‚Üì Session</button>
  <div class="conn-badge disconnected" id="conn-badge" onclick="connectWS()" title="Click to reconnect">
    <div class="dot pulse" id="conn-dot"></div>
    <span id="conn-text">Connecting...</span>
  </div>
  <div class="dev-badge">‚ö° <span id="dev-str">‚Äî</span></div>
  <div id="clock"></div>
</header>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="nav-group">
    <div class="nav-label">Overview</div>
    <div class="nav-item active" onclick="go('dashboard')"><span class="nav-icon">‚óà</span> Dashboard</div>
    <div class="nav-item" onclick="go('architecture')"><span class="nav-icon">‚¨°</span> Architecture</div>
    <div class="nav-item" onclick="go('modules')"><span class="nav-icon">‚óß</span> Module Inspector</div>
  </div>
  <div class="nav-group">
    <div class="nav-label">Engine</div>
    <div class="nav-item" onclick="go('config')"><span class="nav-icon">‚öô</span> Configuration</div>
    <div class="nav-item" onclick="go('inference')"><span class="nav-icon">‚ñ∂</span> Inference</div>
    <div class="nav-item" onclick="go('training')"><span class="nav-icon">‚óâ</span> Training</div>
  </div>
  <div class="nav-group">
    <div class="nav-label">Diagnostics</div>
    <div class="nav-item" onclick="go('testsuite')"><span class="nav-icon">üß™</span> Test Suite<span style="font-size:9px;color:var(--text3);margin-left:4px">642</span></div>
    <div class="nav-item" onclick="go('benchmark')"><span class="nav-icon">‚ö°</span> Benchmark</div>
    <div class="nav-item" onclick="go('vq')"><span class="nav-icon">‚óà</span> VQ Codebook</div>
  </div>
  <div class="nav-group">
    <div class="nav-label">Monitoring</div>
    <div class="nav-item" onclick="go('logs')"><span class="nav-icon">‚â°</span> Live Logs <span class="nav-badge" id="log-badge">0</span></div>
    <div class="nav-item" onclick="go('audit')"><span class="nav-icon">‚óê</span> Audit Trail</div>
    <div class="nav-item" onclick="go('monitor')"><span class="nav-icon">‚óå</span> System Monitor</div>
    <div class="nav-item" onclick="go('tg')"><span class="nav-icon">üõ°</span> TensorGuard</div>
    <div class="nav-item" onclick="go('observability')"><span class="nav-icon">‚óé</span> Observability</div>
  </div>
  <div class="nav-group">
    <div class="nav-label">Tools</div>
    <div class="nav-item" onclick="go('codegen')"><span class="nav-icon">&lt;/&gt;</span> Code Generator</div>
  </div>
</nav>

<!-- MAIN -->
<main class="main">

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
<div class="panel active" id="panel-dashboard">
  <div class="ph">
    <div><div class="ph-title">Control Dashboard</div><div class="ph-sub">AEON-Delta RMT v3.2.0 ¬∑ Live connection to aeon_server.py</div></div>
    <div class="btns">
      <button class="btn btn-ghost" onclick="refreshAll()">‚Üª Refresh All</button>
      <button class="btn btn-secondary" onclick="go('inference')">‚ñ∂ Inference</button>
      <button class="btn btn-primary" id="dash-init-btn" onclick="go('config')">‚ö° Init Model</button>
    </div>
  </div>
  <div class="alert alert-blue" id="no-backend-alert">
    <span>‚ö†</span>
    <div>Backend –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: <code>python aeon_server.py</code> ‚Äî –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>
  </div>
  <div class="g5" style="margin-bottom:16px">
    <div class="card ca"><div class="ct">Parameters</div><div class="cv ca" id="d-params">‚Äî</div><div class="cm-t" id="d-params-m">not initialized</div><div class="mbar"><div class="mfill" id="d-params-bar" style="width:0%"></div></div></div>
    <div class="card cg"><div class="ct">Health Score</div><div class="cv cg" id="d-health">‚Äî</div><div class="cm-t" id="d-health-m">‚Äî</div><div class="mbar"><div class="mfill g" id="d-health-bar" style="width:0%"></div></div></div>
    <div class="card cp"><div class="ct">Active Flags</div><div class="cv cp" id="d-flags">0</div><div class="cm-t">AGI subsystems</div><div class="mbar"><div class="mfill" style="background:var(--purple);width:0%" id="d-flags-bar"></div></div></div>
    <div class="card cw"><div class="ct">VQ Utilization</div><div class="cv cw" id="d-vq">‚Äî</div><div class="cm-t" id="d-vq-m">codebook usage</div><div class="mbar"><div class="mfill w" id="d-vq-bar" style="width:0%"></div></div></div>
    <div class="card cd"><div class="ct">TG Events</div><div class="cv" style="color:var(--danger)" id="d-tg-total">0</div><div class="cm-t">NaN + Inf total</div><div class="mbar"><div class="mfill d" id="d-tg-bar" style="width:0%"></div></div></div>
  </div>
  <div class="g2" style="margin-bottom:16px">
    <div class="card">
      <div class="ct">üè• System Integrity</div>
      <div style="display:flex;align-items:center;gap:20px;margin-top:8px">
        <div class="hring">
          <svg viewBox="0 0 90 90" width="90" height="90">
            <circle cx="45" cy="45" r="35" fill="none" stroke="var(--surface3)" stroke-width="7"/>
            <circle cx="45" cy="45" r="35" fill="none" stroke="var(--green)" stroke-width="7"
              stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round"
              id="d-ring" style="transition:stroke-dashoffset 1s ease"/>
          </svg>
          <div class="hrval"><span id="d-ring-v" style="color:var(--green)">‚Äî</span><span class="hrlbl">health</span></div>
        </div>
        <div class="ss-list" style="flex:1" id="d-subsys"><div style="font-size:11px;color:var(--text3)">Initialize model first</div></div>
      </div>
    </div>
    <div class="card">
      <div class="ct">‚óê Recent Decisions</div>
      <div id="d-decisions" style="margin-top:8px;display:flex;flex-direction:column;gap:3px;max-height:160px;overflow-y:auto">
        <div style="font-size:11px;color:var(--text3)">No decisions yet</div>
      </div>
    </div>
  </div>
  <div class="g2" style="margin-bottom:16px">
    <div class="card">
      <div class="ct">‚óà VQ-VAE Codebook</div>
      <div class="cbk" id="d-cbk"></div>
      <div class="cm-t" id="d-cbk-m" style="margin-top:6px">‚Äî</div>
    </div>
    <div class="card">
      <div class="ct">‚öô TensorGuard Live</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px">
        <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">NaN events</div><div style="font-family:var(--display);font-size:22px;color:var(--warn)" id="tg-nan-live">0</div></div>
        <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Inf events</div><div style="font-family:var(--display);font-size:22px;color:var(--danger)" id="tg-inf-live">0</div></div>
        <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Sanitized</div><div style="font-family:var(--display);font-size:22px;color:var(--accent)" id="tg-san-live">0</div></div>
      </div>
    </div>
  </div>
  <div class="stitle">Quick Initialize</div>
  <div class="card">
    <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap">
      <div class="fg" style="margin:0;flex:1;min-width:160px">
        <div class="fl">Preset</div>
        <select id="q-preset" onchange="applyPreset(this.value)">
          <option value="minimal">Minimal (debug)</option>
          <option value="production" selected>Production</option>
          <option value="full">Full Research</option>
          <option value="agi">AGI (all subsystems)</option>
        </select>
      </div>
      <div class="fg" style="margin:0;flex:1;min-width:120px">
        <div class="fl">hidden_dim</div>
        <select id="q-hidden">
          <option value="128">128 (debug)</option>
          <option value="256" selected>256</option>
          <option value="512">512 (prod)</option>
          <option value="1024">1024 (heavy)</option>
        </select>
      </div>
      <div class="fg" style="margin:0;flex:1;min-width:120px">
        <div class="fl">device</div>
        <select id="q-device">
          <option value="auto">auto</option>
          <option value="cpu">cpu</option>
          <option value="cuda">cuda</option>
          <option value="mps">mps (Apple)</option>
        </select>
      </div>
      <div class="fg" style="margin:0;min-width:60px">
        <div class="fl">seed</div>
        <input type="number" id="q-seed" value="42" style="width:80px">
      </div>
      <button class="btn btn-primary" id="init-btn" onclick="initModel()">‚ö° Initialize</button>
      <button class="btn btn-danger" id="deinit-btn" onclick="deinitModel()" style="display:none">‚úï Deinit</button>
    </div>
    <div id="init-prog" style="margin-top:12px;display:none">
      <div style="font-size:11px;color:var(--text3);margin-bottom:5px" id="init-step-lbl">Initializing...</div>
      <div class="prog-track"><div class="prog-fill" id="init-prog-fill" style="width:0%"></div></div>
    </div>
    <div id="init-error" class="alert alert-danger" style="margin-top:10px;display:none"></div>
  </div>
</div>

<!-- ‚ïê‚ïê ARCHITECTURE ‚ïê‚ïê -->
<div class="panel" id="panel-architecture">
  <div class="ph">
    <div><div class="ph-title">Architecture ‚Äî Real-Time Diagnostics</div><div class="ph-sub">Interactive pipeline visualization ¬∑ per-module health ¬∑ gradient flow ¬∑ memory profiling</div></div>
    <div class="btns">
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);cursor:pointer">
        <input type="checkbox" id="arch-auto-refresh" onchange="toggleArchAutoRefresh()" style="accent-color:var(--accent)"> Auto-refresh
      </label>
      <button class="btn btn-secondary" onclick="loadArch()">‚Üª Refresh</button>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="arch-summary-grid">
    <div class="card"><div class="ct">Total Parameters</div><div class="cv ca" id="arch-total-params">‚Äî</div></div>
    <div class="card"><div class="ct">Trainable</div><div class="cv cg" id="arch-train-params">‚Äî</div></div>
    <div class="card"><div class="ct">Frozen</div><div class="cv" style="color:var(--text3)" id="arch-frozen-params">‚Äî</div></div>
    <div class="card"><div class="ct">Memory</div><div class="cv cp" id="arch-total-mem">‚Äî</div><div class="cm-t">model weights</div></div>
  </div>

  <!-- Interactive Data Flow Pipeline -->
  <div class="arch-wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">Interactive Data Flow Pipeline</div>
      <div style="display:flex;gap:12px;font-size:9px;color:var(--text3)">
        <span><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:3px"></span>Healthy</span>
        <span><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--warn);margin-right:3px"></span>Warning</span>
        <span><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--danger);margin-right:3px"></span>Error</span>
      </div>
    </div>
    <div class="flow" id="arch-flow">
      <div class="fn hot arch-node" id="arch-n-input"><div class="arch-pulse off"></div><div class="fn-n">Input IDs</div><div class="fn-s">[B, L]</div></div>
      <div class="fa">‚Üí</div>
      <div class="fn arch-node" id="arch-n-encoder" onclick="archShowDetail('encoder')"><div class="arch-pulse off"></div><div class="fn-n">Encoder</div><div class="fn-s" id="a-enc">SSM</div><div class="fn-s" style="color:var(--accent);font-size:8px" id="a-enc-p"></div></div>
      <div class="fa">‚Üí</div>
      <div class="fn warm arch-node" id="arch-n-vq" onclick="archShowDetail('vector_quantizer')"><div class="arch-pulse off"></div><div class="fn-n">VQ-VAE</div><div class="fn-s" id="a-vq">8192 codes</div><div class="fn-s" style="color:var(--purple);font-size:8px" id="a-vq-p"></div></div>
      <div class="fa">‚Üí</div>
      <div class="fn arch-node" id="arch-n-meta" onclick="archShowDetail('meta_loop')"><div class="arch-pulse off"></div><div class="fn-n">Meta-Loop</div><div class="fn-s" id="a-ml">Banach FP ¬∑ N iter</div><div class="fn-s" style="color:var(--accent);font-size:8px" id="a-ml-p"></div></div>
      <div class="fa">‚Üí</div>
      <div class="fb">
        <div class="fn arch-node" id="arch-n-memory" onclick="archShowDetail('memory_manager')"><div class="arch-pulse off" style="top:2px;right:2px;width:4px;height:4px"></div><span id="a-mem">Memory Systems</span></div>
        <div class="fn arch-node" id="arch-n-causal" onclick="archShowDetail('causal_model')"><div class="arch-pulse off" style="top:2px;right:2px;width:4px;height:4px"></div><span id="a-caus">Causal Models</span></div>
        <div class="fn arch-node" id="arch-n-safety" onclick="archShowDetail('safety_system')"><div class="arch-pulse off" style="top:2px;right:2px;width:4px;height:4px"></div><span>Safety + Topology</span></div>
        <div class="fn arch-node" id="arch-n-plan" onclick="archShowDetail('planning')"><div class="arch-pulse off" style="top:2px;right:2px;width:4px;height:4px"></div><span id="a-plan">Planning</span></div>
      </div>
      <div class="fa">‚Üí</div>
      <div class="fn cool arch-node" id="arch-n-cstar"><div class="arch-pulse off"></div><div class="fn-n">C_star</div><div class="fn-s">Core State</div></div>
      <div class="fa">‚Üí</div>
      <div class="fn arch-node" id="arch-n-decoder" onclick="archShowDetail('decoder')"><div class="arch-pulse off"></div><div class="fn-n">Decoder</div><div class="fn-s" id="a-dec">SSM</div><div class="fn-s" style="color:var(--accent);font-size:8px" id="a-dec-p"></div></div>
      <div class="fa">‚Üí</div>
      <div class="fn hot arch-node" id="arch-n-output"><div class="arch-pulse off"></div><div class="fn-n">Logits</div><div class="fn-s" id="a-out">[B,L,V]</div></div>
    </div>
  </div>

  <!-- Module Detail Popup -->
  <div class="card" id="arch-detail-card" style="display:none;margin-bottom:14px;border-left:3px solid var(--accent)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="ct" id="arch-detail-title">Module Detail</div>
      <button class="btn btn-ghost" onclick="document.getElementById('arch-detail-card').style.display='none'" style="padding:2px 8px;font-size:10px">‚úï Close</button>
    </div>
    <div id="arch-detail-content" style="font-size:11px">‚Äî</div>
  </div>

  <!-- Module breakdown & summary -->
  <div class="g2" style="margin-bottom:16px">
    <div class="card">
      <div class="ct">Module Breakdown ‚Äî Per-Component Diagnostics</div>
      <div style="overflow-x:auto;margin-top:8px"><table class="tbl" id="arch-mod-tbl">
        <thead><tr><th>Module</th><th>Type</th><th>Params</th><th>Memory</th><th>Grad ‚Äñ¬∑‚Äñ</th><th>Device</th><th>Health</th><th>Share %</th></tr></thead>
        <tbody><tr><td colspan="8" style="color:var(--text3)">Initialize model to see modules</td></tr></tbody>
      </table></div>
    </div>
    <div class="card">
      <div class="ct">Architecture Summary (raw)</div>
      <div class="cb" style="margin-top:8px;max-height:280px;overflow-y:auto;font-size:10px;padding:10px"><pre id="arch-summary" style="margin:0;color:var(--text2)">Initialize model first</pre></div>
    </div>
  </div>

  <!-- Pipeline Stage Health Overview -->
  <div class="card">
    <div class="ct">Pipeline Stage Health Overview</div>
    <div id="arch-stage-health" style="margin-top:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:11px">
      <div style="color:var(--text3);text-align:center;padding:20px;grid-column:1/-1">Initialize model for stage health</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODULE INSPECTOR ‚ïê‚ïê -->
<div class="panel" id="panel-modules">
  <div class="ph">
    <div><div class="ph-title">Module Inspector</div><div class="ph-sub">Per-layer parameters, weight statistics, gradient analysis</div></div>
    <div class="btns">
      <button class="btn btn-secondary" onclick="loadModules()">‚Üª Refresh</button>
    </div>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card ca"><div class="ct">Total Params</div><div class="cv ca" id="mi-total">‚Äî</div></div>
    <div class="card cg"><div class="ct">Trainable</div><div class="cv cg" id="mi-train">‚Äî</div></div>
    <div class="card cp"><div class="ct">Frozen</div><div class="cv cp" id="mi-frozen">‚Äî</div></div>
    <div class="card cw"><div class="ct">Modules</div><div class="cv cw" id="mi-count">‚Äî</div></div>
  </div>
  <div class="chart-wrap" style="margin-bottom:14px">
    <div class="chart-head"><div class="chart-title">Parameter Distribution by Module</div></div>
    <canvas id="mod-chart" height="120"></canvas>
  </div>
  <div id="mod-list"><div style="color:var(--text3);font-size:12px">Initialize model to inspect modules</div></div>
</div>

<!-- ‚ïê‚ïê CONFIG ‚ïê‚ïê -->
<div class="panel" id="panel-config">
  <div class="ph">
    <div><div class="ph-title">Configuration</div><div class="ph-sub">AEONConfig parameters ¬∑ applied on next init</div></div>
    <div class="btns">
      <button class="btn btn-ghost" onclick="validateConfig()">‚úì Validate</button>
      <button class="btn btn-ghost" onclick="resetCfg()">‚Ü∫ Reset</button>
      <button class="btn btn-secondary" onclick="copyCfgJSON()">‚éò Copy JSON</button>
      <button class="btn btn-purple" onclick="cTab('json-ed')">{ } JSON Edit</button>
      <button class="btn btn-primary" onclick="applyAndReinit()">‚ö° Apply & Re-init</button>
    </div>
  </div>
  <div id="cfg-validate-result" style="display:none"></div>
  <div class="tbar" id="cfg-tbar">
    <button class="tbtn active" onclick="cTab('arch')">Architecture</button>
    <button class="tbtn" onclick="cTab('mem')">Memory</button>
    <button class="tbtn" onclick="cTab('causal')">Causality</button>
    <button class="tbtn" onclick="cTab('meta')">Meta-Cognition</button>
    <button class="tbtn" onclick="cTab('coh')">Coherence</button>
    <button class="tbtn" onclick="cTab('plan')">Planning</button>
    <button class="tbtn" onclick="cTab('train')">Training</button>
    <button class="tbtn" onclick="cTab('obs')">Observability</button>
    <button class="tbtn" onclick="cTab('json-ed')">JSON Editor</button>
  </div>

  <div class="tpanel active" id="ctab-arch">
    <div class="alert alert-yellow"><span>‚ö†</span><div><strong>CRITICAL:</strong> vq_embedding_dim MUST equal z_dim ‚Äî AssertionError on violation.</div></div>
    <div class="fr">
      <div class="fg"><div class="fl">encoder_backend</div><select id="c-enc"><option value="ssm" selected>ssm</option><option value="mamba2">mamba2</option><option value="linear_attention">linear_attention</option><option value="lstm">lstm</option></select></div>
      <div class="fg"><div class="fl">decoder_backend</div><select id="c-dec"><option value="ssm" selected>ssm</option><option value="mamba2">mamba2</option><option value="lstm">lstm</option></select></div>
    </div>
    <div class="fr3">
      <div class="fg"><div class="fl">hidden_dim</div><input type="number" id="c-hidden" value="256" min="64" max="2048" step="64"></div>
      <div class="fg"><div class="fl">z_dim</div><input type="number" id="c-zdim" value="256" min="64" max="2048" step="64" oninput="syncVqDim()"></div>
      <div class="fg"><div class="fl">vq_embedding_dim <span class="bw">== z_dim</span></div><input type="number" id="c-vqemb" value="256" min="64" max="2048" step="64" oninput="checkVq()"><div class="fh" id="vq-hint" style="color:var(--green)">‚úì matches z_dim</div></div>
    </div>
    <div class="fr3">
      <div class="fg"><div class="fl">vocab_size</div><select id="c-vocab"><option value="30522" selected>30522 (BERT)</option><option value="50257">50257 (GPT-2)</option><option value="32000">32000 (LLaMA)</option><option value="51200">51200</option></select></div>
      <div class="fg"><div class="fl">seq_length</div><input type="number" id="c-seqlen" value="64" min="16" max="8192" step="16"></div>
      <div class="fg"><div class="fl">vq_num_embeddings</div><select id="c-vqnum"><option value="4096">4096 (small)</option><option value="8192" selected>8192</option><option value="16384">16384 (full)</option><option value="32768">32768 (max)</option></select></div>
    </div>
    <div class="fr4">
      <div class="fg"><div class="fl">num_pillars</div><input type="number" id="c-pillars" value="64" min="8" max="256" step="8"></div>
      <div class="fg"><div class="fl">max_iterations</div><div class="rr"><input type="range" id="c-maxiter" min="5" max="100" value="50" oninput="rv('c-maxiter-v',this.value)"><span class="rv" id="c-maxiter-v">50</span></div></div>
      <div class="fg"><div class="fl">lipschitz_target (&lt;1)</div><div class="rr"><input type="range" id="c-lip" min="0.5" max="0.99" step="0.01" value="0.85" oninput="rv('c-lip-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-lip-v">0.85</span></div></div>
      <div class="fg"><div class="fl">convergence_threshold</div><select id="c-convth"><option value="1e-6">1e-6 (strict)</option><option value="1e-5" selected>1e-5</option><option value="1e-4">1e-4 (fast)</option></select></div>
    </div>
    <div class="fr">
      <div class="fg"><div class="fl">nan_policy</div><select id="c-nanpol"><option value="WARN" selected>WARN</option><option value="RAISE">RAISE</option><option value="SILENT">SILENT</option><option value="QUARANTINE">QUARANTINE</option></select><div class="fh">WARN = log + replace ¬∑ RAISE = exception ¬∑ QUARANTINE = isolate</div></div>
      <div class="fg"><div class="fl">device_str</div><select id="c-device"><option value="auto" selected>auto</option><option value="cpu">cpu</option><option value="cuda">cuda</option><option value="mps">mps</option></select></div>
    </div>
    <div>
      <div class="tog-row"><div class="tog-info"><div class="tog-name">use_vq</div><div class="tog-desc">Vector Quantization (discrete thought representations)</div></div><label class="tog"><input type="checkbox" id="c-usevq" checked><div class="tog-track"></div></label></div>
      <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_inference_cache</div><div class="tog-desc">Cache SSM states across forward passes for fast inference</div></div><label class="tog"><input type="checkbox" id="c-infcache" checked><div class="tog-track"></div></label></div>
      <div class="tog-row"><div class="tog-info"><div class="tog-name">use_amp</div><div class="tog-desc">Mixed precision FP16 ‚Äî CUDA only, ~2√ó speedup</div></div><label class="tog"><input type="checkbox" id="c-amp" checked><div class="tog-track"></div></label></div>
    </div>
  </div>

  <div class="tpanel" id="ctab-mem">
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_hierarchical_memory</div><div class="tog-desc">STM ‚Üí Episodic ‚Üí Semantic (Miller's 7¬±2 working memory)</div><div class="tog-def">default: False</div></div><label class="tog"><input type="checkbox" id="c-hier-mem" onchange="dep(this,'mem-hier-sub')"><div class="tog-track"></div></label></div>
    <div id="mem-hier-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">working_capacity</div><input type="number" id="c-wc" value="7" min="1" max="20"></div><div class="fg"><div class="fl">episodic_capacity</div><input type="number" id="c-ec" value="1000" min="100" max="100000" step="100"></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_neurogenic_memory</div><div class="tog-desc">Bio-inspired neurogenesis memory growth with retrieval</div><div class="tog-def">default: False</div></div><label class="tog"><input type="checkbox" id="c-neuro-mem" onchange="dep(this,'mem-neuro-sub')"><div class="tog-track"></div></label></div>
    <div id="mem-neuro-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">retrieval_weight</div><div class="rr"><input type="range" id="c-nrw" min="0" max="1" step="0.01" value="0.1" oninput="rv('c-nrw-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-nrw-v">0.10</span></div></div><div class="fg"><div class="fl">retrieval_k</div><input type="number" id="c-nrk" value="3" min="1" max="20"></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_temporal_memory</div><div class="tog-desc">Ebbinghaus forgetting curve ‚Äî time-decayed episodic memory</div><div class="tog-def">default: False</div></div><label class="tog"><input type="checkbox" id="c-temp-mem" onchange="dep(this,'mem-temp-sub')"><div class="tog-track"></div></label></div>
    <div id="mem-temp-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:260px"><div class="fl">decay_rate</div><div class="rr"><input type="range" id="c-tmd" min="0.001" max="0.1" step="0.001" value="0.01" oninput="rv('c-tmd-v',parseFloat(this.value).toFixed(3))"><span class="rv" id="c-tmd-v">0.010</span></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_consolidating_memory</div><div class="tog-desc">3-level consolidation: working ‚Üí episodic ‚Üí semantic</div><div class="tog-def">default: False</div></div><label class="tog"><input type="checkbox" id="c-cons-mem" onchange="dep(this,'mem-cons-sub')"><div class="tog-track"></div></label></div>
    <div id="mem-cons-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:260px"><div class="fl">semantic_weight</div><div class="rr"><input type="range" id="c-consw" min="0.01" max="0.5" step="0.01" value="0.1" oninput="rv('c-consw-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-consw-v">0.10</span></div></div>
    </div>
  </div>

  <div class="tpanel" id="ctab-causal">
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_causal_model</div><div class="tog-desc">NeuralCausalModel ‚Äî basic neural causality layer</div></div><label class="tog"><input type="checkbox" id="c-causal"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_notears_causal</div><div class="tog-desc">NOTEARS DAG learning (Zheng 2018, SOTA structure learning)</div></div><label class="tog"><input type="checkbox" id="c-notears" onchange="dep(this,'notears-sub')"><div class="tog-track"></div></label></div>
    <div id="notears-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">num_vars</div><input type="number" id="c-ntvars" value="8" min="2" max="64"></div><div class="fg"><div class="fl">lambda_causal_dag</div><div class="rr"><input type="range" id="c-ldag" min="0.001" max="0.1" step="0.001" value="0.01" oninput="rv('c-ldag-v',parseFloat(this.value).toFixed(3))"><span class="rv" id="c-ldag-v">0.010</span></div></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_causal_world_model</div><div class="tog-desc">CausalWorldModel ‚Äî structural causal equations</div></div><label class="tog"><input type="checkbox" id="c-cawm"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_unified_simulator</div><div class="tog-desc">UnifiedCausalSimulator ‚Äî counterfactual reasoning</div></div><label class="tog"><input type="checkbox" id="c-ucausal" onchange="dep(this,'ucausal-sub')"><div class="tog-track"></div></label></div>
    <div id="ucausal-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:220px"><div class="fl">num_vars</div><input type="number" id="c-ucvars" value="16" min="4" max="128"></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_causal_context</div><div class="tog-desc">Inject causal state into context window</div></div><label class="tog"><input type="checkbox" id="c-cactx"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_causal_trace</div><div class="tog-desc">Record causal decision chains in audit log</div></div><label class="tog"><input type="checkbox" id="c-catrace"><div class="tog-track"></div></label></div>
    <div class="fg" style="max-width:300px;margin-top:8px"><div class="fl">causal_blend_weight</div><div class="rr"><input type="range" id="c-cbw" min="0" max="0.5" step="0.01" value="0.05" oninput="rv('c-cbw-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-cbw-v">0.05</span></div></div>
  </div>

  <div class="tpanel" id="ctab-meta">
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_auto_critic</div><div class="tog-desc">System-2 self-criticism (Kahneman): Critic ‚Üí Revision ‚Üí eval loop</div></div><label class="tog"><input type="checkbox" id="c-ac" onchange="dep(this,'ac-sub')"><div class="tog-track"></div></label></div>
    <div id="ac-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">threshold</div><div class="rr"><input type="range" id="c-act" min="0.5" max="1" step="0.01" value="0.85" oninput="rv('c-act-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-act-v">0.85</span></div></div><div class="fg"><div class="fl">max_iterations</div><input type="number" id="c-acmi" value="3" min="1" max="10"></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_recursive_meta_loop</div><div class="tog-desc">Recursive meta-loop with hierarchical deepening</div></div><label class="tog"><input type="checkbox" id="c-rml" onchange="dep(this,'rml-sub')"><div class="tog-track"></div></label></div>
    <div id="rml-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:220px"><div class="fl">depth</div><div class="rr"><input type="range" id="c-rmd" min="1" max="10" step="1" value="3" oninput="rv('c-rmd-v',this.value)"><span class="rv" id="c-rmd-v">3</span></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_metacognitive_recursion</div><div class="tog-desc">Auto-trigger deep thinking when uncertainty &gt; threshold</div></div><label class="tog"><input type="checkbox" id="c-mcr" onchange="dep(this,'mcr-sub')"><div class="tog-track"></div></label></div>
    <div id="mcr-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">trigger_threshold</div><div class="rr"><input type="range" id="c-mcrth" min="0.1" max="1" step="0.05" value="0.5" oninput="rv('c-mcrth-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-mcrth-v">0.50</span></div></div><div class="fg"><div class="fl">extra_iterations</div><input type="number" id="c-mcrei" value="10" min="1" max="50"></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_meta_learning</div><div class="tog-desc">MAML + EWC: fast adaptation + catastrophic forgetting prevention</div></div><label class="tog"><input type="checkbox" id="c-maml" onchange="dep(this,'maml-sub')"><div class="tog-track"></div></label></div>
    <div id="maml-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:280px"><div class="fl">ewc_lambda</div><div class="rr"><input type="range" id="c-ewc" min="10" max="10000" step="10" value="1000" oninput="rv('c-ewc-v',parseFloat(this.value).toFixed(0))"><span class="rv" id="c-ewc-v">1000</span></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_error_evolution</div><div class="tog-desc">Learn from error history to adaptively select recovery strategy</div></div><label class="tog"><input type="checkbox" id="c-ee"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_meta_recovery_integration</div><div class="tog-desc">MetaRecoveryLearner integrates error recovery into meta-loop</div></div><label class="tog"><input type="checkbox" id="c-mri"><div class="tog-track"></div></label></div>
  </div>

  <div class="tpanel" id="ctab-coh">
    <div class="tog-row" style="background:var(--accent-dim);border-radius:8px;padding:10px 14px;border:1px solid rgba(0,212,255,0.2);margin-bottom:12px">
      <div class="tog-info"><div class="tog-name" style="font-size:14px;color:var(--accent)">‚ö° enable_full_coherence</div><div class="tog-desc">MASTER FLAG ‚Äî activates all AGI coherence components at once</div><div class="tog-def" style="color:var(--danger)">10-20√ó slower ¬∑ use for research only</div></div>
      <label class="tog"><input type="checkbox" id="c-fc" onchange="onFC(this)"><div class="tog-track"></div></label>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_module_coherence</div><div class="tog-desc">Cosine similarity checks between subsystem outputs</div></div><label class="tog"><input type="checkbox" id="c-mc"><div class="tog-track"></div></label></div>
    <div class="fr3" style="margin-left:22px;margin-top:4px"><div class="fg"><div class="fl">coherence_threshold</div><div class="rr"><input type="range" id="c-mcth" min="0.1" max="1" step="0.05" value="0.5" oninput="rv('c-mcth-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-mcth-v">0.50</span></div></div></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_cross_validation</div><div class="tog-desc">factor_state vs causal_state iterative reconciliation</div></div><label class="tog"><input type="checkbox" id="c-cv"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_ns_consistency_check</div><div class="tog-desc">Neural vs symbolic soft-logic consistency verification</div></div><label class="tog"><input type="checkbox" id="c-nsc"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_hybrid_reasoning</div><div class="tog-desc">NeuroSymbolicBridge + DifferentiableForwardChainer + TemporalKG</div></div><label class="tog"><input type="checkbox" id="c-hr"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_complexity_estimator</div><div class="tog-desc">Skip expensive modules for simple inputs (adaptive compute)</div></div><label class="tog"><input type="checkbox" id="c-ce"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_external_trust</div><div class="tog-desc">External trust scoring for knowledge integration</div></div><label class="tog"><input type="checkbox" id="c-et"><div class="tog-track"></div></label></div>
    <div class="fr3" style="margin-top:10px">
      <div class="fg"><div class="fl">feedback_threshold</div><div class="rr"><input type="range" id="c-fbt" min="0" max="1" step="0.05" value="0.3" oninput="rv('c-fbt-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-fbt-v">0.30</span></div></div>
      <div class="fg"><div class="fl">feedback_scale</div><div class="rr"><input type="range" id="c-fbs" min="0" max="0.2" step="0.005" value="0.05" oninput="rv('c-fbs-v',parseFloat(this.value).toFixed(3))"><span class="rv" id="c-fbs-v">0.050</span></div></div>
    </div>
  </div>

  <div class="tpanel" id="ctab-plan">
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_world_model</div><div class="tog-desc">PhysicsGroundedWorldModel ‚Äî next-state prediction + surprise detection</div></div><label class="tog"><input type="checkbox" id="c-wm" onchange="dep(this,'wm-sub')"><div class="tog-track"></div></label></div>
    <div id="wm-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fr"><div class="fg"><div class="fl">tree_depth</div><input type="number" id="c-wmd" value="3" min="1" max="10"></div><div class="fg"><div class="fl">surprise_threshold</div><div class="rr"><input type="range" id="c-st" min="0.1" max="1" step="0.05" value="0.5" oninput="rv('c-st-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-st-v">0.50</span></div></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_mcts_planner</div><div class="tog-desc">Monte Carlo Tree Search ‚Äî strategic multi-step planning</div></div><label class="tog"><input type="checkbox" id="c-mcts"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_active_learning_planner</div><div class="tog-desc">CuriosityDrivenExploration ‚Äî intrinsic motivation planner</div></div><label class="tog"><input type="checkbox" id="c-alp" onchange="dep(this,'alp-sub')"><div class="tog-track"></div></label></div>
    <div id="alp-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:260px"><div class="fl">curiosity_weight</div><div class="rr"><input type="range" id="c-cw" min="0" max="3" step="0.1" value="1.0" oninput="rv('c-cw-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="c-cw-v">1.0</span></div></div>
    </div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_hierarchical_vae</div><div class="tog-desc">Multi-level VAE ‚Äî hierarchical latent representations</div></div><label class="tog"><input type="checkbox" id="c-hvae" onchange="dep(this,'hvae-sub')"><div class="tog-track"></div></label></div>
    <div id="hvae-sub" style="margin-left:22px;opacity:0.4;transition:opacity 0.2s">
      <div class="fg" style="max-width:260px"><div class="fl">hvae_blend_weight</div><div class="rr"><input type="range" id="c-hvbw" min="0" max="0.5" step="0.01" value="0.1" oninput="rv('c-hvbw-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="c-hvbw-v">0.10</span></div></div>
    </div>
  </div>

  <div class="tpanel" id="ctab-train">
    <div class="fr"><div class="fg"><div class="fl">learning_rate</div><select id="c-lr"><option value="1e-5">1e-5</option><option value="3e-5" selected>3e-5</option><option value="1e-4">1e-4</option><option value="3e-4">3e-4</option></select></div><div class="fg"><div class="fl">batch_size</div><select id="c-bs"><option value="4">4</option><option value="8">8</option><option value="16" selected>16</option><option value="32">32</option><option value="64">64</option></select></div></div>
    <div class="fr"><div class="fg"><div class="fl">gradient_clip_norm</div><div class="rr"><input type="range" id="c-gcn" min="0.1" max="5" step="0.1" value="1.0" oninput="rv('c-gcn-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="c-gcn-v">1.0</span></div></div><div class="fg"><div class="fl">warmup_steps</div><input type="number" id="c-ws" value="100" min="0"></div></div>
    <div class="fr"><div class="fg"><div class="fl">synthetic_samples</div><input type="number" id="c-synth" value="256" min="32" max="4096" step="32"></div><div class="fg"><div class="fl">checkpoint_dir</div><input type="text" id="c-ckpt" value="./checkpoints"></div></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">log_grad_norms</div><div class="tog-desc">Track gradient norms per step (minor overhead)</div></div><label class="tog"><input type="checkbox" id="c-loggn" checked><div class="tog-track"></div></label></div>
  </div>

  <div class="tpanel" id="ctab-obs">
    <div class="alert alert-blue"><span>‚óé</span><div><strong>Observability & Telemetry</strong> ‚Äî Enable structured logging, academic mode, and telemetry collection for full-stack traceability.</div></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_structured_logging</div><div class="tog-desc">JSON-formatted logs with ISO 8601 timestamps, correlation IDs, and module identifiers</div></div><label class="tog"><input type="checkbox" id="c-obs-sl"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_academic_mode</div><div class="tog-desc">Exhaustive DEBUG-level logging for research-grade reproducibility (slower)</div><div class="tog-def" style="color:var(--warn)">Performance impact ‚Äî use for analysis only</div></div><label class="tog"><input type="checkbox" id="c-obs-am"><div class="tog-track"></div></label></div>
    <div class="tog-row"><div class="tog-info"><div class="tog-name">enable_telemetry</div><div class="tog-desc">Collect KPIs: inference latency, memory footprint, decision confidence scores</div></div><label class="tog"><input type="checkbox" id="c-obs-tel" checked><div class="tog-track"></div></label></div>
  </div>

  <div class="tpanel" id="ctab-json-ed">
    <div class="alert alert-blue"><span>‚Ñπ</span><div>Paste or edit JSON config directly. Click <strong>Apply JSON</strong> to load into form fields, then Re-init.</div></div>
    <textarea class="json-editor" id="json-editor-ta" placeholder='{"hidden_dim": 256, "z_dim": 256, ...}'></textarea>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-secondary" onclick="loadFromJsonEditor()">‚Üê Apply JSON to Form</button>
      <button class="btn btn-ghost" onclick="syncJsonEditor()">‚ü≥ Sync from Form</button>
      <button class="btn btn-ghost" onclick="formatJson()">‚äû Format</button>
      <button class="btn btn-primary" onclick="applyJsonAndReinit()">‚ö° Apply & Re-init</button>
    </div>
    <div id="json-editor-err" style="margin-top:8px;font-size:11px;color:var(--danger)"></div>
  </div>
</div>

<!-- ‚ïê‚ïê INFERENCE ‚ïê‚ïê -->
<div class="panel" id="panel-inference">
  <div class="ph">
    <div><div class="ph-title">Inference</div><div class="ph-sub">model.generate() ¬∑ model.forward() ¬∑ Real-time generation</div></div>
    <div id="inf-status" class="badge br">model not initialized</div>
  </div>
  <div class="g2">
    <div>
      <div class="card" style="margin-bottom:14px">
        <div class="ct">‚ñ∂ Generation</div>
        <div class="fg" style="margin-top:8px"><div class="fl">Prompt</div><textarea id="i-prompt" rows="3">What is consciousness?</textarea></div>
        <div class="fr">
          <div class="fg"><div class="fl">max_length</div><div class="rr"><input type="range" id="i-maxlen" min="16" max="256" value="64" oninput="rv('i-ml-v',this.value)"><span class="rv" id="i-ml-v">64</span></div></div>
          <div class="fg"><div class="fl">temperature</div><div class="rr"><input type="range" id="i-temp" min="0.1" max="2.0" step="0.05" value="0.8" oninput="rv('i-t-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="i-t-v">0.80</span></div></div>
        </div>
        <div class="fr">
          <div class="fg"><div class="fl">top_k</div><div class="rr"><input type="range" id="i-topk" min="1" max="200" value="50" oninput="rv('i-tk-v',this.value)"><span class="rv" id="i-tk-v">50</span></div></div>
          <div class="fg"><div class="fl">top_p</div><div class="rr"><input type="range" id="i-topp" min="0.5" max="1" step="0.01" value="0.95" oninput="rv('i-tp-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="i-tp-v">0.95</span></div></div>
        </div>
        <div class="tog-row" style="border:none"><div class="tog-info"><div class="tog-name">fast mode</div><div class="tog-desc">Disables memory/planning/expensive subsystems for speed</div></div><label class="tog"><input type="checkbox" id="i-fast"><div class="tog-track"></div></label></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-primary" id="i-run-btn" onclick="runInfer()" style="flex:1">‚ñ∂ Generate</button>
          <button class="btn btn-ghost" onclick="clearInfer()">‚úï Clear</button>
        </div>
      </div>
      <div class="card">
        <div class="ct">‚óà Raw Forward Pass</div>
        <div class="fg" style="margin-top:8px"><div class="fl">input_ids (comma-separated)</div><input type="text" id="i-fwd-ids" value="101, 2054, 2003, 4272, 1029, 102"></div>
        <div class="tog-row" style="border:none;padding:4px 0"><div class="tog-info"><div class="tog-name">fast</div></div><label class="tog"><input type="checkbox" id="i-fwd-fast"><div class="tog-track"></div></label></div>
        <button class="btn btn-secondary" onclick="runFwd()" style="margin-top:6px">Run forward()</button>
        <div id="fwd-out" style="margin-top:10px;display:none">
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px" id="fwd-keys"></div>
          <div style="font-size:11px;color:var(--text3)">safety_score:</div>
          <div style="font-family:var(--display);font-size:20px;font-weight:700" id="fwd-safety"></div>
          <div style="font-size:11px;color:var(--text3);margin-top:6px">top-5 logits (pos 0):</div>
          <div id="fwd-top5" style="font-size:11px;color:var(--text2);margin-top:3px"></div>
          <div style="font-size:11px;color:var(--text3);margin-top:6px">convergence_delta:</div>
          <div id="fwd-delta" style="font-family:var(--display);color:var(--accent)"></div>
          <div style="font-size:11px;color:var(--text3);margin-top:6px">elapsed:</div>
          <div id="fwd-time" style="font-family:var(--display);color:var(--green)"></div>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px">
        <div class="ct">‚óâ Output (real model.generate())</div>
        <div class="out-box" id="i-out"><span style="color:var(--text3)">Output will appear here...</span></div>
        <div id="i-meta" style="margin-top:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Tokens</div><div style="font-family:var(--display);color:var(--accent)" id="im-tok">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Time (ms)</div><div style="font-family:var(--display);color:var(--accent)" id="im-time">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">tok/s</div><div style="font-family:var(--display);color:var(--green)" id="im-tps">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Status</div><div id="im-status" style="font-size:11px;color:var(--text2)">‚Äî</div></div>
        </div>
        <div id="i-status-line" style="margin-top:8px;font-size:11px;color:var(--text3)"></div>
      </div>
      <div class="card" style="margin-bottom:14px">
        <div class="ct">‚óê Audit (get_audit_summary)</div>
        <div id="i-audit" style="margin-top:8px;font-size:11px;color:var(--text3)">Run inference to populate</div>
      </div>
      <div class="card">
        <div class="ct">üìã Batch Inference</div>
        <div class="fg" style="margin-top:8px"><div class="fl">Prompts (one per line)</div>
          <textarea id="i-batch-prompts" rows="4" placeholder="What is consciousness?&#10;Explain quantum entanglement&#10;Define intelligence"></textarea>
        </div>
        <button class="btn btn-secondary" onclick="runBatch()" id="i-batch-btn">‚ñ∂‚ñ∂ Run Batch</button>
        <div id="i-batch-out" style="margin-top:10px;max-height:200px;overflow-y:auto;font-size:11px"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TRAINING ‚ïê‚ïê -->
<div class="panel" id="panel-training">
  <div class="ph">
    <div>
      <div class="ph-title">‚ö° AEON v4 Training Pipeline</div>
      <div class="ph-sub" id="v4-sub">Two-phase: AutoEncoder+VQ (Phase A) ‚Üí Contextual RSSM (Phase B)</div>
    </div>
    <div class="btns">
      <button class="btn btn-danger"  id="v4-stop-btn"  onclick="v4Stop()"  style="display:none">‚ñ† Stop</button>
      <button class="btn btn-primary" id="v4-start-btn" onclick="v4Start()">‚óâ Start v4 Training</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ File Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="card" style="margin-bottom:14px">
    <div class="ct" style="display:flex;justify-content:space-between;align-items:center">
      <span>üìÅ Training Data</span>
      <button class="btn btn-ghost" style="padding:3px 10px;font-size:11px" onclick="v4RefreshFiles()">‚ü≥ Refresh</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;margin-top:10px">
      <!-- Drop zone -->
      <div id="v4-drop" style="border:2px dashed var(--border);border-radius:8px;padding:18px;text-align:center;cursor:pointer;transition:border-color 0.2s"
           onclick="document.getElementById('v4-file-input').click()"
           ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
           ondragleave="this.style.borderColor='var(--border)'"
           ondrop="v4HandleDrop(event)">
        <div style="font-size:24px;margin-bottom:4px">üì§</div>
        <div style="font-size:12px;color:var(--text2)">Drop .json / .jsonl / .txt here</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px">or click to browse</div>
        <input type="file" id="v4-file-input" accept=".json,.jsonl,.txt" style="display:none" onchange="v4UploadFile(this.files[0])">
      </div>
      <!-- File list -->
      <div id="v4-file-list" style="min-width:220px;max-height:120px;overflow-y:auto;font-size:12px">
        <div style="color:var(--text3);font-size:11px">No files uploaded yet.</div>
      </div>
    </div>
    <div class="fr" style="margin-top:10px">
      <div class="fg" style="flex:3">
        <div class="fl">Selected file path</div>
        <input type="text" id="v4-json-path" value="./training_data/data.json" placeholder="./training_data/data.json">
      </div>
      <div class="fg" style="flex:2">
        <div class="fl">Output directory</div>
        <input type="text" id="v4-out-dir" value="./processed_v4/">
      </div>
      <div class="fg" style="flex:2">
        <div class="fl">Resume from checkpoint</div>
        <input type="text" id="v4-resume" placeholder="(optional path)">
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">‚öô Phase Configuration</div>
      <div class="fr" style="margin-top:8px">
        <div class="fg"><div class="fl">Phase A Epochs (AE+VQ)</div><input type="number" id="v4-ep-a" value="30" min="1" max="1000"></div>
        <div class="fg"><div class="fl">Phase B Epochs (RSSM)</div><input type="number" id="v4-ep-b" value="10" min="1" max="1000"></div>
      </div>
      <div class="fr">
        <div class="fg"><div class="fl">Learning Rate</div>
          <select id="v4-lr">
            <option value="1e-5">1e-5</option>
            <option value="3e-5" selected>3e-5</option>
            <option value="1e-4">1e-4</option>
            <option value="3e-4">3e-4</option>
          </select>
        </div>
        <div class="fg"><div class="fl">Batch Size</div>
          <select id="v4-bs">
            <option value="4">4</option>
            <option value="8">8</option>
            <option value="16" selected>16</option>
            <option value="32">32</option>
            <option value="64">64</option>
          </select>
        </div>
      </div>
      <div class="fr">
        <div class="fg"><div class="fl">Grad Clip</div>
          <div class="rr"><input type="range" id="v4-gc" min="0.1" max="5" step="0.1" value="0.5" oninput="rv('v4-gc-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="v4-gc-v">0.5</span></div>
        </div>
        <div class="fg"><div class="fl">Warmup Steps</div><input type="number" id="v4-ws" value="1000" min="0"></div>
      </div>
      <div class="fr">
        <div class="fg"><div class="fl">Entropy Weight</div>
          <div class="rr"><input type="range" id="v4-ew" min="0" max="1" step="0.01" value="0.1" oninput="rv('v4-ew-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="v4-ew-v">0.10</span></div>
        </div>
        <div class="fg"><div class="fl">Context Window K</div><input type="number" id="v4-cw" value="3" min="1" max="16"></div>
      </div>
    </div>
    <div class="card">
      <div class="ct">üèó Architecture & Flags</div>
      <div class="fr" style="margin-top:8px">
        <div class="fg"><div class="fl">z_dim</div><input type="number" id="v4-zdim" value="256" min="64" max="2048" step="64"></div>
        <div class="fg"><div class="fl">hidden_dim</div><input type="number" id="v4-hidden" value="256" min="64" max="2048" step="64"></div>
      </div>
      <div class="fr">
        <div class="fg"><div class="fl">VQ Embeddings</div>
          <select id="v4-vqn">
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048" selected>2048</option>
            <option value="4096">4096</option>
            <option value="8192">8192</option>
          </select>
        </div>
        <div class="fg"><div class="fl">Seq Length</div><input type="number" id="v4-seqlen" value="64" min="16" max="8192" step="16"></div>
      </div>
      <div class="fr">
        <div class="fg"><div class="fl">Num Pillars</div><input type="number" id="v4-pillars" value="5" min="1" max="64"></div>
        <div class="fg"><div class="fl">Seed</div><input type="number" id="v4-seed" value="42"></div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <div class="tog-row" style="border:none;padding:0">
          <div class="tog-info"><div class="tog-name" style="font-size:12px">document_aware</div><div class="tog-desc" style="font-size:10px">Build RSSM pairs within document boundaries</div></div>
          <label class="tog"><input type="checkbox" id="v4-docaware" checked><div class="tog-track"></div></label>
        </div>
        <div class="tog-row" style="border:none;padding:0">
          <div class="tog-info"><div class="tog-name" style="font-size:12px">use_amp</div><div class="tog-desc" style="font-size:10px">Automatic Mixed Precision (requires CUDA)</div></div>
          <label class="tog"><input type="checkbox" id="v4-amp" checked><div class="tog-track"></div></label>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Advanced Training Parameters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <details style="margin-bottom:14px">
    <summary style="cursor:pointer;font-size:12px;color:var(--text2);padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg)">‚ñ∂ Advanced Training Parameters (VQ-VAE, RSSM, Regularisation, Early Stopping)</summary>
    <div style="border:1px solid var(--border);border-top:none;border-radius:0 0 var(--rlg) var(--rlg);padding:14px">
      <div class="g3" style="margin-bottom:12px">
        <!-- VQ-VAE -->
        <div class="card ca">
          <div class="ct">üîÆ VQ-VAE Parameters</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <div class="fg"><div class="fl">Commitment Cost</div>
              <div class="rr"><input type="range" id="v4-vq-commit" min="0" max="2" step="0.05" value="0.25" oninput="rv('v4-vq-commit-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="v4-vq-commit-v">0.25</span></div>
            </div>
            <div class="fg"><div class="fl">VQ Loss Weight</div>
              <div class="rr"><input type="range" id="v4-vq-lw" min="0" max="5" step="0.1" value="0.5" oninput="rv('v4-vq-lw-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="v4-vq-lw-v">0.5</span></div>
            </div>
            <div class="fg"><div class="fl">EMA Decay</div>
              <div class="rr"><input type="range" id="v4-vq-ema" min="0.9" max="0.999" step="0.001" value="0.99" oninput="rv('v4-vq-ema-v',parseFloat(this.value).toFixed(3))"><span class="rv" id="v4-vq-ema-v">0.990</span></div>
            </div>
            <div class="fg"><div class="fl">Temperature</div>
              <div class="rr"><input type="range" id="v4-vq-temp" min="0.1" max="5" step="0.1" value="1.0" oninput="rv('v4-vq-temp-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="v4-vq-temp-v">1.0</span></div>
            </div>
            <div class="fg"><div class="fl">Reset Threshold</div><input type="number" id="v4-vq-reset" value="30" min="1" max="1000"></div>
          </div>
        </div>
        <!-- RSSM & Optimiser -->
        <div class="card cp">
          <div class="ct">‚öô RSSM & Optimiser</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <div class="fg"><div class="fl">RSSM Hidden Dim</div><input type="number" id="v4-rssm-hdim" value="512" min="64" max="4096" step="64"></div>
            <div class="fg"><div class="fl">Min Learning Rate</div>
              <select id="v4-min-lr">
                <option value="1e-7">1e-7</option>
                <option value="1e-6" selected>1e-6</option>
                <option value="1e-5">1e-5</option>
              </select>
            </div>
            <div class="fg"><div class="fl">Weight Decay</div>
              <div class="rr"><input type="range" id="v4-wd" min="0" max="0.1" step="0.001" value="0.01" oninput="rv('v4-wd-v',parseFloat(this.value).toFixed(3))"><span class="rv" id="v4-wd-v">0.010</span></div>
            </div>
            <div class="fg"><div class="fl">Grad Accumulation Steps</div><input type="number" id="v4-gas" value="2" min="1" max="64"></div>
            <div class="fg"><div class="fl">Min Doc Chunks</div><input type="number" id="v4-min-doc" value="2" min="1" max="100"></div>
          </div>
        </div>
        <!-- Regularisation & Early Stopping -->
        <div class="card cg">
          <div class="ct">üõ° Regularisation & Early Stopping</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <div class="fg"><div class="fl">Dropout Rate</div>
              <div class="rr"><input type="range" id="v4-dropout" min="0" max="0.9" step="0.05" value="0.1" oninput="rv('v4-dropout-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="v4-dropout-v">0.10</span></div>
            </div>
            <div class="fg"><div class="fl">Label Smoothing</div>
              <div class="rr"><input type="range" id="v4-labsm" min="0" max="0.5" step="0.01" value="0.1" oninput="rv('v4-labsm-v',parseFloat(this.value).toFixed(2))"><span class="rv" id="v4-labsm-v">0.10</span></div>
            </div>
            <div class="fg"><div class="fl">Early Stopping Patience</div><input type="number" id="v4-es-pat" value="5" min="1" max="100"></div>
            <div class="fg"><div class="fl">Min Delta</div><input type="number" id="v4-min-delta" value="0.0001" min="0" max="1" step="0.0001"></div>
            <div class="fg"><div class="fl">Save Every N Epochs</div><input type="number" id="v4-save-n" value="5" min="1" max="100"></div>
            <div class="fg"><div class="fl">Keep N Checkpoints</div><input type="number" id="v4-keep-n" value="3" min="1" max="50"></div>
          </div>
        </div>
      </div>
    </div>
  </details>

  <!-- ‚îÄ‚îÄ Live Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">‚óâ Training Status</div>
      <div id="v4-idle" style="font-size:12px;color:var(--text3);margin-top:8px">Ready to train. Select a file and press Start.</div>
      <div id="v4-active" style="display:none">
        <!-- Phase indicator -->
        <div style="display:flex;gap:8px;margin:10px 0 8px;align-items:center">
          <div id="v4-ph-a" style="padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:var(--accent);color:#000">Phase A: AE+VQ</div>
          <div style="color:var(--text3);font-size:11px">‚Üí</div>
          <div id="v4-ph-b" style="padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:var(--surface2);color:var(--text2)">Phase B: RSSM</div>
          <div style="flex:1"></div>
          <div id="v4-phase-lbl" style="font-size:11px;color:var(--text3)">Initialising‚Ä¶</div>
        </div>
        <!-- Epoch progress -->
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <span style="font-size:11px;color:var(--text2)" id="v4-epoch-lbl">Epoch 0/0</span>
          <span style="font-size:11px;color:var(--accent)" id="v4-pct">0%</span>
        </div>
        <div class="prog-track" style="height:6px"><div class="prog-fill" id="v4-prog" style="width:0%"></div></div>
        <!-- Metrics grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:14px">
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Loss</div><div style="font-family:var(--display);font-size:18px;color:var(--accent)" id="v4-loss">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Best</div><div style="font-family:var(--display);font-size:18px;color:var(--green)" id="v4-best">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Codebook %</div><div style="font-family:var(--display);font-size:18px;color:var(--purple)" id="v4-cb">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Elapsed</div><div style="font-family:var(--display);font-size:16px;color:var(--warn)" id="v4-elapsed">‚Äî</div></div>
        </div>
        <!-- Extended monitoring row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Convergence</div><div style="font-family:var(--display);font-size:13px;font-weight:600" id="v4-conv-status">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Velocity</div><div style="font-family:var(--display);font-size:14px;color:var(--text2)" id="v4-conv-vel">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Grad Norm</div><div style="font-family:var(--display);font-size:14px;color:var(--warn)" id="v4-gnorm">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Recon / VQ</div><div style="font-family:var(--display);font-size:13px;color:var(--text2)" id="v4-loss-split">‚Äî</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Accuracy</div><div style="font-family:var(--display);font-size:14px;color:var(--green)" id="v4-acc">‚Äî</div></div>
        </div>
      </div>
      <!-- Completion summary -->
      <div id="v4-done" style="display:none;margin-top:12px;padding:12px;background:rgba(0,212,100,0.08);border-radius:8px;border:1px solid rgba(0,212,100,0.2)">
        <div style="font-size:13px;font-weight:600;color:var(--green);margin-bottom:8px">üéâ Training Complete</div>
        <div style="font-size:12px;color:var(--text2)" id="v4-done-detail"></div>
      </div>
    </div>

    <!-- Save/Load -->
    <div class="card">
      <div class="ct">üíæ Save / Load Checkpoint</div>
      <div class="fr" style="margin-top:8px">
        <div class="fg"><div class="fl">Path</div><input type="text" id="ck-path" value="./checkpoints/aeon_state"></div>
        <div style="display:flex;gap:6px;align-items:flex-end">
          <button class="btn btn-secondary" onclick="saveModel()">‚Üë Save</button>
          <button class="btn btn-ghost" onclick="loadModel()">‚Üì Load</button>
        </div>
      </div>
      <div id="ck-result" style="font-size:11px;margin-top:6px;color:var(--text3)"></div>
      <div style="margin-top:14px">
        <div class="ct" style="margin-bottom:8px">ae_train.py Status</div>
        <div id="v4-ae-status" style="font-size:11px;padding:8px;background:var(--surface2);border-radius:6px;color:var(--text2)">Checking‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Live Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="g2" style="margin-bottom:14px">
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">Phase A ¬∑ Loss per Epoch</div>
        <div style="display:flex;gap:12px;font-size:10px;color:var(--text3)">
          <span style="color:var(--accent)">‚îÄ‚îÄ total</span>
          <span style="color:var(--purple)">‚îÄ‚îÄ recon</span>
          <span style="color:var(--green)">‚îÄ‚îÄ vq</span>
        </div>
      </div>
      <canvas id="v4-loss-chart-a" height="140"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">Phase B ¬∑ MSE + Cosine Sim</div>
        <div style="display:flex;gap:12px;font-size:10px;color:var(--text3)">
          <span style="color:var(--accent)">‚îÄ‚îÄ mse</span>
          <span style="color:var(--green)">‚îÄ‚îÄ cos_sim</span>
        </div>
      </div>
      <canvas id="v4-loss-chart-b" height="140"></canvas>
    </div>
  </div>
  <div class="g2" style="margin-bottom:14px">
    <div class="chart-wrap">
      <div class="chart-head"><div class="chart-title">Codebook Utilisation % (Phase A)</div></div>
      <canvas id="v4-cb-chart" height="110"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-head"><div class="chart-title">Accuracy % (Phase A)</div></div>
      <canvas id="v4-acc-chart" height="110"></canvas>
    </div>
  </div>
  <div class="g2" style="margin-bottom:14px">
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">Gradient Norms per Epoch</div>
        <div style="display:flex;gap:12px;font-size:10px;color:var(--text3)">
          <span style="color:var(--warn)">‚îÄ‚îÄ Phase A</span>
          <span style="color:var(--purple)">‚îÄ‚îÄ Phase B</span>
        </div>
      </div>
      <canvas id="v4-grad-chart" height="110"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-head">
        <div class="chart-title">Loss Components (Phase A)</div>
        <div style="display:flex;gap:12px;font-size:10px;color:var(--text3)">
          <span style="color:var(--accent)">‚îÄ‚îÄ recon</span>
          <span style="color:var(--purple)">‚îÄ‚îÄ vq</span>
        </div>
      </div>
      <canvas id="v4-loss-split-chart" height="110"></canvas>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Live Log Console ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="card" style="padding:0;overflow:hidden">
    <div style="display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--surface2)">
      <span class="ct" style="margin:0;flex:1">üìã Training Log Console</span>
      <select id="v4-log-lvl" style="font-size:11px;padding:2px 6px;margin-right:8px;background:var(--surface1);border:1px solid var(--border);color:var(--text1);border-radius:4px"
              onchange="v4FilterLogs()">
        <option value="">ALL</option>
        <option value="INFO">INFO</option>
        <option value="WARNING">WARN</option>
        <option value="ERROR">ERROR</option>
        <option value="DEBUG">DEBUG</option>
      </select>
      <button class="btn btn-ghost" style="padding:3px 10px;font-size:11px" onclick="v4ClearLogs()">Clear</button>
      <label style="font-size:11px;color:var(--text3);margin-left:10px;cursor:pointer">
        <input type="checkbox" id="v4-autoscroll" checked style="margin-right:4px">Auto-scroll
      </label>
    </div>
    <div id="v4-log-console" style="height:260px;overflow-y:auto;padding:10px 14px;font-family:monospace;font-size:11px;line-height:1.7;background:var(--bg)">
      <div style="color:var(--text3)">Training logs will appear here when training starts‚Ä¶</div>
    </div>
  </div>

  <!-- Legacy training (core.py AEONTrainer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <details style="margin-top:14px">
    <summary style="cursor:pointer;font-size:12px;color:var(--text3);padding:8px;background:var(--surface2);border-radius:6px">‚ñ∂ Legacy Core.py Trainer (synthetic data)</summary>
    <div style="padding:14px;border:1px solid var(--border);border-top:none;border-radius:0 0 6px 6px">
      <div class="g2" style="margin-bottom:12px">
        <div class="card">
          <div class="ct">‚öô Parameters</div>
          <div class="fr" style="margin-top:8px">
            <div class="fg"><div class="fl">Epochs</div><input type="number" id="t-ep" value="10" min="1" max="1000"></div>
            <div class="fg"><div class="fl">Learning Rate</div><select id="t-lr"><option value="1e-5">1e-5</option><option value="3e-5" selected>3e-5</option><option value="1e-4">1e-4</option><option value="3e-4">3e-4</option></select></div>
          </div>
          <div class="fr">
            <div class="fg"><div class="fl">Batch Size</div><select id="t-bs"><option value="4">4</option><option value="8">8</option><option value="16" selected>16</option><option value="32">32</option></select></div>
            <div class="fg"><div class="fl">grad_clip</div><div class="rr"><input type="range" id="t-gc" min="0.1" max="5" step="0.1" value="1.0" oninput="rv('t-gc-v',parseFloat(this.value).toFixed(1))"><span class="rv" id="t-gc-v">1.0</span></div></div>
          </div>
          <div class="fr">
            <div class="fg"><div class="fl">warmup_steps</div><input type="number" id="t-ws" value="100" min="0"></div>
            <div class="fg"><div class="fl">synthetic_samples</div><input type="number" id="t-synth" value="256" min="32" max="4096" step="32"></div>
          </div>
          <div class="fg"><div class="fl">CLI equivalent</div><div class="cb" style="padding:8px;font-size:11px;color:var(--green)" id="t-cli">python core.py --mode train --epochs 10 --batch-size 16 --lr 3e-5</div></div>
        </div>
        <div class="card">
          <div class="ct">‚óâ Status</div>
          <div id="t-idle" style="font-size:12px;color:var(--text3);margin-top:8px">No active training run.</div>
          <div id="t-active" style="display:none">
            <div style="display:flex;justify-content:space-between;margin:8px 0 4px">
              <span style="font-size:11px;color:var(--text2)" id="t-epoch-lbl">Epoch 0/0</span>
              <span style="font-size:11px;color:var(--accent)" id="t-pct">0%</span>
            </div>
            <div class="prog-track" style="height:6px"><div class="prog-fill" id="t-prog" style="width:0%"></div></div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-top:12px">
              <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Train Loss</div><div style="font-family:var(--display);font-size:18px;color:var(--accent)" id="t-loss">‚Äî</div></div>
              <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Val Loss</div><div style="font-family:var(--display);font-size:18px;color:var(--purple)" id="t-vloss">‚Äî</div></div>
              <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">LR</div><div style="font-family:var(--display);font-size:16px;color:var(--green)" id="t-lr-cur">‚Äî</div></div>
              <div style="text-align:center"><div style="font-size:10px;color:var(--text3)">Grad Norm</div><div style="font-family:var(--display);font-size:18px;color:var(--warn)" id="t-gnorm">‚Äî</div></div>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-danger" id="stop-btn" onclick="stopTrain()" style="display:none">‚ñ† Stop</button>
        <button class="btn btn-primary" id="start-btn" onclick="startTrain()">‚óâ Start Legacy Training</button>
      </div>
      <div class="g2" style="margin-top:12px">
        <div class="chart-wrap">
          <div class="chart-head"><div class="chart-title">Training Loss (per epoch)</div></div>
          <canvas id="loss-chart" height="150"></canvas>
        </div>
        <div class="chart-wrap">
          <div class="chart-head"><div class="chart-title">Gradient Norm (per step)</div></div>
          <canvas id="grad-chart" height="150"></canvas>
        </div>
      </div>
      <div class="chart-wrap" style="margin-top:12px">
        <div class="chart-head"><div class="chart-title">Step Loss (live)</div></div>
        <canvas id="step-loss-chart" height="100"></canvas>
      </div>
    </div>
  </details>
</div>

<!-- ‚ïê‚ïê TEST SUITE ‚ïê‚ïê -->
<div class="panel" id="panel-testsuite">
  <div class="ph">
    <div>
      <div class="ph-title">üß™ Test Suite ‚Äî test_fixes.py</div>
      <div class="ph-sub" id="ts-sub">642 tests ¬∑ 49 sections ¬∑ click ‚ñ∂ to run</div>
    </div>
    <div class="btns">
      <button class="btn btn-secondary" id="ts-fmt-btn" onclick="tsToggleFormat()" title="Toggle log format">üìã Full Log</button>
      <button class="btn btn-secondary" id="ts-stop-btn" onclick="tsStop()" style="display:none">‚èπ Stop</button>
      <button class="btn btn-secondary" onclick="tsRefreshCatalogue()">‚ü≥ Catalogue</button>
      <button class="btn btn-primary" id="test-run-btn" onclick="tsRunAll()">‚ñ∂ Run All</button>
    </div>
  </div>

  <!-- KPI row -->
  <div class="g4" style="margin-bottom:14px">
    <div class="card ca"><div class="ct">Total</div><div class="cv ca" id="ts-total">‚Äî</div><div class="cm-t" id="ts-total-m">not run</div></div>
    <div class="card cg"><div class="ct">Passed</div><div class="cv cg" id="ts-pass">‚Äî</div><div class="cm-t" id="ts-pass-rate">‚Äî</div></div>
    <div class="card cd"><div class="ct">Failed</div><div class="cv" style="color:var(--danger)" id="ts-fail">‚Äî</div><div class="cm-t" id="ts-fail-m">‚Äî</div></div>
    <div class="card cw"><div class="ct">Errors/Skip</div><div class="cv cw" id="ts-errors">‚Äî</div><div class="cm-t" id="ts-time">‚Äî</div></div>
  </div>

  <!-- Progress bar -->
  <div id="ts-prog-wrap" style="display:none;margin-bottom:14px">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:6px">
      <span id="ts-prog-lbl">Initialising‚Ä¶</span>
      <span id="ts-prog-pct">0%</span>
    </div>
    <div class="prog-track" style="height:10px">
      <div class="prog-fill" id="ts-prog-fill" style="width:0%;transition:width 0.3s"></div>
    </div>
    <div style="display:flex;gap:16px;margin-top:6px;font-size:10px;color:var(--text3)">
      <span>‚úÖ <span id="ts-live-pass">0</span></span>
      <span>‚ùå <span id="ts-live-fail">0</span></span>
      <span>üí• <span id="ts-live-err">0</span></span>
      <span>‚è≠ <span id="ts-live-skip">0</span></span>
      <span style="margin-left:auto" id="ts-live-cur"></span>
    </div>
  </div>

  <!-- Tabs: Sections | Results | Log -->
  <div style="display:flex;gap:0;border-bottom:1px solid var(--bord);margin-bottom:12px" id="ts-tabs">
    <button class="ts-tab active" onclick="tsTab('sections')" id="ts-tab-sections">üìÇ Sections (49)</button>
    <button class="ts-tab" onclick="tsTab('results')" id="ts-tab-results">üìä Results</button>
    <button class="ts-tab" onclick="tsTab('log')" id="ts-tab-log">üìÑ Log</button>
    <button class="ts-tab" onclick="tsTab('failures')" id="ts-tab-failures">‚ùå Failures</button>
    <select id="ts-filter-section" onchange="tsFilterSection()" style="margin-left:auto;font-size:11px;background:var(--surface2);color:var(--text);border:1px solid var(--bord);border-radius:4px;padding:2px 6px">
      <option value="">All sections</option>
    </select>
  </div>

  <!-- SECTIONS tab -->
  <div id="ts-pane-sections">
    <div id="ts-catalogue" style="max-height:520px;overflow-y:auto">
      <div style="color:var(--text3);font-size:12px">Click ‚ü≥ Catalogue to load test tree</div>
    </div>
  </div>

  <!-- RESULTS tab -->
  <div id="ts-pane-results" style="display:none">
    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
      <input type="text" id="ts-search" placeholder="Search tests‚Ä¶" oninput="tsFilterResults()" style="flex:1;font-size:12px;padding:4px 8px;background:var(--surface2);color:var(--text);border:1px solid var(--bord);border-radius:4px">
      <select id="ts-filter-status" onchange="tsFilterResults()" style="font-size:11px;background:var(--surface2);color:var(--text);border:1px solid var(--bord);border-radius:4px;padding:4px 6px">
        <option value="">All status</option>
        <option value="passed">‚úÖ Passed</option>
        <option value="failed">‚ùå Failed</option>
        <option value="error">üí• Error</option>
        <option value="skipped">‚è≠ Skipped</option>
      </select>
    </div>
    <div id="ts-results-list" style="max-height:500px;overflow-y:auto;font-size:11px"></div>
  </div>

  <!-- LOG tab -->
  <div id="ts-pane-log" style="display:none">
    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
      <label style="font-size:11px;color:var(--text3)">Format:</label>
      <select id="ts-log-display-fmt" onchange="tsRenderLog()" style="font-size:11px;background:var(--surface2);color:var(--text);border:1px solid var(--bord);border-radius:4px;padding:3px 6px">
        <option value="full">Full (stdout + traceback)</option>
        <option value="brief">Brief (one-liner)</option>
      </select>
      <label style="font-size:11px;color:var(--text3);margin-left:auto">Show:</label>
      <select id="ts-log-show" onchange="tsRenderLog()" style="font-size:11px;background:var(--surface2);color:var(--text);border:1px solid var(--bord);border-radius:4px;padding:3px 6px">
        <option value="all">All</option>
        <option value="passed">Passed only</option>
        <option value="failed">Failed only</option>
        <option value="error">Errors only</option>
      </select>
      <button class="btn btn-secondary" onclick="tsCopyLog()" style="font-size:10px;padding:3px 8px">üìã Copy</button>
    </div>
    <pre id="ts-log-pre" style="background:var(--surface);border:1px solid var(--bord);border-radius:6px;padding:12px;max-height:500px;overflow-y:auto;font-size:10.5px;line-height:1.6;color:var(--text);white-space:pre-wrap;word-break:break-all"></pre>
  </div>

  <!-- FAILURES tab -->
  <div id="ts-pane-failures" style="display:none">
    <div id="ts-failures-list" style="max-height:520px;overflow-y:auto">
      <div style="color:var(--text3);font-size:12px">No failures yet</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê BENCHMARK ‚ïê‚ïê -->
<div class="panel" id="panel-benchmark">
  <div class="ph">
    <div><div class="ph-title">Benchmark</div><div class="ph-sub">Inference latency profiling ¬∑ N-run statistical analysis</div></div>
    <div class="btns">
      <button class="btn btn-secondary" id="bench-refresh-btn" onclick="refreshBenchmark()">‚Üª Results</button>
      <button class="btn btn-primary" id="bench-run-btn" onclick="runBenchmark()">‚ö° Run Benchmark</button>
    </div>
  </div>
  <div class="card" style="margin-bottom:14px">
    <div class="ct">‚öô Benchmark Config</div>
    <div class="fr3" style="margin-top:8px">
      <div class="fg"><div class="fl">Runs</div><input type="number" id="b-runs" value="20" min="1" max="200"></div>
      <div class="fg"><div class="fl">max_length</div><input type="number" id="b-maxlen" value="32" min="8" max="256"></div>
      <div class="fg"><div class="fl">top_k</div><input type="number" id="b-topk" value="50" min="1" max="200"></div>
    </div>
    <div class="fr">
      <div class="fg"><div class="fl">Prompt</div><input type="text" id="b-prompt" value="Benchmark test prompt"></div>
      <div class="tog-row" style="border:none;padding:0"><div class="tog-info"><div class="tog-name" style="font-size:11px">fast mode</div></div><label class="tog"><input type="checkbox" id="b-fast" checked><div class="tog-track"></div></label></div>
    </div>
  </div>
  <div id="bench-prog-wrap" style="display:none;margin-bottom:14px">
    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
      <span style="font-size:11px;color:var(--text3)">Benchmarking...</span>
      <span id="bench-prog-pct" style="font-size:11px;color:var(--accent)">0/0</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="bench-prog-fill" style="width:0%"></div></div>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card ca"><div class="ct">Mean Latency</div><div class="cv ca" id="b-mean">‚Äî</div><div class="cm-t">ms</div></div>
    <div class="card cg"><div class="ct">P50 (Median)</div><div class="cv cg" id="b-p50">‚Äî</div><div class="cm-t">ms</div></div>
    <div class="card cw"><div class="ct">P95</div><div class="cv cw" id="b-p95">‚Äî</div><div class="cm-t">ms</div></div>
    <div class="card cp"><div class="ct">Throughput</div><div class="cv cp" id="b-tput">‚Äî</div><div class="cm-t">req/s</div></div>
  </div>
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">Latency Statistics</div>
      <div id="b-stats" style="margin-top:8px">
        <div style="color:var(--text3);font-size:11px">Run benchmark first</div>
      </div>
    </div>
    <div class="card">
      <div class="ct">Distribution Details</div>
      <div id="b-dist" style="margin-top:8px">
        <div style="color:var(--text3);font-size:11px">‚Äî</div>
      </div>
    </div>
  </div>
  <div class="chart-wrap">
    <div class="chart-head"><div class="chart-title">Latency per Run (ms)</div></div>
    <canvas id="bench-chart" height="150"></canvas>
  </div>
</div>

<!-- ‚ïê‚ïê VQ CODEBOOK ‚ïê‚ïê -->
<div class="panel" id="panel-vq">
  <div class="ph">
    <div><div class="ph-title">VQ Codebook ‚Äî Academic Diagnostics</div><div class="ph-sub">RobustVectorQuantizer ¬∑ exhaustive embedding analysis ¬∑ codebook health ¬∑ collapse detection</div></div>
    <div class="btns">
      <button class="btn btn-ghost" onclick="exportVQDiag()">‚Üì Export JSON</button>
      <button class="btn btn-secondary" onclick="loadVQ()">‚Üª Refresh</button>
    </div>
  </div>

  <!-- Row 1: Core Metrics -->
  <div class="vq-diag-grid">
    <div class="vq-metric"><div class="vm-label">Codebook Size</div><div class="vm-val ca" id="vq-size">‚Äî</div><div class="vm-sub">embeddings</div></div>
    <div class="vq-metric"><div class="vm-label">Embedding Dim</div><div class="vm-val cg" id="vq-dim">‚Äî</div><div class="vm-sub">dimensions</div></div>
    <div class="vq-metric"><div class="vm-label">Dead Codes</div><div class="vm-val" style="color:var(--danger)" id="vq-dead">‚Äî</div><div class="vm-sub">usage &lt; 0.1</div></div>
    <div class="vq-metric"><div class="vm-label">Utilization</div><div class="vm-val cp" id="vq-util">‚Äî</div><div class="vm-sub" id="vq-util-m">‚Äî</div></div>
    <div class="vq-metric"><div class="vm-label">Perplexity</div><div class="vm-val" style="color:var(--accent)" id="vq-perp">‚Äî</div><div class="vm-sub">EMA smoothed</div></div>
  </div>

  <!-- Row 2: Academic Metrics -->
  <div class="vq-diag-grid">
    <div class="vq-metric"><div class="vm-label">Shannon Entropy</div><div class="vm-val" style="color:#818cf8" id="vq-entropy">‚Äî</div><div class="vm-sub" id="vq-entropy-sub">‚Äî</div></div>
    <div class="vq-metric"><div class="vm-label">Norm. Entropy</div><div class="vm-val" style="color:#818cf8" id="vq-nentropy">‚Äî</div><div class="vm-sub">H / H_max</div></div>
    <div class="vq-metric"><div class="vm-label">Gini Coefficient</div><div class="vm-val" style="color:var(--warn)" id="vq-gini">‚Äî</div><div class="vm-sub">0=equal ¬∑ 1=monopoly</div></div>
    <div class="vq-metric"><div class="vm-label">Collapse Risk</div><div class="vm-val" id="vq-collapse">‚Äî</div><div class="vm-sub">entropy-based</div></div>
    <div class="vq-metric"><div class="vm-label">Total Steps</div><div class="vm-val" style="color:var(--text2)" id="vq-steps">‚Äî</div><div class="vm-sub">training steps</div></div>
  </div>

  <!-- Row 3: Norm Statistics & Cosine Similarity -->
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">Embedding Norm Statistics</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px">
        <div class="vq-hp-item"><span class="hp-k">Mean</span><span class="hp-v" id="vq-nm-mean">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Std</span><span class="hp-v" id="vq-nm-std">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Min</span><span class="hp-v" id="vq-nm-min">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Max</span><span class="hp-v" id="vq-nm-max">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Median</span><span class="hp-v" id="vq-nm-med">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">CV</span><span class="hp-v" id="vq-nm-cv">‚Äî</span></div>
      </div>
    </div>
    <div class="card">
      <div class="ct">Inter-Embedding Cosine Similarity (sample 64)</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px">
        <div class="vq-hp-item"><span class="hp-k">Mean Sim</span><span class="hp-v" id="vq-cs-mean">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Max Sim</span><span class="hp-v" id="vq-cs-max">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Min Sim</span><span class="hp-v" id="vq-cs-min">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Std Sim</span><span class="hp-v" id="vq-cs-std">‚Äî</span></div>
      </div>
    </div>
  </div>

  <!-- Row 4: Steps-Since-Used & Status Summary -->
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">Steps Since Last Used ‚Äî Staleness Analysis</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px">
        <div class="vq-hp-item"><span class="hp-k">Mean</span><span class="hp-v" id="vq-ssu-mean">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Max</span><span class="hp-v" id="vq-ssu-max">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Std</span><span class="hp-v" id="vq-ssu-std">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Stale &gt;50</span><span class="hp-v" id="vq-ssu-s50">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Stale &gt;100</span><span class="hp-v" id="vq-ssu-s100">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">Min</span><span class="hp-v" id="vq-ssu-min">‚Äî</span></div>
      </div>
    </div>
    <div class="card">
      <div class="ct">Code Status Distribution</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px">
        <div class="vq-hp-item"><span class="hp-k">üü¢ Active (‚â•5)</span><span class="hp-v" id="vq-st-active">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">üü° Low (1‚Äì5)</span><span class="hp-v" id="vq-st-low">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">üü† Rare (&lt;1)</span><span class="hp-v" id="vq-st-rare">‚Äî</span></div>
        <div class="vq-hp-item"><span class="hp-k">üî¥ Dead (&lt;0.1)</span><span class="hp-v" id="vq-st-dead">‚Äî</span></div>
      </div>
      <div style="margin-top:10px;height:6px;display:flex;border-radius:3px;overflow:hidden" id="vq-status-bar">
        <div style="background:var(--green);width:0%" id="vq-sb-active"></div>
        <div style="background:var(--warn);width:0%" id="vq-sb-low"></div>
        <div style="background:#f97316;width:0%" id="vq-sb-rare"></div>
        <div style="background:var(--danger);width:0%" id="vq-sb-dead"></div>
      </div>
    </div>
  </div>

  <!-- Row 5: Charts -->
  <div class="g2" style="margin-bottom:14px">
    <div class="chart-wrap">
      <div class="chart-head"><div class="chart-title">Embedding Norm Distribution</div></div>
      <canvas id="vq-norm-chart" height="180"></canvas>
    </div>
    <div class="chart-wrap">
      <div class="chart-head"><div class="chart-title">Usage Count Distribution (log scale)</div></div>
      <canvas id="vq-usage-chart" height="180"></canvas>
    </div>
  </div>

  <!-- Row 6: Heatmap -->
  <div class="card" style="margin-bottom:14px">
    <div class="ct">Codebook Utilization Heatmap (first 512 codes)</div>
    <div id="vq-heatmap" style="margin-top:10px"></div>
    <div class="cm-t" style="margin-top:6px" id="vq-heatmap-legend">Cyan = max usage ¬∑ Black = dead code</div>
  </div>

  <!-- Row 7: Top-K Used / Least Used -->
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">Top 20 Most Used Codes</div>
      <div id="vq-topk-used" style="margin-top:8px;max-height:260px;overflow-y:auto;font-size:10px">‚Äî</div>
    </div>
    <div class="card">
      <div class="ct">Top 20 Least Used Codes</div>
      <div id="vq-topk-unused" style="margin-top:8px;max-height:260px;overflow-y:auto;font-size:10px">‚Äî</div>
    </div>
  </div>

  <!-- Row 8: Hyperparameters -->
  <div class="card">
    <div class="ct">VQ Hyperparameters</div>
    <div class="vq-hp-grid" style="margin-top:10px" id="vq-hp-grid">
      <div class="vq-hp-item"><span class="hp-k">commitment_cost</span><span class="hp-v" id="vq-hp-cc">‚Äî</span></div>
      <div class="vq-hp-item"><span class="hp-k">decay (EMA)</span><span class="hp-v" id="vq-hp-decay">‚Äî</span></div>
      <div class="vq-hp-item"><span class="hp-k">epsilon</span><span class="hp-v" id="vq-hp-eps">‚Äî</span></div>
      <div class="vq-hp-item"><span class="hp-k">revival_threshold</span><span class="hp-v" id="vq-hp-revival">‚Äî</span></div>
      <div class="vq-hp-item"><span class="hp-k">split_threshold</span><span class="hp-v" id="vq-hp-split">‚Äî</span></div>
      <div class="vq-hp-item"><span class="hp-k">use_ema</span><span class="hp-v" id="vq-hp-ema">‚Äî</span></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê LOGS ‚ïê‚ïê -->
<div class="panel" id="panel-logs">
  <div class="ph">
    <div><div class="ph-title">Live Logs</div><div class="ph-sub">Real Python logging from core.py via WebSocket / SSE</div></div>
    <div class="btns">
      <button class="btn btn-ghost" id="pause-btn" onclick="togglePause()">‚è∏ Pause</button>
      <button class="btn btn-ghost" onclick="clearLogs()">‚úï Clear</button>
      <button class="btn btn-secondary" onclick="exportLogs()">‚Üì Export</button>
    </div>
  </div>
  <div class="log-tb">
    <div class="chip on-INFO" onclick="toggleChip(this,'INFO')">INFO</div>
    <div class="chip on-WARN" onclick="toggleChip(this,'WARN')">WARN</div>
    <div class="chip on-ERROR" onclick="toggleChip(this,'ERROR')">ERROR</div>
    <div class="chip on-DEBUG" onclick="toggleChip(this,'DEBUG')">DEBUG</div>
    <div class="chip on-SUCCESS" onclick="toggleChip(this,'SUCCESS')">SUCCESS</div>
    <div style="flex:1"></div>
    <input type="text" id="log-search" placeholder="filter..." style="width:180px;font-size:11px" oninput="rerenderLogs()">
    <div style="font-size:11px;color:var(--text3)" id="log-cnt">0</div>
  </div>
  <div class="log-wrap" id="log-box"></div>
</div>

<!-- ‚ïê‚ïê AUDIT ‚ïê‚ïê -->
<div class="panel" id="panel-audit">
  <div class="ph">
    <div><div class="ph-title">Audit Trail</div><div class="ph-sub">model.audit_log ¬∑ model.get_recent_decisions() ¬∑ model.get_pattern_insights()</div></div>
    <div class="btns">
      <select id="au-sub" onchange="loadAudit()" style="font-size:12px;padding:5px 8px">
        <option value="">All subsystems</option>
        <option value="safety">safety</option>
        <option value="memory">memory</option>
        <option value="meta_loop">meta_loop</option>
        <option value="vq_vae">vq_vae</option>
        <option value="encoder">encoder</option>
        <option value="causal">causal</option>
        <option value="planning">planning</option>
      </select>
      <select id="au-sev" onchange="loadAudit()" style="font-size:12px;padding:5px 8px">
        <option value="">All severities</option>
        <option value="info">info</option>
        <option value="warning">warning</option>
        <option value="critical">critical</option>
      </select>
      <button class="btn btn-secondary" onclick="loadAudit()">‚Üª Refresh</button>
      <button class="btn btn-ghost" onclick="exportAudit()">‚Üì Export</button>
    </div>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card ca"><div class="ct">Total</div><div class="cv ca" id="au-total">0</div></div>
    <div class="card cg"><div class="ct">Info</div><div class="cv cg" id="au-info">0</div></div>
    <div class="card cw"><div class="ct">Warnings</div><div class="cv cw" id="au-warn">0</div></div>
    <div class="card cd"><div class="ct">Critical</div><div class="cv" style="color:var(--danger)" id="au-crit">0</div></div>
  </div>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--rlg);overflow:hidden;max-height:380px;overflow-y:auto;margin-bottom:14px">
    <table class="tbl" id="au-tbl">
      <thead><tr><th>Time</th><th>Subsystem</th><th>Severity</th><th>Decision</th><th>Meta</th></tr></thead>
      <tbody id="au-tbody"><tr><td colspan="5" style="color:var(--text3);text-align:center;padding:20px">Initialize model and run inference to generate audit entries</td></tr></tbody>
    </table>
  </div>
  <div class="card"><div class="ct">Pattern Insights (model.audit_log.get_pattern_insights())</div><div id="au-insights" style="margin-top:8px;font-size:12px;color:var(--text3)">Insufficient data</div></div>
</div>

<!-- ‚ïê‚ïê MONITOR ‚ïê‚ïê -->
<div class="panel" id="panel-monitor">
  <div class="ph">
    <div><div class="ph-title">System Monitor</div><div class="ph-sub">SystemIntegrityMonitor ¬∑ /api/status/system ¬∑ real-time resource tracking</div></div>
    <button class="btn btn-secondary" onclick="loadHealth()">‚Üª Refresh</button>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card cg"><div class="ct">Overall Health</div><div class="cv cg" id="m-health">‚Äî</div><div class="cm-t" id="m-health-m">not initialized</div><div class="mbar" style="margin-top:8px"><div class="mfill g" id="m-health-bar" style="width:0%"></div></div></div>
    <div class="card ca"><div class="ct">NaN Events</div><div class="cv ca" id="m-nan">0</div><div class="cm-t">TensorGuard</div></div>
    <div class="card cp"><div class="ct">Inf Events</div><div class="cv cp" id="m-inf">0</div><div class="cm-t">TensorGuard</div></div>
    <div class="card cw"><div class="ct">Sanitized</div><div class="cv cw" id="m-san">0</div><div class="cm-t">auto-corrected</div></div>
  </div>
  <div class="g3" style="margin-bottom:14px">
    <div class="card"><div class="ct">CPU & RAM</div><div id="m-cpu" style="margin-top:8px;font-size:11px;color:var(--text3)">‚Äî</div></div>
    <div class="card"><div class="ct">GPU VRAM</div><div id="m-gpu" style="margin-top:8px;font-size:11px;color:var(--text3)">‚Äî</div></div>
    <div class="card"><div class="ct">Process</div><div id="m-proc" style="margin-top:8px;font-size:11px;color:var(--text3)">‚Äî</div></div>
  </div>
  <div class="g2" style="margin-bottom:14px">
    <div class="card"><div class="ct">Subsystem Scores</div><div class="ss-list" id="m-subsys" style="margin-top:8px"><div style="font-size:11px;color:var(--text3)">Initialize model first</div></div></div>
    <div class="card"><div class="ct">Recovery Stats</div><div id="m-recovery" style="margin-top:8px;font-size:11px;color:var(--text3)">‚Äî</div></div>
  </div>
  <div class="chart-wrap">
    <div class="chart-head"><div class="chart-title">Health Score History</div></div>
    <canvas id="health-chart" height="140"></canvas>
  </div>
</div>

<!-- ‚ïê‚ïê TENSORGUARD ‚ïê‚ïê -->
<div class="panel" id="panel-tg">
  <div class="ph">
    <div><div class="ph-title">TensorGuard</div><div class="ph-sub">model.tensor_guard ¬∑ NaN/Inf detection, quarantine & sanitization</div></div>
    <div class="btns">
      <button class="btn btn-secondary" onclick="loadTG()">‚Üª Refresh</button>
    </div>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card cg"><div class="ct">Policy</div><div class="cv cg" id="tg-pol" style="font-size:18px">‚Äî</div><div class="cm-t">current nan_policy</div></div>
    <div class="card cw"><div class="ct">NaN Count</div><div class="cv cw" id="tg-nan">0</div><div class="cm-t">total detected</div></div>
    <div class="card cd"><div class="ct">Inf Count</div><div class="cv" style="color:var(--danger)" id="tg-inf">0</div><div class="cm-t">total detected</div></div>
    <div class="card ca"><div class="ct">Sanitized</div><div class="cv ca" id="tg-san">0</div><div class="cm-t">auto-replaced</div></div>
  </div>
  <div class="card" style="margin-bottom:14px">
    <div class="ct">Recent NaN/Inf Events (context_history, last 50)</div>
    <div style="overflow-x:auto;margin-top:8px;max-height:300px;overflow-y:auto">
      <table class="tbl" id="tg-tbl">
        <thead><tr><th>Context</th><th>Shape</th><th>NaN count</th><th>Inf count</th></tr></thead>
        <tbody id="tg-tbody"><tr><td colspan="4" style="color:var(--text3);text-align:center;padding:20px">No events recorded</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê OBSERVABILITY ‚ïê‚ïê -->
<div class="panel" id="panel-observability">
  <div class="ph">
    <div><div class="ph-title">Observability & Telemetry</div><div class="ph-sub">Structured logging ¬∑ Metrics ¬∑ Distributed tracing ¬∑ Academic mode</div></div>
    <div class="btns">
      <button class="btn btn-secondary" onclick="loadObservability()">‚Üª Refresh</button>
      <button class="btn btn-ghost" onclick="exportTelemetry()">‚Üì Export</button>
    </div>
  </div>
  <div class="g4" style="margin-bottom:14px">
    <div class="card ca"><div class="ct">Structured Logging</div><div class="cv ca" id="obs-sl" style="font-size:16px">OFF</div><div class="cm-t">JSON-formatted logs with correlation IDs</div></div>
    <div class="card cp"><div class="ct">Academic Mode</div><div class="cv cp" id="obs-am" style="font-size:16px">OFF</div><div class="cm-t">Exhaustive debug-level logging</div></div>
    <div class="card cg"><div class="ct">Telemetry</div><div class="cv cg" id="obs-tel" style="font-size:16px">OFF</div><div class="cm-t">Metrics collection active</div></div>
    <div class="card cw"><div class="ct">Metrics Count</div><div class="cv cw" id="obs-mc">0</div><div class="cm-t">distinct metric types</div></div>
  </div>
  <div class="g2" style="margin-bottom:14px">
    <div class="card">
      <div class="ct">Telemetry Metrics Snapshot</div>
      <div style="overflow-x:auto;margin-top:8px;max-height:320px;overflow-y:auto">
        <table class="tbl" id="obs-metrics-tbl">
          <thead><tr><th>Metric</th><th>Count</th><th>Mean</th><th>Min</th><th>Max</th><th>Latest</th></tr></thead>
          <tbody id="obs-metrics-tbody"><tr><td colspan="6" style="color:var(--text3);text-align:center;padding:20px">No metrics recorded yet</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="ct">Recent Trace Events</div>
      <div style="overflow-x:auto;margin-top:8px;max-height:320px;overflow-y:auto">
        <table class="tbl" id="obs-traces-tbl">
          <thead><tr><th>Time</th><th>Subsystem</th><th>Decision</th><th>Severity</th></tr></thead>
          <tbody id="obs-traces-tbody"><tr><td colspan="4" style="color:var(--text3);text-align:center;padding:20px">No traces yet ‚Äî initialize model and run inference</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ct">Telemetry Counters</div>
    <div id="obs-counters" style="margin-top:8px;font-size:12px;color:var(--text3)">No counters recorded</div>
  </div>
</div>

<!-- ‚ïê‚ïê CODE GENERATOR ‚ïê‚ïê -->
<div class="panel" id="panel-codegen">
  <div class="ph">
    <div><div class="ph-title">Code Generator</div><div class="ph-sub">Python code from current config ‚Üí paste into your scripts</div></div>
    <button class="btn btn-primary" onclick="genCode()">‚öô Generate</button>
  </div>
  <div class="tbar">
    <button class="tbtn active" onclick="codeTab('init')">Init</button>
    <button class="tbtn" onclick="codeTab('infer')">Inference</button>
    <button class="tbtn" onclick="codeTab('train')">Training</button>
    <button class="tbtn" onclick="codeTab('intro')">Introspection</button>
    <button class="tbtn" onclick="codeTab('cli')">CLI</button>
    <button class="tbtn" onclick="codeTab('bench')">Benchmark</button>
    <button class="tbtn" onclick="codeTab('server')">Server</button>
  </div>
  <div class="tpanel active" id="codetab-init"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-init" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-infer"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-infer" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-train"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-train" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-intro"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-intro" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-cli"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-cli" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-bench"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-bench" style="margin:0;color:var(--text2)"></pre></div></div>
  <div class="tpanel" id="codetab-server"><div class="cb"><button class="cc" onclick="cpCode(this)">copy</button><pre id="code-server" style="margin:0;color:var(--text2)"></pre></div></div>
</div>

</main>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AEON Dashboard v3.2.0 ‚Äî Complete API Integration Layer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const API = window.location.origin;
const WS_URL = API.replace(/^http/, 'ws') + '/ws';

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  connected: false, modelReady: false, ws: null,
  logEntries: [], logFilters: new Set(['INFO','WARN','WARNING','ERROR','DEBUG','SUCCESS']),
  logPaused: false, logBadge: 0, activePanel: 'dashboard',
  trainHistory: {loss: [], val: [], epochs: []},
  gradHistory: [], stepLossHistory: [],
  healthHistory: [],
  auditData: [],
  benchData: null,
  testData: null,
  vqData: null,
  pollInterval: null, trainPollInterval: null, benchPollInterval: null, testPollInterval: null,
  modChartInstance: null, lossChartInstance: null, gradChartInstance: null,
  stepLossChartInstance: null, healthChartInstance: null,
  benchChartInstance: null, vqNormChartInstance: null, vqUsageChartInstance: null,
};

// ‚îÄ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(() => {
  const n = new Date();
  document.getElementById('clock').textContent =
    n.toLocaleTimeString('ru', {hour12: false}) + ' UTC' + (n.getTimezoneOffset() >= 0 ? '-' : '+') + Math.abs(n.getTimezoneOffset()/60);
}, 1000);

// ‚îÄ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(method, path, body) {
  try {
    const r = await fetch(API + path, {
      method,
      headers: {'Content-Type': 'application/json'},
      body: body ? JSON.stringify(body) : undefined,
    });
    let d;
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      d = await r.json();
    } else {
      const text = await r.text();
      d = { detail: text || r.statusText };
    }
    if (!r.ok) {
      const msg = d?.detail || d?.message || r.statusText;
      log('ERROR', 'api', `${method} ${path} ‚Üí ${r.status}: ${msg}`);
      throw new Error(msg);
    }
    return d;
  } catch(e) {
    if (!e.message?.includes('fetch')) log('ERROR', 'api', `${method} ${path}: ${e.message}`);
    throw e;
  }
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(panel) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const el = document.getElementById('panel-' + panel);
  if(el) el.classList.add('active');
  document.querySelectorAll(`.nav-item`).forEach(n => {
    if(n.getAttribute('onclick')?.includes(`'${panel}'`)) n.classList.add('active');
  });
  S.activePanel = panel;
  // Lazy-load panels
  if(panel === 'architecture') { if(S.modelReady) loadArch(); else resetArchPipeline(); }
  if(panel === 'monitor') loadHealth();
  if(panel === 'tg' && S.modelReady) loadTG();
  if(panel === 'audit' && S.modelReady) loadAudit();
  if(panel === 'modules' && S.modelReady) loadModules();
  if(panel === 'vq' && S.modelReady) loadVQ();
  if(panel === 'testsuite') refreshTests();
  if(panel === 'benchmark') refreshBenchmark();
  if(panel === 'codegen') genCode();
  if(panel === 'observability') loadObservability();
  if(panel === 'training') { updateTrainCLI(); _v4OnPanelOpen(); setTimeout(() => { drawLossChart(); drawGradChart(); drawStepLossChart(); v4DrawCharts(); }, 100); }
}

// ‚îÄ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectWS() {
  const badge = document.getElementById('conn-badge');
  const text = document.getElementById('conn-text');
  const dot = document.getElementById('conn-dot');
  badge.className = 'conn-badge connecting';
  text.textContent = 'Connecting...';
  dot.className = 'dot pulse';

  if (S.ws) { try { S.ws.close(); } catch(e){} }
  try {
    S.ws = new WebSocket(WS_URL);
    S.ws.onopen = () => {
      S.connected = true;
      badge.className = 'conn-badge connected';
      text.textContent = 'Connected';
      dot.className = 'dot';
      log('SUCCESS', 'ws', 'WebSocket connected to AEON server');
      document.getElementById('no-backend-alert').style.display = 'none';
      api('GET', '/api/status').then(d => {
        applyStatus(d);
        if(d.model_ready) { refreshDash(); }
      }).catch(() => {});
      // Start polling
      if(S.pollInterval) clearInterval(S.pollInterval);
      S.pollInterval = setInterval(pingPoll, 3000);
    };
    S.ws.onmessage = e => {
      const msg = JSON.parse(e.data);
      if(msg.type === 'log') appendLog(msg.data);
      else if(msg.type === 'heartbeat' || msg.type === 'pong') {
        if(msg.model_ready !== undefined) { S.modelReady = msg.model_ready; updateModelState(msg.model_ready); }
        if(msg.training && msg.training_progress) onTrainProgress(msg.training_progress);
      }
      else if(msg.type === 'status') {
        S.modelReady = msg.model_ready;
        updateModelState(msg.model_ready);
        if(msg.training_progress) onTrainProgress(msg.training_progress);
      }
      else if(msg.type === 'test_event' || msg.type === 'test_progress') {
        tsHandleWsEvent(msg);
      }
    };
    S.ws.onclose = () => {
      S.connected = false;
      badge.className = 'conn-badge disconnected';
      text.textContent = 'Disconnected';
      dot.className = 'dot pulse';
      log('WARN', 'ws', 'WebSocket disconnected ‚Äî retrying in 5s...');
      setTimeout(connectWS, 5000);
    };
    S.ws.onerror = () => {
      S.connected = false;
      badge.className = 'conn-badge disconnected';
      text.textContent = 'Error';
    };
  } catch(e) {
    badge.className = 'conn-badge disconnected';
    text.textContent = 'Failed';
    setTimeout(connectWS, 6000);
  }
}

function pingPoll() {
  if(S.ws?.readyState === WebSocket.OPEN) {
    S.ws.send(JSON.stringify({type: 'ping'}));
  }
  if(S.activePanel === 'monitor' && S.modelReady) loadHealth();
}

// ‚îÄ‚îÄ‚îÄ LOGGING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function log(level, subsys, msg) {
  const entry = { time: new Date().toLocaleTimeString('ru',{hour12:false}), level, subsys: subsys.slice(0,20), msg, ts: Date.now()/1000 };
  appendLog(entry);
}

function appendLog(entry) {
  if (!S.logPaused) {
    S.logEntries.push(entry);
    if (S.logEntries.length > 3000) S.logEntries.shift();
    if (S.activePanel !== 'logs') {
      S.logBadge++;
      const b = document.getElementById('log-badge');
      if(b) { b.textContent = S.logBadge > 99 ? '99+' : S.logBadge; }
    }
    renderLogEntry(entry);
  }
}

function renderLogEntry(entry) {
  const box = document.getElementById('log-box');
  if (!box) return;
  const lvl = (entry.level || 'INFO').toUpperCase();
  if (!S.logFilters.has(lvl) && !S.logFilters.has('WARN') ) {
    if (!(['WARN','WARNING'].includes(lvl) && S.logFilters.has('WARN'))) {
      if (!S.logFilters.has(lvl)) return;
    }
  }
  // Check search
  const search = document.getElementById('log-search')?.value?.toLowerCase() || '';
  if (search && !entry.msg?.toLowerCase().includes(search) && !entry.subsys?.toLowerCase().includes(search)) return;
  const div = document.createElement('div');
  div.className = 'log-e';
  div.innerHTML = `<span class="lt">${entry.time||''}</span><span class="ll ${lvl}">${lvl}</span><span class="ls">${entry.subsys||''}</span><span class="lm">${entry.msg||''}</span>`;
  box.appendChild(div);
  if(box.scrollTop + box.clientHeight > box.scrollHeight - 60) box.scrollTop = box.scrollHeight;
  document.getElementById('log-cnt').textContent = S.logEntries.length;
}

function rerenderLogs() {
  const box = document.getElementById('log-box');
  if (!box) return;
  box.innerHTML = '';
  const search = document.getElementById('log-search')?.value?.toLowerCase() || '';
  S.logEntries.forEach(e => {
    const lvl = (e.level||'INFO').toUpperCase();
    const matchFilter = S.logFilters.has(lvl) || (['WARN','WARNING'].includes(lvl) && S.logFilters.has('WARN'));
    const matchSearch = !search || e.msg?.toLowerCase().includes(search) || e.subsys?.toLowerCase().includes(search);
    if (matchFilter && matchSearch) renderLogEntry(e);
  });
  document.getElementById('log-cnt').textContent = S.logEntries.length;
}

function toggleChip(el, lvl) {
  if (S.logFilters.has(lvl)) { S.logFilters.delete(lvl); el.className = 'chip'; }
  else { S.logFilters.add(lvl); el.className = `chip on-${lvl}`; }
  rerenderLogs();
}

function togglePause() {
  S.logPaused = !S.logPaused;
  document.getElementById('pause-btn').textContent = S.logPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  if(!S.logPaused) rerenderLogs();
}

function clearLogs() {
  S.logEntries = [];
  document.getElementById('log-box').innerHTML = '';
  document.getElementById('log-cnt').textContent = '0';
  S.logBadge = 0;
  document.getElementById('log-badge').textContent = '0';
  api('DELETE', '/api/logs').catch(()=>{});
}

function exportLogs() {
  const text = S.logEntries.map(e => `[${e.time}] ${e.level} [${e.subsys}] ${e.msg}`).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/plain,' + encodeURIComponent(text);
  a.download = `aeon_logs_${Date.now()}.txt`;
  a.click();
}

// ‚îÄ‚îÄ‚îÄ STATUS HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyStatus(d) {
  if(d.model_ready !== undefined) {
    S.modelReady = d.model_ready;
    updateModelState(d.model_ready);
  }
  const devStr = document.getElementById('dev-str');
  if(devStr) devStr.textContent = d.cuda_device_name || d.device || (d.cuda_available ? 'CUDA' : 'CPU');
}

function updateModelState(ready) {
  S.modelReady = ready;
  const initBtn = document.getElementById('init-btn');
  const deinitBtn = document.getElementById('deinit-btn');
  const dashInitBtn = document.getElementById('dash-init-btn');
  if(ready) {
    initBtn && (initBtn.style.display = 'none');
    deinitBtn && (deinitBtn.style.display = '');
    dashInitBtn && (dashInitBtn.textContent = '‚ö° Re-init');
    document.getElementById('inf-status') && (document.getElementById('inf-status').className = 'badge bg', document.getElementById('inf-status').textContent = 'model ready');
  } else {
    initBtn && (initBtn.style.display = '');
    deinitBtn && (deinitBtn.style.display = 'none');
    document.getElementById('inf-status') && (document.getElementById('inf-status').className = 'badge br', document.getElementById('inf-status').textContent = 'model not initialized');
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildInitPayload() {
  const g = id => document.getElementById(id);
  const gb = id => document.getElementById(id)?.checked || false;
  const gn = id => parseFloat(document.getElementById(id)?.value) || 0;
  const gi = id => parseInt(document.getElementById(id)?.value) || 0;
  const gs = id => document.getElementById(id)?.value || '';
  return {
    hidden_dim: gi('c-hidden'), z_dim: gi('c-zdim'), vq_embedding_dim: gi('c-vqemb'),
    vq_num_embeddings: gi('c-vqnum'), vocab_size: gi('c-vocab'), seq_length: gi('c-seqlen'),
    num_pillars: gi('c-pillars'), encoder_backend: gs('c-enc'), decoder_backend: gs('c-dec'),
    device_str: gs('c-device'), max_iterations: gi('c-maxiter'),
    convergence_threshold: parseFloat(gs('c-convth')) || 1e-5,
    lipschitz_target: gn('c-lip'), nan_policy: gs('c-nanpol'),
    use_vq: gb('c-usevq'), use_amp: gb('c-amp'), enable_inference_cache: gb('c-infcache'),
    // Memory
    enable_hierarchical_memory: gb('c-hier-mem'),
    hierarchical_working_capacity: gi('c-wc'),
    hierarchical_episodic_capacity: gi('c-ec'),
    enable_neurogenic_memory: gb('c-neuro-mem'),
    neurogenic_retrieval_weight: gn('c-nrw'), neurogenic_retrieval_k: gi('c-nrk'),
    enable_temporal_memory: gb('c-temp-mem'),
    temporal_memory_decay_rate: gn('c-tmd'),
    enable_consolidating_memory: gb('c-cons-mem'),
    consolidating_semantic_weight: gn('c-consw'),
    // Causal
    enable_causal_model: gb('c-causal'),
    enable_notears_causal: gb('c-notears'), notears_num_vars: gi('c-ntvars'), lambda_causal_dag: gn('c-ldag'),
    enable_causal_world_model: gb('c-cawm'),
    enable_unified_simulator: gb('c-ucausal'), unified_simulator_num_vars: gi('c-ucvars'),
    enable_causal_context: gb('c-cactx'), enable_causal_trace: gb('c-catrace'),
    causal_blend_weight: gn('c-cbw'),
    // Meta
    enable_auto_critic: gb('c-ac'), auto_critic_threshold: gn('c-act'), auto_critic_max_iterations: gi('c-acmi'),
    enable_recursive_meta_loop: gb('c-rml'), recursive_meta_depth: gi('c-rmd'),
    enable_metacognitive_recursion: gb('c-mcr'),
    metacognitive_trigger_threshold: gn('c-mcrth'), metacognitive_extra_iterations: gi('c-mcrei'),
    enable_meta_learning: gb('c-maml'), meta_ewc_lambda: gn('c-ewc'),
    enable_error_evolution: gb('c-ee'), enable_meta_recovery_integration: gb('c-mri'),
    // Coherence
    enable_full_coherence: gb('c-fc'), enable_module_coherence: gb('c-mc'),
    module_coherence_threshold: gn('c-mcth'), enable_cross_validation: gb('c-cv'),
    enable_ns_consistency_check: gb('c-nsc'), enable_hybrid_reasoning: gb('c-hr'),
    enable_complexity_estimator: gb('c-ce'), enable_external_trust: gb('c-et'),
    intra_pass_feedback_threshold: gn('c-fbt'), intra_pass_feedback_scale: gn('c-fbs'),
    // Planning
    enable_world_model: gb('c-wm'), world_model_tree_depth: gi('c-wmd'), surprise_threshold: gn('c-st'),
    enable_mcts_planner: gb('c-mcts'),
    enable_active_learning_planner: gb('c-alp'), active_learning_curiosity_weight: gn('c-cw'),
    enable_hierarchical_vae: gb('c-hvae'), hvae_blend_weight: gn('c-hvbw'),
    seed: parseInt(document.getElementById('q-seed')?.value || '42'),
    // Observability
    enable_structured_logging: gb('c-obs-sl'),
    enable_academic_mode: gb('c-obs-am'),
    enable_telemetry: gb('c-obs-tel'),
  };
}

async function initModel() {
  const btn = document.getElementById('init-btn');
  const prog = document.getElementById('init-prog');
  const errDiv = document.getElementById('init-error');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Initializing...';
  prog.style.display = 'block';
  errDiv.style.display = 'none';

  const steps = ['Loading config...', 'Building encoder...', 'Building VQ-VAE...', 'Building meta-loop...', 'Building safety systems...', 'Finalizing...'];
  let si = 0;
  const stepInterval = setInterval(() => {
    document.getElementById('init-step-lbl').textContent = steps[si % steps.length];
    document.getElementById('init-prog-fill').style.width = `${(si / steps.length) * 80}%`;
    si++;
  }, 400);

  try {
    const p = buildInitPayload();
    // Quick preset override
    const preset = document.getElementById('q-preset')?.value;
    if(preset) { const pp = presets[preset]; if(pp) Object.assign(p, pp); }
    p.device_str = document.getElementById('q-device')?.value || 'auto';
    const hd = parseInt(document.getElementById('q-hidden')?.value);
    if(hd) { p.hidden_dim = hd; p.z_dim = hd; p.vq_embedding_dim = hd; }
    p.seed = parseInt(document.getElementById('q-seed')?.value || '42');

    const d = await api('POST', '/api/init', p);
    clearInterval(stepInterval);
    document.getElementById('init-prog-fill').style.width = '100%';
    document.getElementById('init-step-lbl').textContent = `‚úÖ ${d.parameters?.toLocaleString()} params ¬∑ device=${d.device}`;

    S.modelReady = true;
    updateModelState(true);
    setTimeout(() => { prog.style.display = 'none'; refreshDash(); }, 1200);
    log('SUCCESS', 'init', `Model initialized ¬∑ ${d.parameters?.toLocaleString()} params ¬∑ ${d.enabled_flags?.length || 0} subsystems ¬∑ device=${d.device}`);
  } catch(e) {
    clearInterval(stepInterval);
    errDiv.style.display = 'flex';
    errDiv.textContent = '‚úï ' + (e.message || e);
    prog.style.display = 'none';
    log('ERROR', 'init', 'Init failed: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '‚ö° Initialize';
  }
}

async function deinitModel() {
  await api('POST', '/api/deinit');
  S.modelReady = false;
  updateModelState(false);
  ['d-params','d-health','d-flags','d-vq'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = '‚Äî'; });
  document.getElementById('d-vq-bar').style.width = '0%';
  document.getElementById('d-vq-m').textContent = 'codebook usage';
  document.getElementById('d-health-bar').style.width = '0%';
  document.getElementById('d-health-m').textContent = '‚Äî';
  document.getElementById('d-ring-v').textContent = '‚Äî';
  const ring = document.getElementById('d-ring');
  if(ring) ring.setAttribute('stroke-dashoffset', 220);
  document.getElementById('d-flags-bar').style.width = '0%';
  document.getElementById('d-params-bar').style.width = '0%';
  document.getElementById('d-params-m').textContent = 'not initialized';
  document.getElementById('d-tg-total').textContent = '0';
  document.getElementById('d-tg-bar').style.width = '0%';
  document.getElementById('tg-nan-live').textContent = '0';
  document.getElementById('tg-inf-live').textContent = '0';
  document.getElementById('tg-san-live').textContent = '0';
  document.getElementById('d-subsys').innerHTML = '<div style="font-size:11px;color:var(--text3)">Initialize model first</div>';
  document.getElementById('d-decisions').innerHTML = '<div style="font-size:11px;color:var(--text3)">No decisions yet</div>';
  resetArchPipeline();
  log('INFO', 'init', 'Model deinitialized');
}

async function applyAndReinit() {
  await deinitModel();
  await initModel();
}

// ‚îÄ‚îÄ‚îÄ PRESETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const presets = {
  minimal: {
    hidden_dim:128, z_dim:128, vq_embedding_dim:128, vq_num_embeddings:4096,
    seq_length:32, max_iterations:10, num_pillars:16,
    encoder_backend:'ssm', decoder_backend:'ssm',
    lipschitz_target:0.95, convergence_threshold:'1e-4',
    nan_policy:'WARN', device_str:'auto',
    use_vq:true, use_amp:false, enable_inference_cache:false,
    // Memory ‚Äî all off for minimal
    enable_hierarchical_memory:false, enable_neurogenic_memory:false,
    enable_temporal_memory:false, enable_consolidating_memory:false,
    // Causal ‚Äî off
    enable_causal_model:false, enable_notears_causal:false,
    enable_causal_world_model:false, enable_unified_simulator:false,
    enable_causal_context:false, enable_causal_trace:false,
    // Meta ‚Äî off
    enable_auto_critic:false, enable_recursive_meta_loop:false,
    enable_metacognitive_recursion:false, enable_meta_learning:false,
    enable_error_evolution:false, enable_meta_recovery_integration:false,
    // Coherence ‚Äî off
    enable_full_coherence:false, enable_module_coherence:false,
    enable_cross_validation:false, enable_ns_consistency_check:false,
    enable_hybrid_reasoning:false, enable_complexity_estimator:false,
    enable_external_trust:false,
    // Planning ‚Äî off
    enable_world_model:false, enable_mcts_planner:false,
    enable_active_learning_planner:false, enable_hierarchical_vae:false,
    // Training
    learning_rate:'1e-4', batch_size:'8', gradient_clip_norm:1.0,
    warmup_steps:50, synthetic_samples:128,
    log_grad_norms:false,
    // Observability
    enable_structured_logging:false, enable_academic_mode:false, enable_telemetry:false,
  },
  production: {
    hidden_dim:256, z_dim:256, vq_embedding_dim:256, vq_num_embeddings:8192,
    seq_length:64, max_iterations:50, num_pillars:64,
    encoder_backend:'ssm', decoder_backend:'ssm',
    lipschitz_target:0.85, convergence_threshold:'1e-5',
    nan_policy:'WARN', device_str:'auto',
    use_vq:true, use_amp:true, enable_inference_cache:true,
    // Memory ‚Äî hierarchical only
    enable_hierarchical_memory:true, hierarchical_working_capacity:7,
    hierarchical_episodic_capacity:1000,
    enable_neurogenic_memory:false, enable_temporal_memory:false,
    enable_consolidating_memory:false,
    // Causal ‚Äî basic only
    enable_causal_model:true, enable_notears_causal:false,
    enable_causal_world_model:false, enable_unified_simulator:false,
    enable_causal_context:false, enable_causal_trace:false,
    causal_blend_weight:0.05,
    // Meta ‚Äî auto-critic only
    enable_auto_critic:true, auto_critic_threshold:0.85, auto_critic_max_iterations:3,
    enable_recursive_meta_loop:false, enable_metacognitive_recursion:false,
    enable_meta_learning:false, enable_error_evolution:false,
    enable_meta_recovery_integration:false,
    // Coherence ‚Äî module coherence only
    enable_full_coherence:false, enable_module_coherence:true,
    module_coherence_threshold:0.5,
    enable_cross_validation:false, enable_ns_consistency_check:false,
    enable_hybrid_reasoning:false, enable_complexity_estimator:true,
    enable_external_trust:false,
    feedback_threshold:0.3, feedback_scale:0.05,
    // Planning ‚Äî off
    enable_world_model:false, enable_mcts_planner:false,
    enable_active_learning_planner:false, enable_hierarchical_vae:false,
    // Training
    learning_rate:'3e-5', batch_size:'16', gradient_clip_norm:1.0,
    warmup_steps:100, synthetic_samples:256,
    log_grad_norms:true,
    // Observability
    enable_structured_logging:true, enable_academic_mode:false, enable_telemetry:true,
  },
  full: {
    hidden_dim:512, z_dim:512, vq_embedding_dim:512, vq_num_embeddings:16384,
    seq_length:128, max_iterations:100, num_pillars:128,
    encoder_backend:'mamba2', decoder_backend:'ssm',
    lipschitz_target:0.85, convergence_threshold:'1e-5',
    nan_policy:'QUARANTINE', device_str:'auto',
    use_vq:true, use_amp:true, enable_inference_cache:true,
    // Memory ‚Äî hierarchical + neurogenic
    enable_hierarchical_memory:true, hierarchical_working_capacity:7,
    hierarchical_episodic_capacity:5000,
    enable_neurogenic_memory:true, neurogenic_retrieval_weight:0.1, neurogenic_retrieval_k:5,
    enable_temporal_memory:true, temporal_memory_decay_rate:0.01,
    enable_consolidating_memory:false,
    // Causal ‚Äî basic + NOTEARS
    enable_causal_model:true, enable_notears_causal:true,
    notears_num_vars:8, lambda_causal_dag:0.01,
    enable_causal_world_model:true, enable_unified_simulator:false,
    enable_causal_context:true, enable_causal_trace:true,
    causal_blend_weight:0.05,
    // Meta ‚Äî critic + recursive + meta-learning
    enable_auto_critic:true, auto_critic_threshold:0.85, auto_critic_max_iterations:3,
    enable_recursive_meta_loop:true, recursive_meta_depth:3,
    enable_metacognitive_recursion:false, enable_meta_learning:true, meta_ewc_lambda:1000,
    enable_error_evolution:true, enable_meta_recovery_integration:true,
    // Coherence ‚Äî most enabled
    enable_full_coherence:false, enable_module_coherence:true,
    module_coherence_threshold:0.5,
    enable_cross_validation:true, enable_ns_consistency_check:true,
    enable_hybrid_reasoning:true, enable_complexity_estimator:true,
    enable_external_trust:false,
    feedback_threshold:0.3, feedback_scale:0.05,
    // Planning ‚Äî world model + MCTS
    enable_world_model:true, world_model_tree_depth:3, surprise_threshold:0.5,
    enable_mcts_planner:true, enable_active_learning_planner:false,
    enable_hierarchical_vae:false,
    // Training
    learning_rate:'3e-5', batch_size:'16', gradient_clip_norm:0.5,
    warmup_steps:200, synthetic_samples:512,
    log_grad_norms:true,
    // Observability
    enable_structured_logging:true, enable_academic_mode:false, enable_telemetry:true,
  },
  agi: {
    hidden_dim:512, z_dim:512, vq_embedding_dim:512, vq_num_embeddings:16384,
    seq_length:128, max_iterations:100, num_pillars:128,
    encoder_backend:'mamba2', decoder_backend:'ssm',
    lipschitz_target:0.80, convergence_threshold:'1e-6',
    nan_policy:'QUARANTINE', device_str:'auto',
    use_vq:true, use_amp:true, enable_inference_cache:true,
    // Memory ‚Äî all enabled
    enable_hierarchical_memory:true, hierarchical_working_capacity:9,
    hierarchical_episodic_capacity:10000,
    enable_neurogenic_memory:true, neurogenic_retrieval_weight:0.15, neurogenic_retrieval_k:5,
    enable_temporal_memory:true, temporal_memory_decay_rate:0.005,
    enable_consolidating_memory:true, consolidating_semantic_weight:0.1,
    // Causal ‚Äî all enabled
    enable_causal_model:true, enable_notears_causal:true,
    notears_num_vars:16, lambda_causal_dag:0.01,
    enable_causal_world_model:true,
    enable_unified_simulator:true, unified_simulator_num_vars:16,
    enable_causal_context:true, enable_causal_trace:true,
    causal_blend_weight:0.1,
    // Meta ‚Äî all enabled
    enable_auto_critic:true, auto_critic_threshold:0.90, auto_critic_max_iterations:5,
    enable_recursive_meta_loop:true, recursive_meta_depth:5,
    enable_metacognitive_recursion:true, metacognitive_trigger_threshold:0.5, metacognitive_extra_iterations:10,
    enable_meta_learning:true, meta_ewc_lambda:2000,
    enable_error_evolution:true, enable_meta_recovery_integration:true,
    // Coherence ‚Äî full coherence
    enable_full_coherence:true, enable_module_coherence:true,
    module_coherence_threshold:0.6,
    enable_cross_validation:true, enable_ns_consistency_check:true,
    enable_hybrid_reasoning:true, enable_complexity_estimator:true,
    enable_external_trust:true,
    feedback_threshold:0.25, feedback_scale:0.05,
    // Planning ‚Äî all enabled
    enable_world_model:true, world_model_tree_depth:5, surprise_threshold:0.4,
    enable_mcts_planner:true,
    enable_active_learning_planner:true, active_learning_curiosity_weight:1.0,
    enable_hierarchical_vae:true, hvae_blend_weight:0.1,
    // Training
    learning_rate:'1e-5', batch_size:'8', gradient_clip_norm:0.5,
    warmup_steps:500, synthetic_samples:512,
    log_grad_norms:true,
    // Observability ‚Äî full
    enable_structured_logging:true, enable_academic_mode:true, enable_telemetry:true,
  },
};

function applyPreset(name) {
  const p = presets[name];
  if(!p) return;
  const setV = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
  const setC = (id, v) => { const el = document.getElementById(id); if(el) el.checked = !!v; };
  const setR = (id, v, rvId) => { const el = document.getElementById(id); if(el) { el.value = v; if(rvId) rv(rvId, typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(v < 0.1 ? 3 : 2)) : v); } };
  // Architecture core
  if(p.hidden_dim) { setV('c-hidden', p.hidden_dim); setV('c-zdim', p.z_dim||p.hidden_dim); setV('c-vqemb', p.vq_embedding_dim||p.hidden_dim); checkVq(); }
  if(p.vq_num_embeddings) setV('c-vqnum', p.vq_num_embeddings);
  if(p.seq_length) setV('c-seqlen', p.seq_length);
  if(p.max_iterations) setR('c-maxiter', p.max_iterations, 'c-maxiter-v');
  if(p.num_pillars) setV('c-pillars', p.num_pillars);
  if(p.encoder_backend) setV('c-enc', p.encoder_backend);
  if(p.decoder_backend) setV('c-dec', p.decoder_backend);
  if(p.lipschitz_target) setR('c-lip', p.lipschitz_target, 'c-lip-v');
  if(p.convergence_threshold) setV('c-convth', p.convergence_threshold);
  if(p.nan_policy) setV('c-nanpol', p.nan_policy);
  if(p.device_str) setV('c-device', p.device_str);
  if(p.vocab_size) setV('c-vocab', p.vocab_size);
  // Architecture toggles
  if(p.use_vq !== undefined) setC('c-usevq', p.use_vq);
  if(p.use_amp !== undefined) setC('c-amp', p.use_amp);
  if(p.enable_inference_cache !== undefined) setC('c-infcache', p.enable_inference_cache);
  // Coherence
  if(p.enable_full_coherence !== undefined) setC('c-fc', p.enable_full_coherence);
  // Memory
  ['hierarchical_memory','neurogenic_memory','temporal_memory','consolidating_memory'].forEach(k => {
    const key = 'enable_'+k; if(p[key]!==undefined) {
      const el_map = {hierarchical_memory:'c-hier-mem',neurogenic_memory:'c-neuro-mem',temporal_memory:'c-temp-mem',consolidating_memory:'c-cons-mem'};
      const sub_map = {hierarchical_memory:'mem-hier-sub',neurogenic_memory:'mem-neuro-sub',temporal_memory:'mem-temp-sub',consolidating_memory:'mem-cons-sub'};
      setC(el_map[k], p[key]);
      const sub = document.getElementById(sub_map[k]); if(sub) sub.style.opacity = p[key] ? '1' : '0.4';
    }
  });
  // Memory sub-params
  if(p.hierarchical_working_capacity) setV('c-wc', p.hierarchical_working_capacity);
  if(p.hierarchical_episodic_capacity) setV('c-ec', p.hierarchical_episodic_capacity);
  if(p.neurogenic_retrieval_weight != null) setR('c-nrw', p.neurogenic_retrieval_weight, 'c-nrw-v');
  if(p.neurogenic_retrieval_k) setV('c-nrk', p.neurogenic_retrieval_k);
  if(p.temporal_memory_decay_rate != null) setR('c-tmd', p.temporal_memory_decay_rate, 'c-tmd-v');
  if(p.consolidating_semantic_weight != null) setR('c-consw', p.consolidating_semantic_weight, 'c-consw-v');
  // Causal & Meta & Coherence & Planning toggles
  ['causal_model','notears_causal','causal_world_model','unified_simulator','causal_context','causal_trace',
   'auto_critic','recursive_meta_loop','metacognitive_recursion','meta_learning','error_evolution','meta_recovery_integration',
   'module_coherence','cross_validation','ns_consistency_check','hybrid_reasoning','complexity_estimator','external_trust',
   'world_model','mcts_planner','active_learning_planner','hierarchical_vae'].forEach(k => {
    const key = 'enable_'+k;
    const el_map = {causal_model:'c-causal',notears_causal:'c-notears',causal_world_model:'c-cawm',
      unified_simulator:'c-ucausal',causal_context:'c-cactx',causal_trace:'c-catrace',
      auto_critic:'c-ac',recursive_meta_loop:'c-rml',metacognitive_recursion:'c-mcr',
      meta_learning:'c-maml',error_evolution:'c-ee',meta_recovery_integration:'c-mri',
      module_coherence:'c-mc',cross_validation:'c-cv',
      ns_consistency_check:'c-nsc',hybrid_reasoning:'c-hr',complexity_estimator:'c-ce',external_trust:'c-et',
      world_model:'c-wm',mcts_planner:'c-mcts',active_learning_planner:'c-alp',hierarchical_vae:'c-hvae'};
    const sub_map = {notears_causal:'notears-sub',unified_simulator:'ucausal-sub',
      auto_critic:'ac-sub',recursive_meta_loop:'rml-sub',metacognitive_recursion:'mcr-sub',
      meta_learning:'maml-sub',world_model:'wm-sub',active_learning_planner:'alp-sub',hierarchical_vae:'hvae-sub'};
    if(p[key]!==undefined && el_map[k]) {
      setC(el_map[k], p[key]);
      if(sub_map[k]) { const sub = document.getElementById(sub_map[k]); if(sub) sub.style.opacity = p[key] ? '1' : '0.4'; }
    }
  });
  // Causal sub-params
  if(p.notears_num_vars) setV('c-ntvars', p.notears_num_vars);
  if(p.lambda_causal_dag != null) setR('c-ldag', p.lambda_causal_dag, 'c-ldag-v');
  if(p.unified_simulator_num_vars) setV('c-ucvars', p.unified_simulator_num_vars);
  if(p.causal_blend_weight != null) setR('c-cbw', p.causal_blend_weight, 'c-cbw-v');
  // Meta sub-params
  if(p.auto_critic_threshold != null) setR('c-act', p.auto_critic_threshold, 'c-act-v');
  if(p.auto_critic_max_iterations) setV('c-acmi', p.auto_critic_max_iterations);
  if(p.recursive_meta_depth) setR('c-rmd', p.recursive_meta_depth, 'c-rmd-v');
  if(p.metacognitive_trigger_threshold != null) setR('c-mcrth', p.metacognitive_trigger_threshold, 'c-mcrth-v');
  if(p.metacognitive_extra_iterations) setV('c-mcrei', p.metacognitive_extra_iterations);
  if(p.meta_ewc_lambda != null) setR('c-ewc', p.meta_ewc_lambda, 'c-ewc-v');
  // Coherence sub-params
  if(p.module_coherence_threshold != null) setR('c-mcth', p.module_coherence_threshold, 'c-mcth-v');
  if(p.feedback_threshold != null) setR('c-fbt', p.feedback_threshold, 'c-fbt-v');
  if(p.feedback_scale != null) setR('c-fbs', p.feedback_scale, 'c-fbs-v');
  // Planning sub-params
  if(p.world_model_tree_depth) setV('c-wmd', p.world_model_tree_depth);
  if(p.surprise_threshold != null) setR('c-st', p.surprise_threshold, 'c-st-v');
  if(p.active_learning_curiosity_weight != null) setR('c-cw', p.active_learning_curiosity_weight, 'c-cw-v');
  if(p.hvae_blend_weight != null) setR('c-hvbw', p.hvae_blend_weight, 'c-hvbw-v');
  // Training
  if(p.learning_rate) setV('c-lr', p.learning_rate);
  if(p.batch_size) setV('c-bs', p.batch_size);
  if(p.gradient_clip_norm != null) setR('c-gcn', p.gradient_clip_norm, 'c-gcn-v');
  if(p.warmup_steps != null) setV('c-ws', p.warmup_steps);
  if(p.synthetic_samples) setV('c-synth', p.synthetic_samples);
  if(p.log_grad_norms !== undefined) setC('c-loggn', p.log_grad_norms);
  // Observability
  if(p.enable_structured_logging !== undefined) setC('c-obs-sl', p.enable_structured_logging);
  if(p.enable_academic_mode !== undefined) setC('c-obs-am', p.enable_academic_mode);
  if(p.enable_telemetry !== undefined) setC('c-obs-tel', p.enable_telemetry);
  syncJsonEditor();
  log('INFO', 'config', `Preset '${name}' applied`);
}

// ‚îÄ‚îÄ‚îÄ CONFIG HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rv(id, v) { const el = document.getElementById(id); if(el) el.textContent = v; }
function dep(cb, subId) {
  const sub = document.getElementById(subId);
  if(sub) sub.style.opacity = cb.checked ? '1' : '0.4';
}
function syncVqDim() {
  const z = document.getElementById('c-zdim')?.value;
  const vqe = document.getElementById('c-vqemb');
  if(vqe && z) { vqe.value = z; checkVq(); }
}
function checkVq() {
  const z = parseInt(document.getElementById('c-zdim')?.value);
  const vqe = parseInt(document.getElementById('c-vqemb')?.value);
  const hint = document.getElementById('vq-hint');
  if(!hint) return;
  if(z === vqe) { hint.textContent = '‚úì matches z_dim'; hint.style.color = 'var(--green)'; }
  else { hint.textContent = `‚ö† MUST equal z_dim (${z})`; hint.style.color = 'var(--danger)'; }
}
function onFC(cb) {
  if(cb.checked) {
    ['c-mc','c-cv','c-nsc','c-hr','c-ce'].forEach(id => { const el = document.getElementById(id); if(el) el.checked = true; });
  }
}
function resetCfg() { applyPreset('production'); }
function copyCfgJSON() {
  const p = buildInitPayload();
  navigator.clipboard?.writeText(JSON.stringify(p, null, 2));
  log('INFO', 'config', 'Config JSON copied to clipboard');
}

async function validateConfig() {
  const p = buildInitPayload();
  const resDiv = document.getElementById('cfg-validate-result');
  resDiv.style.display = 'block';
  resDiv.innerHTML = '<div class="alert alert-blue">‚è≥ Validating...</div>';
  try {
    const d = await api('POST', '/api/config/validate', {config: p});
    if(d.ok) {
      let html = '<div class="alert alert-green">‚úÖ Config valid';
      if(d.warnings?.length) html += '<br>' + d.warnings.map(w => `‚ö† ${w}`).join('<br>');
      html += '</div>';
      resDiv.innerHTML = html;
    } else {
      resDiv.innerHTML = '<div class="alert alert-danger">‚úï ' + d.errors.join('<br>‚úï ') + '</div>';
    }
  } catch(e) {
    resDiv.innerHTML = '<div class="alert alert-danger">‚úï ' + e.message + '</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ JSON EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncJsonEditor() {
  const ta = document.getElementById('json-editor-ta');
  if(!ta) return;
  ta.value = JSON.stringify(buildInitPayload(), null, 2);
}
function formatJson() {
  const ta = document.getElementById('json-editor-ta');
  try { ta.value = JSON.stringify(JSON.parse(ta.value), null, 2); document.getElementById('json-editor-err').textContent = ''; }
  catch(e) { document.getElementById('json-editor-err').textContent = e.message; }
}
function loadFromJsonEditor() {
  const ta = document.getElementById('json-editor-ta');
  const errDiv = document.getElementById('json-editor-err');
  try {
    const cfg = JSON.parse(ta.value);
    errDiv.textContent = '';
    // Apply values to form
    Object.entries(cfg).forEach(([k, v]) => {
      const el = document.getElementById('c-' + k.replace(/_/g, '-').replace('enable-', '').replace('hierarchical-memory','hier-mem'));
      // Try to set value
      try {
        if(typeof v === 'boolean' && el?.type === 'checkbox') el.checked = v;
        else if(typeof v === 'number' && el) el.value = v;
        else if(typeof v === 'string' && el) el.value = v;
      } catch(_) {}
    });
    log('INFO', 'config', 'JSON config applied to form');
  } catch(e) {
    errDiv.textContent = 'JSON parse error: ' + e.message;
  }
}
async function applyJsonAndReinit() {
  const ta = document.getElementById('json-editor-ta');
  const errDiv = document.getElementById('json-editor-err');
  try {
    const cfg = JSON.parse(ta.value);
    errDiv.textContent = '';
    await api('POST', '/api/deinit').catch(()=>{});
    const d = await api('POST', '/api/init', cfg);
    S.modelReady = true;
    updateModelState(true);
    refreshDash();
    log('SUCCESS', 'init', `Model re-initialized from JSON ¬∑ ${d.parameters?.toLocaleString()} params`);
  } catch(e) {
    errDiv.textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshAll() {
  const d = await api('GET', '/api/status').catch(() => null);
  if(d) applyStatus(d);
  if(S.modelReady) refreshDash();
  loadHealth();
}

async function refreshDash() {
  try {
    const d = await api('GET', '/api/introspect');
    const params = d.parameters || 0;
    document.getElementById('d-params').textContent = params > 1e6 ? (params/1e6).toFixed(1)+'M' : params.toLocaleString();
    document.getElementById('d-params-m').textContent = `${d.trainable_parameters?.toLocaleString()} trainable`;
    document.getElementById('d-params-bar').style.width = Math.min(100, params / 1e7 * 100) + '%';

    const tg = d.tensorguard || {};
    document.getElementById('tg-nan-live').textContent = tg.nan_count || 0;
    document.getElementById('tg-inf-live').textContent = tg.inf_count || 0;
    document.getElementById('tg-san-live').textContent = tg.sanitize_count || 0;
    const total = (tg.nan_count || 0) + (tg.inf_count || 0);
    document.getElementById('d-tg-total').textContent = total;
    document.getElementById('d-tg-bar').style.width = Math.min(100, total * 10) + '%';

    // Flags
    const cfg = d.config || {};
    const flags = Object.entries(cfg).filter(([k,v]) => k.startsWith('enable_') && v === true).length;
    document.getElementById('d-flags').textContent = flags;
    document.getElementById('d-flags-bar').style.width = Math.min(100, flags * 5) + '%';

    // VQ stats
    const vq = d.vq_stats || {};
    const util = vq.usage_rate ?? vq.utilization_ratio;
    document.getElementById('d-vq').textContent = util != null ? (util*100).toFixed(0)+'%' : '‚Äî';
    document.getElementById('d-vq-m').textContent = (vq.used_codes || vq.active_codes) ? `${vq.used_codes||vq.active_codes} active / ${vq.total_codes||vq.num_embeddings} total` : 'codebook usage';
    document.getElementById('d-vq-bar').style.width = util != null ? (util*100)+'%' : '0%';

    // Recent decisions
    const decDiv = document.getElementById('d-decisions');
    const decisions = d.recent_decisions || [];
    decDiv.innerHTML = decisions.length ? decisions.slice(-8).map(dec => {
      const sub = dec.subsystem || dec.name || '‚Äî';
      const sev = dec.severity || 'info';
      const cls = sev === 'critical' ? 'br' : sev === 'warning' ? 'bw' : 'ba';
      return `<div style="display:flex;align-items:center;gap:6px;padding:3px 0">
        <span class="badge ${cls}">${sub}</span>
        <span style="font-size:10px;color:var(--text3);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${dec.decision||dec.msg||''}</span>
      </div>`;
    }).join('') : '<div style="font-size:11px;color:var(--text3)">No decisions yet</div>';

    // Audit summary
    const as = d.audit_summary || {};
    const ts = as.total || (as.info||0)+(as.warning||0)+(as.critical||0);
    const asDiv = document.getElementById('i-audit');
    if(asDiv) asDiv.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      <div><div style="font-size:10px;color:var(--text3)">Total</div><div style="font-family:var(--display);color:var(--accent)">${ts}</div></div>
      <div><div style="font-size:10px;color:var(--text3)">Warnings</div><div style="font-family:var(--display);color:var(--warn)">${as.warning||0}</div></div>
      <div><div style="font-size:10px;color:var(--text3)">Critical</div><div style="font-family:var(--display);color:var(--danger)">${as.critical||0}</div></div>
    </div>`;

    // Codebook viz
    drawCodebook(vq);
  } catch(e) {}

  // Health
  try {
    const h = await api('GET', '/api/health');
    const score = h.health_score;
    document.getElementById('d-health').textContent = score ? (score*100).toFixed(0)+'%' : '‚Äî';
    document.getElementById('d-health-bar').style.width = (score||0)*100 + '%';
    const ring = document.getElementById('d-ring');
    if(ring) ring.setAttribute('stroke-dashoffset', 220 - (score||0) * 220);
    document.getElementById('d-ring-v').textContent = score ? (score*100).toFixed(0)+'%' : '‚Äî';
    document.getElementById('d-health-m').textContent = score >= 0.9 ? 'excellent' : score >= 0.7 ? 'good' : score >= 0.5 ? 'degraded' : 'critical';

    // Subsystem list
    const subsys = h.subsystems || {};
    const ssDiv = document.getElementById('d-subsys');
    ssDiv.innerHTML = Object.entries(subsys).map(([k, v]) => {
      const pct = typeof v === 'number' ? (v*100).toFixed(0) : v;
      const clr = v >= 0.8 ? 'var(--green)' : v >= 0.5 ? 'var(--warn)' : 'var(--danger)';
      return `<div class="ss-item"><div class="ss-dot" style="background:${clr}"></div><div class="ss-name">${k}</div><div class="ss-val">${pct}%</div></div>`;
    }).join('') || '<div style="font-size:11px;color:var(--text3)">No subsystems tracked</div>';
  } catch(e) {}
}

function drawCodebook(vq) {
  const cbk = document.getElementById('d-cbk');
  if(!cbk) return;
  const n = vq.total_codes || vq.num_embeddings || 256;
  const cells = Math.min(n, 128);
  const active = vq.used_codes || vq.active_codes || Math.floor(cells * 0.7);
  cbk.innerHTML = '';
  for(let i=0;i<cells;i++) {
    const div = document.createElement('div');
    div.className = 'cbk-c';
    const used = Math.random() < (active/cells);
    const intensity = used ? 0.4 + Math.random()*0.6 : 0.05;
    div.style.background = `rgba(0,212,255,${intensity})`;
    div.title = `Code ${i}: ${used?'active':'dead'}`;
    cbk.appendChild(div);
  }
  const utilRatio = vq.usage_rate ?? vq.utilization_ratio;
  document.getElementById('d-cbk-m').textContent =
    `${vq.used_codes||vq.active_codes||'?'} active / ${n} total codes ¬∑ ${utilRatio!=null?(utilRatio*100).toFixed(1)+'%':''} utilized`;
}

// ‚îÄ‚îÄ‚îÄ ARCHITECTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _archAutoRefreshTimer = null;
let _archData = null;

function resetArchPipeline() {
  document.querySelectorAll('#arch-flow .arch-pulse').forEach(p => p.className = 'arch-pulse off');
  ['arch-total-params','arch-train-params','arch-frozen-params','arch-total-mem'].forEach(id => {
    const el = document.getElementById(id); if(el) el.textContent = '‚Äî';
  });
  ['a-enc-p','a-vq-p','a-ml-p','a-dec-p'].forEach(id => {
    const el = document.getElementById(id); if(el) el.textContent = '';
  });
  const shDiv = document.getElementById('arch-stage-health');
  if(shDiv) shDiv.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px;grid-column:1/-1">Initialize model for stage health</div>';
  const tbody = document.querySelector('#arch-mod-tbl tbody');
  if(tbody) tbody.innerHTML = '<tr><td colspan="8" style="color:var(--text3)">Initialize model to see modules</td></tr>';
  const summary = document.getElementById('arch-summary');
  if(summary) summary.textContent = 'Initialize model first';
  _archData = null;
}

function toggleArchAutoRefresh() {
  const on = document.getElementById('arch-auto-refresh')?.checked;
  if (_archAutoRefreshTimer) { clearInterval(_archAutoRefreshTimer); _archAutoRefreshTimer = null; }
  if (on && S.modelReady) _archAutoRefreshTimer = setInterval(loadArch, 5000);
}

function fmtP(n) {
  if (n == null) return '‚Äî';
  return n > 1e6 ? (n/1e6).toFixed(2)+'M' : n > 1e3 ? (n/1e3).toFixed(1)+'K' : n.toLocaleString();
}

function archShowDetail(name) {
  if (!_archData) return;
  const m = (_archData.modules || []).find(x => x.name === name);
  if (!m) return;
  const card = document.getElementById('arch-detail-card');
  card.style.display = '';
  document.getElementById('arch-detail-title').textContent = `${m.name} (${m.type})`;
  const ws = m.weight_stats || {};
  const gs = m.grad_stats || {};
  document.getElementById('arch-detail-content').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px">
      <div><span style="color:var(--text3)">Params:</span> <span style="color:var(--accent)">${fmtP(m.params)}</span></div>
      <div><span style="color:var(--text3)">Trainable:</span> <span style="color:var(--green)">${fmtP(m.trainable)}</span></div>
      <div><span style="color:var(--text3)">Frozen:</span> <span style="color:var(--text3)">${fmtP(m.frozen)}</span></div>
      <div><span style="color:var(--text3)">Memory:</span> <span style="color:var(--purple)">${m.memory_mb?.toFixed(2)} MB</span></div>
      <div><span style="color:var(--text3)">Device:</span> <span style="color:var(--text2)">${m.device||'‚Äî'}</span></div>
      <div><span style="color:var(--text3)">Submodules:</span> <span style="color:var(--text2)">${m.sub_count||0}</span></div>
      <div><span style="color:var(--text3)">NaN:</span> ${m.has_nan?'<span style="color:var(--danger)">YES ‚ö†</span>':'<span style="color:var(--green)">No</span>'}</div>
      <div><span style="color:var(--text3)">Inf:</span> ${m.has_inf?'<span style="color:var(--danger)">YES ‚ö†</span>':'<span style="color:var(--green)">No</span>'}</div>
    </div>
    ${Object.keys(ws).length ? `<div style="margin-bottom:8px"><strong style="color:var(--text2)">Weight Stats:</strong>
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:4px;font-size:10px">
        <div><span style="color:var(--text3)">mean:</span> <span style="color:var(--accent)">${ws.mean}</span></div>
        <div><span style="color:var(--text3)">std:</span> <span style="color:var(--accent)">${ws.std}</span></div>
        <div><span style="color:var(--text3)">min:</span> <span style="color:var(--accent)">${ws.min}</span></div>
        <div><span style="color:var(--text3)">max:</span> <span style="color:var(--accent)">${ws.max}</span></div>
        <div><span style="color:var(--text3)">L2:</span> <span style="color:var(--accent)">${ws.l2_norm}</span></div>
        <div><span style="color:var(--text3)">sparsity:</span> <span style="color:var(--accent)">${(ws.sparsity*100).toFixed(1)}%</span></div>
      </div>
    </div>` : ''}
    ${Object.keys(gs).length ? `<div><strong style="color:var(--text2)">Gradient Stats:</strong>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:4px;font-size:10px">
        <div><span style="color:var(--text3)">‚Äñgrad‚Äñ:</span> <span style="color:var(--green)">${gs.norm}</span></div>
        <div><span style="color:var(--text3)">mean:</span> <span style="color:var(--green)">${gs.mean}</span></div>
        <div><span style="color:var(--text3)">std:</span> <span style="color:var(--green)">${gs.std}</span></div>
        <div><span style="color:var(--text3)">max|g|:</span> <span style="color:var(--green)">${gs.max_abs}</span></div>
        <div><span style="color:var(--text3)">grad NaN:</span> ${gs.has_nan?'<span style="color:var(--danger)">YES</span>':'<span style="color:var(--green)">No</span>'}</div>
      </div>
    </div>` : '<div style="color:var(--text3)">No gradients available (run training first)</div>'}
  `;
}

async function loadArch() {
  try {
    const d = await api('GET', '/api/architecture');
    _archData = d;
    document.getElementById('arch-summary').textContent = d.summary || '‚Äî';
    const cfg = d.config || {};
    document.getElementById('a-enc').textContent = cfg.encoder_backend?.toUpperCase() || '‚Äî';
    document.getElementById('a-dec').textContent = cfg.decoder_backend?.toUpperCase() || '‚Äî';
    document.getElementById('a-vq').textContent = `${cfg.vq_num_embeddings?.toLocaleString() || '‚Äî'} codes`;
    document.getElementById('a-ml').textContent = `Banach FP ¬∑ ${cfg.max_iterations || '?'} iter`;
    document.getElementById('a-out').textContent = `[B,${cfg.seq_length||'?'},${cfg.vocab_size||'V'}]`;

    // Summary cards
    document.getElementById('arch-total-params').textContent = fmtP(d.total_parameters);
    document.getElementById('arch-train-params').textContent = fmtP(d.trainable_parameters);
    document.getElementById('arch-frozen-params').textContent = fmtP(d.frozen_parameters);
    document.getElementById('arch-total-mem').textContent = d.total_memory_mb ? d.total_memory_mb.toFixed(1)+' MB' : '‚Äî';

    // Per-node param annotations
    const modules = d.modules || [];
    const modMap = {};
    modules.forEach(m => modMap[m.name] = m);
    if(modMap.encoder) { const el = document.getElementById('a-enc-p'); if(el) el.textContent = fmtP(modMap.encoder.params); }
    if(modMap.vector_quantizer) { const el = document.getElementById('a-vq-p'); if(el) el.textContent = fmtP(modMap.vector_quantizer.params); }
    if(modMap.meta_loop) { const el = document.getElementById('a-ml-p'); if(el) el.textContent = fmtP(modMap.meta_loop.params); }
    if(modMap.decoder) { const el = document.getElementById('a-dec-p'); if(el) el.textContent = fmtP(modMap.decoder.params); }

    // Update pipeline node health indicators
    const stageHealth = d.stage_health || {};
    const nodeMap = {
      'encoder': 'arch-n-encoder', 'vector_quantizer': 'arch-n-vq',
      'meta_loop': 'arch-n-meta', 'memory_manager': 'arch-n-memory',
      'causal_model': 'arch-n-causal', 'safety_system': 'arch-n-safety',
      'decoder': 'arch-n-decoder', 'embedding': 'arch-n-input',
    };
    for (const [modName, nodeId] of Object.entries(nodeMap)) {
      const node = document.getElementById(nodeId);
      if (!node) continue;
      const pulse = node.querySelector('.arch-pulse');
      if (!pulse) continue;
      const sh = stageHealth[modName];
      if (sh) {
        const cls = sh.healthy ? 'ok' : (sh.has_nan || sh.has_inf ? 'err' : 'warn');
        pulse.className = 'arch-pulse ' + cls;
      }
    }

    // Module table (extended)
    const total = d.total_parameters || 1;
    const tbody = document.querySelector('#arch-mod-tbl tbody');
    tbody.innerHTML = modules.map(m => {
      const healthBadge = m.has_nan ? '<span class="badge br">NaN</span>' :
                          m.has_inf ? '<span class="badge br">Inf</span>' :
                          '<span class="badge bg">OK</span>';
      return `<tr style="cursor:pointer" onclick="archShowDetail('${m.name}')">
        <td style="color:var(--accent)">${m.name}</td>
        <td style="color:var(--purple);font-size:10px">${m.type}</td>
        <td style="font-family:var(--display);color:var(--text)">${fmtP(m.params)}</td>
        <td style="font-size:10px;color:var(--text3)">${m.memory_mb?.toFixed(2)} MB</td>
        <td style="font-family:var(--display);color:${m.grad_norm != null ? 'var(--green)' : 'var(--text3)'}">${m.grad_norm != null ? m.grad_norm.toFixed(4) : '‚Äî'}</td>
        <td style="font-size:10px;color:var(--text3)">${m.device||'‚Äî'}</td>
        <td>${healthBadge}</td>
        <td><div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:4px;background:var(--surface3);border-radius:2px"><div style="height:100%;background:var(--accent);border-radius:2px;width:${(m.params/total*100).toFixed(1)}%"></div></div><span style="font-size:10px;color:var(--text3)">${(m.params/total*100).toFixed(1)}%</span></div></td>
      </tr>`;
    }).join('');

    // Pipeline Stage Health overview
    const shDiv = document.getElementById('arch-stage-health');
    const shEntries = Object.entries(stageHealth);
    if (shEntries.length) {
      shDiv.innerHTML = shEntries.map(([k, sh]) => {
        const clr = sh.healthy ? 'var(--green)' : 'var(--danger)';
        const icon = sh.healthy ? '‚úì' : (sh.has_nan ? '‚ö† NaN' : sh.has_inf ? '‚ö† Inf' : '‚ö†');
        return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px">${sh.label || k}</div>
          <div style="font-size:14px;font-weight:700;color:${clr}">${icon}</div>
          <div style="font-size:9px;color:var(--text3);margin-top:4px">${fmtP(sh.params)} ¬∑ ${sh.memory_mb?.toFixed(1)} MB</div>
        </div>`;
      }).join('');
    }
  } catch(e) { log('ERROR', 'arch', e.message); }
}

// ‚îÄ‚îÄ‚îÄ MODULE INSPECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadModules() {
  try {
    const d = await api('GET', '/api/introspect/modules');
    const total = d.total_parameters || 0;
    const trainable = d.modules?.reduce((s, m) => s + (m.trainable||0), 0) || 0;
    const frozen = total - trainable;
    document.getElementById('mi-total').textContent = total > 1e6 ? (total/1e6).toFixed(2)+'M' : total.toLocaleString();
    document.getElementById('mi-train').textContent = trainable > 1e6 ? (trainable/1e6).toFixed(2)+'M' : trainable.toLocaleString();
    document.getElementById('mi-frozen').textContent = frozen > 1e6 ? (frozen/1e6).toFixed(2)+'M' : frozen.toLocaleString();
    document.getElementById('mi-count').textContent = (d.modules || []).length;

    // Draw chart
    drawModChart(d.modules || [], total);

    // Module list
    const list = document.getElementById('mod-list');
    list.innerHTML = (d.modules || []).map((m, i) => {
      const ws = m.weight_stats || {};
      const pct = total > 0 ? (m.params/total*100).toFixed(1) : '0.0';
      const hasNaN = ws.has_nan ? '<span class="badge br" style="margin-left:6px">NaN!</span>' : '';
      const hasInf = ws.has_inf ? '<span class="badge br" style="margin-left:6px">Inf!</span>' : '';
      return `<div class="mod-row" onclick="toggleModDetail(${i})">
        <div class="mod-header">
          <span style="font-size:10px;color:var(--text3);width:20px">${i+1}</span>
          <span class="mod-name">${m.name}${hasNaN}${hasInf}</span>
          <span class="mod-type">${m.type}</span>
          <span class="mod-params">${m.params?.toLocaleString()}</span>
          <span style="font-size:10px;color:var(--text3);margin-left:8px">${pct}%</span>
        </div>
        <div class="mod-sub" id="mod-sub-${i}">
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px">
            <div class="mod-stat">mean: <span>${ws.mean||'?'}</span></div>
            <div class="mod-stat">std: <span>${ws.std||'?'}</span></div>
            <div class="mod-stat">min: <span>${ws.min||'?'}</span></div>
            <div class="mod-stat">max: <span>${ws.max||'?'}</span></div>
            <div class="mod-stat">L2: <span>${ws.l2_norm||'?'}</span></div>
            <div class="mod-stat">trainable: <span style="color:var(--green)">${m.trainable?.toLocaleString()}</span></div>
            <div class="mod-stat">frozen: <span style="color:var(--text3)">${m.frozen?.toLocaleString()}</span></div>
          </div>
          ${m.submodules?.length ? `<div style="font-size:10px;color:var(--text3)">Submodules: ${m.submodules.map(s=>`${s.name}(${s.type}):${s.params?.toLocaleString()}`).join(' ¬∑ ')}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  } catch(e) { log('ERROR', 'modules', e.message); }
}

function toggleModDetail(i) {
  const sub = document.getElementById(`mod-sub-${i}`);
  if(sub) sub.style.display = sub.style.display === 'block' ? 'none' : 'block';
}

function drawModChart(modules, total) {
  const canvas = document.getElementById('mod-chart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 600, H = 120;
  canvas.width = W; canvas.height = H;
  if(!modules.length) return;
  ctx.clearRect(0,0,W,H);
  const top = modules.slice(0,10);
  const bw = W / top.length;
  const maxP = Math.max(...top.map(m => m.params));
  const colors = ['#00d4ff','#7c3aed','#10b981','#f59e0b','#ef4444','#06b6d4','#8b5cf6','#34d399','#fbbf24','#f87171'];
  top.forEach((m, i) => {
    const h = (m.params / maxP) * (H - 30);
    const x = i * bw;
    ctx.fillStyle = colors[i % colors.length] + '88';
    ctx.fillRect(x+4, H-h-20, bw-8, h);
    ctx.fillStyle = colors[i % colors.length];
    ctx.font = '9px JetBrains Mono';
    ctx.fillText(m.name.slice(0,10), x+4, H-8);
    const pct = (m.params/total*100).toFixed(0);
    ctx.fillStyle = '#94a3b8';
    ctx.fillText(pct+'%', x+4, H-h-22);
  });
}

// ‚îÄ‚îÄ‚îÄ INFERENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runInfer() {
  if(!S.modelReady) { log('WARN','infer','Model not initialized'); return; }
  const btn = document.getElementById('i-run-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Generating...';
  document.getElementById('i-out').innerHTML = '<span class="cursor"></span>';
  try {
    const d = await api('POST', '/api/infer', {
      prompt: document.getElementById('i-prompt').value,
      max_length: parseInt(document.getElementById('i-maxlen').value),
      temperature: parseFloat(document.getElementById('i-temp').value),
      top_k: parseInt(document.getElementById('i-topk').value),
      top_p: parseFloat(document.getElementById('i-topp').value),
      fast: document.getElementById('i-fast').checked,
    });
    document.getElementById('i-out').textContent = d.text || '(no output)';
    document.getElementById('im-tok').textContent = d.tokens || '‚Äî';
    document.getElementById('im-time').textContent = d.elapsed_ms ? d.elapsed_ms+'ms' : '‚Äî';
    document.getElementById('im-tps').textContent = d.tokens_per_sec || '‚Äî';
    document.getElementById('im-status').textContent = d.status || '‚Äî';
    document.getElementById('i-status-line').textContent = `status=${d.status} ¬∑ reason=${d.reason||'ok'}`;

    // TG
    if(d.tensorguard) {
      document.getElementById('tg-nan-live').textContent = d.tensorguard.nan_count||0;
      document.getElementById('tg-inf-live').textContent = d.tensorguard.inf_count||0;
      document.getElementById('tg-san-live').textContent = d.tensorguard.sanitize_count||0;
    }
    // Audit
    const audit = d.audit || {};
    const ts = (audit.info||0)+(audit.warning||0)+(audit.critical||0);
    document.getElementById('i-audit').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
        <div><div style="font-size:10px;color:var(--text3)">Total</div><div style="font-family:var(--display);color:var(--accent)">${ts}</div></div>
        <div><div style="font-size:10px;color:var(--text3)">Info</div><div style="font-family:var(--display);color:var(--green)">${audit.info||0}</div></div>
        <div><div style="font-size:10px;color:var(--text3)">Warnings</div><div style="font-family:var(--display);color:var(--warn)">${audit.warning||0}</div></div>
        <div><div style="font-size:10px;color:var(--text3)">Critical</div><div style="font-family:var(--display);color:var(--danger)">${audit.critical||0}</div></div>
      </div>`;
  } catch(e) {
    document.getElementById('i-out').textContent = '‚úï ' + e.message;
    document.getElementById('i-out').style.color = 'var(--danger)';
  } finally {
    btn.disabled = false; btn.innerHTML = '‚ñ∂ Generate';
    document.getElementById('i-out').style.color = '';
  }
}

async function runFwd() {
  if(!S.modelReady) { log('WARN','infer','Model not initialized'); return; }
  try {
    const idsStr = document.getElementById('i-fwd-ids').value;
    const ids = idsStr.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
    const d = await api('POST', '/api/forward', { input_ids: ids, fast: document.getElementById('i-fwd-fast').checked });
    document.getElementById('fwd-out').style.display = 'block';
    document.getElementById('fwd-keys').innerHTML = (d.output_keys||[]).map(k => `<span class="badge ba">${k}</span>`).join(' ');
    const safety = d.safety_score;
    document.getElementById('fwd-safety').textContent = safety !== null ? safety?.toFixed(4) : '‚Äî';
    document.getElementById('fwd-safety').style.color = safety >= 0.8 ? 'var(--green)' : safety >= 0.5 ? 'var(--warn)' : 'var(--danger)';
    document.getElementById('fwd-delta').textContent = d.convergence_delta?.toFixed(6) || '‚Äî';
    document.getElementById('fwd-time').textContent = d.elapsed_ms ? d.elapsed_ms + 'ms' : '‚Äî';
    if(d.top5_tokens) {
      document.getElementById('fwd-top5').textContent = d.top5_tokens.map((t,i) => `[${t}] ${(d.top5_probs[i]*100).toFixed(1)}%`).join('  ');
    }
  } catch(e) { log('ERROR','forward', e.message); }
}

async function runBatch() {
  if(!S.modelReady) return;
  const btn = document.getElementById('i-batch-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  const prompts = document.getElementById('i-batch-prompts').value.split('\n').filter(p => p.trim());
  const out = document.getElementById('i-batch-out');
  out.innerHTML = '';
  for(const prompt of prompts) {
    if(!prompt.trim()) continue;
    try {
      const d = await api('POST', '/api/infer', {
        prompt, max_length: parseInt(document.getElementById('i-maxlen').value),
        temperature: parseFloat(document.getElementById('i-temp').value),
        top_k: parseInt(document.getElementById('i-topk').value), fast: true,
      });
      out.innerHTML += `<div style="border-bottom:1px solid var(--border);padding:6px 0;margin-bottom:6px">
        <div style="color:var(--accent);font-size:10px;margin-bottom:3px">‚ñ∂ ${prompt.slice(0,60)}</div>
        <div style="color:var(--text2)">${d.text || '‚Äî'}</div>
        <div style="color:var(--text3);font-size:9px;margin-top:2px">${d.tokens} tok ¬∑ ${d.elapsed_ms}ms ¬∑ ${d.tokens_per_sec} tok/s</div>
      </div>`;
    } catch(e) {
      out.innerHTML += `<div style="color:var(--danger);padding:4px 0">‚úï ${prompt.slice(0,40)}: ${e.message}</div>`;
    }
  }
  btn.disabled = false; btn.innerHTML = '‚ñ∂‚ñ∂ Run Batch';
}

function clearInfer() {
  document.getElementById('i-out').innerHTML = '<span style="color:var(--text3)">Output will appear here...</span>';
  document.getElementById('i-status-line').textContent = '';
  document.getElementById('fwd-out').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ AEON v4 TRAINING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const V4 = {
  sse: null,
  pollTimer: null,
  metricsA: { total: [], recon: [], vq: [], codebook: [], accuracy: [], grad_norm: [] },
  metricsB: { mse: [], cosine: [], grad_norm: [] },
  logs: [],
  filterLevel: '',
};

async function v4Init() {
  try {
    const d = await api('GET', '/api/train/v4/progress');
    const aeEl = document.getElementById('v4-ae-status');
    if (aeEl) {
      if (d.ae_train_available) {
        aeEl.innerHTML = '<span style="color:var(--green)">‚úÖ ae_train.py loaded ‚Äî v4 training available</span>';
      } else {
        aeEl.innerHTML = `<span style="color:var(--warn)">‚ö†Ô∏è ae_train.py not loaded: ${d.ae_train_error||'unknown error'}</span>`;
      }
    }
    if (d.active) { v4ShowActive(); v4StartSSE(); }
    else if (d.progress?.done) { v4ShowDone(d.progress); }
  } catch(e) {}
  v4RefreshFiles();
}

async function v4RefreshFiles() {
  try {
    const d = await api('GET', '/api/train/v4/files');
    const el = document.getElementById('v4-file-list');
    if (!el) return;
    if (!d.files || !d.files.length) {
      el.innerHTML = '<div style="color:var(--text3);font-size:11px">No files uploaded yet.</div>';
      return;
    }
    el.innerHTML = d.files.map(f => `
      <div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
        <span style="flex:1;cursor:pointer;color:var(--accent)" onclick="v4SelectFile('${f.path}')" title="Click to select">${f.name}</span>
        <span style="color:var(--text3);font-size:10px">${f.size_kb}KB</span>
        <button onclick="v4DeleteFile('${f.name}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:12px;padding:0 2px">‚úï</button>
      </div>`).join('');
  } catch(e) {}
}

function v4SelectFile(path) {
  const el = document.getElementById('v4-json-path');
  if (el) el.value = path;
  log('INFO', 'v4', `Training file selected: ${path}`);
}

async function v4DeleteFile(name) {
  if (!confirm(`Delete training file: ${name}?`)) return;
  try {
    await api('DELETE', `/api/train/v4/files/${encodeURIComponent(name)}`);
    v4RefreshFiles();
    log('INFO', 'v4', `File deleted: ${name}`);
  } catch(e) { log('ERROR', 'v4', `Delete failed: ${e.message}`); }
}

async function v4HandleDrop(e) {
  e.preventDefault();
  document.getElementById('v4-drop').style.borderColor = 'var(--border)';
  const file = e.dataTransfer.files[0];
  if (file) await v4UploadFile(file);
}

async function v4UploadFile(file) {
  if (!file) return;
  log('INFO', 'v4', `Uploading ${file.name} (${(file.size/1024).toFixed(1)} KB)‚Ä¶`);
  try {
    const fd = new FormData();
    fd.append('file', file);
    const resp = await fetch('/api/train/v4/upload', { method: 'POST', body: fd });
    const d = await resp.json();
    if (d.ok) {
      log('INFO', 'v4', `‚úÖ Uploaded: ${d.name} ‚Üí ${d.path}`);
      document.getElementById('v4-json-path').value = d.path;
      v4RefreshFiles();
    } else {
      log('ERROR', 'v4', `Upload failed: ${JSON.stringify(d)}`);
    }
  } catch(e) { log('ERROR', 'v4', `Upload error: ${e.message}`); }
}

async function v4Start() {
  const jsonPath = document.getElementById('v4-json-path').value.trim();
  if (!jsonPath) { log('WARN', 'v4', 'Select a training file first'); return; }

  const req = {
    json_path:         jsonPath,
    output_dir:        document.getElementById('v4-out-dir').value || './processed_v4/',
    resume_from:       document.getElementById('v4-resume').value.trim() || '',
    epochs_A:          parseInt(document.getElementById('v4-ep-a').value) || 30,
    epochs_B:          parseInt(document.getElementById('v4-ep-b').value) || 10,
    learning_rate:     parseFloat(document.getElementById('v4-lr').value),
    batch_size:        parseInt(document.getElementById('v4-bs').value),
    grad_clip:         parseFloat(document.getElementById('v4-gc').value),
    warmup_steps:      parseInt(document.getElementById('v4-ws').value),
    entropy_weight:    parseFloat(document.getElementById('v4-ew').value),
    context_window:    parseInt(document.getElementById('v4-cw').value),
    z_dim:             parseInt(document.getElementById('v4-zdim').value),
    hidden_dim:        parseInt(document.getElementById('v4-hidden').value) || 256,
    vq_num_embeddings: parseInt(document.getElementById('v4-vqn').value),
    num_pillars:       parseInt(document.getElementById('v4-pillars').value) || 5,
    seq_length:        parseInt(document.getElementById('v4-seqlen').value) || 64,
    document_aware:    document.getElementById('v4-docaware').checked,
    use_amp:           document.getElementById('v4-amp').checked,
    seed:              parseInt(document.getElementById('v4-seed').value),
    // Advanced: VQ-VAE
    vq_commitment_cost: parseFloat(document.getElementById('v4-vq-commit').value),
    vq_loss_weight:     parseFloat(document.getElementById('v4-vq-lw').value),
    vq_ema_decay:       parseFloat(document.getElementById('v4-vq-ema').value),
    vq_temperature:     parseFloat(document.getElementById('v4-vq-temp').value),
    vq_reset_threshold: parseInt(document.getElementById('v4-vq-reset').value),
    // Advanced: RSSM & Optimiser
    rssm_hidden_dim:    parseInt(document.getElementById('v4-rssm-hdim').value),
    min_learning_rate:  parseFloat(document.getElementById('v4-min-lr').value),
    weight_decay:       parseFloat(document.getElementById('v4-wd').value),
    gradient_accumulation_steps: parseInt(document.getElementById('v4-gas').value),
    min_doc_chunks:     parseInt(document.getElementById('v4-min-doc').value),
    // Advanced: Regularisation & Early Stopping
    dropout_rate:       parseFloat(document.getElementById('v4-dropout').value),
    label_smoothing:    parseFloat(document.getElementById('v4-labsm').value),
    early_stopping_patience: parseInt(document.getElementById('v4-es-pat').value),
    min_delta:          parseFloat(document.getElementById('v4-min-delta').value),
    save_every_n_epochs: parseInt(document.getElementById('v4-save-n').value),
    keep_n_checkpoints: parseInt(document.getElementById('v4-keep-n').value),
  };

  // Reset chart data
  V4.metricsA = { total: [], recon: [], vq: [], codebook: [], accuracy: [], grad_norm: [] };
  V4.metricsB = { mse: [], cosine: [], grad_norm: [] };
  V4.logs = [];
  v4ClearLogs();

  try {
    await api('POST', '/api/train/v4/start', req);
    log('INFO', 'v4', `üöÄ v4 Training started ¬∑ epochsA=${req.epochs_A} ¬∑ epochsB=${req.epochs_B}`);
    v4ShowActive();
    v4StartSSE();
  } catch(e) {
    log('ERROR', 'v4', `Start failed: ${e.message}`);
  }
}

async function v4Stop() {
  try {
    await api('POST', '/api/train/v4/stop');
    log('INFO', 'v4', 'üõë Stop signal sent');
  } catch(e) {}
}

function v4ShowActive() {
  document.getElementById('v4-start-btn').style.display = 'none';
  document.getElementById('v4-stop-btn').style.display = '';
  document.getElementById('v4-idle').style.display = 'none';
  document.getElementById('v4-active').style.display = 'block';
  document.getElementById('v4-done').style.display = 'none';
}

function v4ShowIdle() {
  document.getElementById('v4-start-btn').style.display = '';
  document.getElementById('v4-stop-btn').style.display = 'none';
  document.getElementById('v4-idle').style.display = 'block';
  document.getElementById('v4-active').style.display = 'none';
}

function v4ShowDone(prog) {
  v4ShowIdle();
  document.getElementById('v4-done').style.display = 'block';
  const elapsed = prog.elapsed_s ? `${Math.floor(prog.elapsed_s/60)}m ${Math.round(prog.elapsed_s%60)}s` : '‚Äî';
  document.getElementById('v4-done-detail').innerHTML =
    `Phase A best loss: <b>${(prog.final_loss_A??'‚Äî')}</b> &nbsp;|&nbsp; ` +
    `Phase B best MSE: <b>${(prog.final_loss_B??'‚Äî')}</b> &nbsp;|&nbsp; ` +
    `Codebook: <b>${(prog.codebook_usage??'‚Äî')}%</b> &nbsp;|&nbsp; ` +
    `Total time: <b>${elapsed}</b><br>` +
    (prog.final_model_path ? `Model saved: <code style="color:var(--green)">${prog.final_model_path}</code>` : '');
}

function v4StartSSE() {
  if (V4.sse) { V4.sse.close(); }
  V4.sse = new EventSource('/api/train/v4/stream');
  V4.sse.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'log')      v4HandleLog(msg.data);
      if (msg.type === 'progress') v4HandleProgress(msg.data);
      if (msg.type === 'metrics')  v4HandleMetrics(msg.data);
      if (msg.type === 'done')     { v4ShowDone(msg.data); V4.sse.close(); }
    } catch(_) {}
  };
  V4.sse.onerror = () => {};
}

function v4HandleLog(entry) {
  V4.logs.push(entry);
  if (V4.logs.length > 5000) V4.logs.shift();
  const lvl = entry.level || 'INFO';
  if (V4.filterLevel && lvl !== V4.filterLevel) return;
  const colors = { INFO: 'var(--text2)', WARNING: 'var(--warn)', ERROR: 'var(--danger)', DEBUG: 'var(--text3)' };
  const c = document.getElementById('v4-log-console');
  if (!c) return;
  const div = document.createElement('div');
  div.style.cssText = `color:${colors[lvl]||'var(--text2)'}`;
  div.textContent = `[${entry.time}] ${lvl.padEnd(7)} ${entry.msg}`;
  // Remove placeholder
  const ph = c.querySelector('div[style*="var(--text3)"]');
  if (ph && ph.textContent.includes('Training logs')) ph.remove();
  c.appendChild(div);
  if (document.getElementById('v4-autoscroll')?.checked) c.scrollTop = c.scrollHeight;
}

function v4HandleProgress(prog) {
  if (!prog) return;
  const phase = prog.phase || 'init';
  const epoch = prog.epoch || 0;
  const total = prog.total_epochs || 1;
  const pct = total > 0 ? Math.round(Math.min(epoch / total, 1) * 100) : 0;

  // Phase indicator
  const phA = document.getElementById('v4-ph-a');
  const phB = document.getElementById('v4-ph-b');
  if (phA && phB) {
    const isA = phase === 'phase_A' || phase === 'init' || phase === 'data_loading' || phase === 'model_init' || phase === 'encoding';
    phA.style.background = isA ? 'var(--accent)' : 'var(--surface3)';
    phA.style.color = isA ? '#000' : 'var(--text2)';
    phB.style.background = phase === 'phase_B' ? 'var(--purple)' : 'var(--surface3)';
    phB.style.color = phase === 'phase_B' ? '#fff' : 'var(--text2)';
  }

  const phLabel = { init:'Initialising‚Ä¶', data_loading:'Loading data‚Ä¶', model_init:'Building model‚Ä¶',
    encoding:'Encoding z_sequences‚Ä¶', phase_A:'Phase A running‚Ä¶', phase_B:'Phase B running‚Ä¶',
    saving:'Saving model‚Ä¶', complete:'Complete', error:'Error', starting:'Starting‚Ä¶' };
  const lbl = document.getElementById('v4-phase-lbl');
  if (lbl) lbl.textContent = phLabel[phase] || phase;

  const epochLbl = document.getElementById('v4-epoch-lbl');
  if (epochLbl) epochLbl.textContent = `Epoch ${epoch}/${total}`;
  const pctEl = document.getElementById('v4-pct');
  if (pctEl) pctEl.textContent = pct + '%';
  const progFill = document.getElementById('v4-prog');
  if (progFill) progFill.style.width = pct + '%';

  if (prog.current_loss !== null && prog.current_loss !== undefined) {
    const lossEl = document.getElementById('v4-loss');
    if (lossEl) lossEl.textContent = typeof prog.current_loss === 'number' ? prog.current_loss.toFixed(5) : prog.current_loss;
  }
  if (prog.best_loss !== null && prog.best_loss !== undefined) {
    const bestEl = document.getElementById('v4-best');
    if (bestEl) bestEl.textContent = typeof prog.best_loss === 'number' ? prog.best_loss.toFixed(5) : prog.best_loss;
  }
  if (prog.codebook_usage !== null && prog.codebook_usage !== undefined) {
    const cbEl = document.getElementById('v4-cb');
    if (cbEl) cbEl.textContent = prog.codebook_usage.toFixed(1) + '%';
  }
  // Elapsed
  if (prog.started_at) {
    const secs = Math.floor(Date.now()/1000 - prog.started_at);
    const elapsed = secs < 60 ? secs+'s' : Math.floor(secs/60)+'m '+( secs%60)+'s';
    const elEl = document.getElementById('v4-elapsed');
    if (elEl) elEl.textContent = elapsed;
  }

  // Convergence status
  const convColors = { warmup:'var(--text3)', converging:'var(--accent)', converged:'var(--green)', stagnating:'var(--warn)', diverging:'var(--danger)' };
  const convEl = document.getElementById('v4-conv-status');
  if (convEl && prog.convergence_status) {
    convEl.textContent = prog.convergence_status;
    convEl.style.color = convColors[prog.convergence_status] || 'var(--text2)';
  }
  const velEl = document.getElementById('v4-conv-vel');
  if (velEl && prog.convergence_velocity !== undefined && prog.convergence_velocity !== null) {
    const v = prog.convergence_velocity;
    velEl.textContent = (v >= 0 ? '+' : '') + v.toFixed(6);
    velEl.style.color = v < 0 ? 'var(--green)' : v > 0.01 ? 'var(--danger)' : 'var(--text2)';
  }
  // Gradient norm
  const gnEl = document.getElementById('v4-gnorm');
  if (gnEl && prog.grad_norm !== undefined && prog.grad_norm !== null) {
    gnEl.textContent = prog.grad_norm.toFixed(4);
  }
  // Loss component split
  const splitEl = document.getElementById('v4-loss-split');
  if (splitEl && prog.recon_loss !== undefined && prog.recon_loss !== null) {
    const vqLoss = prog.vq_loss !== undefined && prog.vq_loss !== null ? prog.vq_loss.toFixed(4) : '‚Äî';
    splitEl.textContent = prog.recon_loss.toFixed(4) + ' / ' + vqLoss;
  }
  // Accuracy
  const accEl = document.getElementById('v4-acc');
  if (accEl && prog.accuracy !== undefined && prog.accuracy !== null) {
    accEl.textContent = prog.accuracy.toFixed(1) + '%';
  }

  if (prog.done && !prog.active) {
    v4ShowDone(prog);
    if (V4.sse) V4.sse.close();
  }
}

function v4HandleMetrics(data) {
  // data = { new_A: [{total, recon, vq, codebook_%, accuracy_%, grad_norm},...], new_B: [{mse_loss, cosine_sim, grad_norm},...] }
  const newA = data.new_A || [];
  const newB = data.new_B || [];
  for (const m of newA) {
    if (m.total    !== undefined) V4.metricsA.total.push(m.total);
    if (m.recon    !== undefined) V4.metricsA.recon.push(m.recon);
    if (m.vq       !== undefined) V4.metricsA.vq.push(m.vq);
    if (m['codebook_%'] !== undefined) V4.metricsA.codebook.push(m['codebook_%']);
    if (m['accuracy_%'] !== undefined) V4.metricsA.accuracy.push(m['accuracy_%']);
    if (m.grad_norm !== undefined) V4.metricsA.grad_norm.push(m.grad_norm);
  }
  for (const m of newB) {
    if (m.mse_loss    !== undefined) V4.metricsB.mse.push(m.mse_loss);
    if (m.cosine_sim  !== undefined) V4.metricsB.cosine.push(m.cosine_sim);
    if (m.grad_norm   !== undefined) V4.metricsB.grad_norm.push(m.grad_norm);
  }
  v4DrawCharts();
}

function v4DrawCharts() {
  v4DrawMultiLine('v4-loss-chart-a',
    [V4.metricsA.total, V4.metricsA.recon, V4.metricsA.vq],
    ['var(--accent)', 'var(--purple)', 'var(--green)'],
    'Phase A Loss',
    ['Total', 'Recon', 'VQ']
  );
  v4DrawMultiLine('v4-loss-chart-b',
    [V4.metricsB.mse, V4.metricsB.cosine],
    ['var(--accent)', 'var(--green)'],
    'Phase B',
    ['MSE', 'Cos Sim']
  );
  v4DrawSingleLine('v4-cb-chart', V4.metricsA.codebook, 'var(--purple)', 'Codebook %', 0, 100);
  v4DrawSingleLine('v4-acc-chart', V4.metricsA.accuracy, 'var(--green)', 'Accuracy %', 0, 100);
  v4DrawMultiLine('v4-grad-chart',
    [V4.metricsA.grad_norm, V4.metricsB.grad_norm],
    ['var(--warn)', 'var(--purple)'],
    'Gradient Norms',
    ['Phase A', 'Phase B']
  );
  v4DrawMultiLine('v4-loss-split-chart',
    [V4.metricsA.recon, V4.metricsA.vq],
    ['var(--accent)', 'var(--purple)'],
    'Loss Components',
    ['Recon', 'VQ']
  );
}

function v4DrawMultiLine(canvasId, seriesArr, colors, title, labels) {
  const c = document.getElementById(canvasId);
  if (!c) return;
  const ctx = c.getContext('2d');
  const W = c.offsetWidth || c.width;
  const H = c.height || 140;
  c.width = W; c.height = H;
  ctx.fillStyle = 'var(--bg)';
  ctx.fillRect(0, 0, W, H);
  if (seriesArr.every(s => !s.length)) {
    ctx.fillStyle = '#475569';
    ctx.font = '11px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('No data yet ‚Äî training will populate this chart', W/2, H/2);
    return;
  }
  const allVals = seriesArr.flat().filter(v => isFinite(v));
  if (!allVals.length) return;
  const mn = Math.min(...allVals);
  const mx = Math.max(...allVals);
  const rng = mx - mn || 1;
  const pad = { t: 10, b: 20, l: 45, r: 10 };
  const iW = W - pad.l - pad.r;
  const iH = H - pad.t - pad.b;

  // Grid lines
  ctx.strokeStyle = 'rgba(71,85,105,0.4)';
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + iH * i / 4;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    const val = mx - rng * i / 4;
    ctx.fillStyle = '#94a3b8'; ctx.font = '9px monospace'; ctx.textAlign = 'right';
    ctx.fillText(val < 1 ? val.toFixed(4) : val.toFixed(2), pad.l - 3, y + 3);
  }
  // Series
  seriesArr.forEach((series, si) => {
    if (!series.length) return;
    const maxLen = Math.max(...seriesArr.map(s => s.length), 1);
    ctx.strokeStyle = colors[si]; ctx.lineWidth = 2;
    ctx.beginPath();
    series.forEach((v, i) => {
      const x = pad.l + i / Math.max(maxLen - 1, 1) * iW;
      const y = pad.t + iH - (v - mn) / rng * iH;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
    // Last value dot
    const last = series[series.length - 1];
    const x = pad.l + (series.length - 1) / Math.max(maxLen - 1, 1) * iW;
    const y = pad.t + iH - (last - mn) / rng * iH;
    ctx.fillStyle = colors[si];
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill();
  });
  // X axis
  ctx.fillStyle = '#94a3b8'; ctx.font = '9px monospace'; ctx.textAlign = 'center';
  const maxLen2 = Math.max(...seriesArr.map(s => s.length), 1);
  [0, Math.floor(maxLen2/2), maxLen2-1].forEach(i => {
    const x = pad.l + i / Math.max(maxLen2-1,1) * iW;
    ctx.fillText(`ep${i+1}`, x, H - 4);
  });
}

function v4DrawSingleLine(canvasId, series, color, label, yMin, yMax) {
  const c = document.getElementById(canvasId);
  if (!c) return;
  const ctx = c.getContext('2d');
  const W = c.offsetWidth || c.width;
  const H = c.height || 110;
  c.width = W; c.height = H;
  ctx.fillStyle = 'var(--bg)';
  ctx.fillRect(0, 0, W, H);
  if (!series.length) {
    ctx.fillStyle = '#475569'; ctx.font = '11px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Waiting for data‚Ä¶', W/2, H/2);
    return;
  }
  const mn = yMin !== undefined ? yMin : Math.min(...series);
  const mx = yMax !== undefined ? yMax : Math.max(...series);
  const rng = mx - mn || 1;
  const pad = { t: 8, b: 18, l: 40, r: 8 };
  const iW = W - pad.l - pad.r;
  const iH = H - pad.t - pad.b;
  ctx.strokeStyle = 'rgba(71,85,105,0.3)'; ctx.lineWidth = 0.5;
  [0, 0.5, 1].forEach(f => {
    const y = pad.t + iH * f;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    ctx.fillStyle = '#94a3b8'; ctx.font = '9px monospace'; ctx.textAlign = 'right';
    ctx.fillText((mx - rng * f).toFixed(1), pad.l - 2, y + 3);
  });
  ctx.strokeStyle = color; ctx.lineWidth = 2;
  ctx.beginPath();
  series.forEach((v, i) => {
    const x = pad.l + i / Math.max(series.length - 1, 1) * iW;
    const y = pad.t + iH - (Math.min(Math.max(v, mn), mx) - mn) / rng * iH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
  if (series.length) {
    const last = series[series.length-1];
    ctx.fillStyle = color;
    ctx.font = '10px monospace'; ctx.textAlign = 'left';
    ctx.fillText(last.toFixed(2)+'%', pad.l + iW + 2, pad.t + 10);
  }
}

function v4FilterLogs() {
  V4.filterLevel = document.getElementById('v4-log-lvl').value;
  const c = document.getElementById('v4-log-console');
  if (!c) return;
  c.innerHTML = '';
  const colors = { INFO: 'var(--text2)', WARNING: 'var(--warn)', ERROR: 'var(--danger)', DEBUG: 'var(--text3)' };
  const filtered = V4.filterLevel ? V4.logs.filter(l => l.level === V4.filterLevel) : V4.logs;
  for (const entry of filtered) {
    const div = document.createElement('div');
    div.style.color = colors[entry.level] || 'var(--text2)';
    div.textContent = `[${entry.time}] ${(entry.level||'').padEnd(7)} ${entry.msg}`;
    c.appendChild(div);
  }
  if (!c.children.length) c.innerHTML = '<div style="color:var(--text3)">No logs match filter.</div>';
  c.scrollTop = c.scrollHeight;
}

function v4ClearLogs() {
  V4.logs = [];
  const c = document.getElementById('v4-log-console');
  if (c) c.innerHTML = '<div style="color:var(--text3)">Log cleared.</div>';
}

// Initialise v4 state when training panel is opened
function _v4OnPanelOpen() {
  v4Init();
  setTimeout(v4DrawCharts, 100);
}

// ‚îÄ‚îÄ‚îÄ TRAINING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startTrain() {
  if(!S.modelReady) { log('WARN','train','Model not initialized'); return; }
  const req = {
    num_epochs: parseInt(document.getElementById('t-ep').value),
    learning_rate: parseFloat(document.getElementById('t-lr').value),
    batch_size: parseInt(document.getElementById('t-bs').value),
    gradient_clip_norm: parseFloat(document.getElementById('t-gc').value),
    warmup_steps: parseInt(document.getElementById('t-ws').value),
    checkpoint_dir: document.getElementById('t-ckpt').value,
    log_grad_norms: document.getElementById('t-lgn').checked,
    synthetic_samples: parseInt(document.getElementById('t-synth').value || '256'),
  };
  S.trainHistory = {loss:[], val:[], epochs:[]};
  S.gradHistory = [];
  S.stepLossHistory = [];
  await api('POST', '/api/train/start', req);
  document.getElementById('start-btn').style.display = 'none';
  document.getElementById('stop-btn').style.display = '';
  document.getElementById('t-idle').style.display = 'none';
  document.getElementById('t-active').style.display = 'block';
  log('INFO','train', `Training started ¬∑ ${req.num_epochs} epochs ¬∑ lr=${req.learning_rate}`);
  if(S.trainPollInterval) clearInterval(S.trainPollInterval);
  S.trainPollInterval = setInterval(pollTrain, 1500);
}

async function stopTrain() {
  await api('POST', '/api/train/stop');
  log('INFO','train','Stop requested');
  clearInterval(S.trainPollInterval);
}

async function pollTrain() {
  try {
    const d = await api('GET', '/api/train/progress');
    const p = d.progress || {};
    onTrainProgress(p);
    // Fetch gradient stats
    if(p.active) {
      const gs = await api('GET', '/api/train/gradient_stats?limit=100');
      if(gs.gradient_history?.length) { S.gradHistory = gs.gradient_history; drawGradChart(); }
      if(gs.step_loss_history?.length) { S.stepLossHistory = gs.step_loss_history; drawStepLossChart(); }
    }
    if(p.done || !p.active) {
      clearInterval(S.trainPollInterval);
      document.getElementById('start-btn').style.display = '';
      document.getElementById('stop-btn').style.display = 'none';
      document.getElementById('t-idle').style.display = 'block';
      document.getElementById('t-active').style.display = 'none';
      document.getElementById('t-idle').textContent = `Training complete ¬∑ ${p.epoch||'?'}/${p.total_epochs||'?'} epochs`;
      document.getElementById('t-idle').style.color = 'var(--green)';
    }
  } catch(e) {}
}

function onTrainProgress(p) {
  if(!p || !p.active) return;
  const epoch = p.epoch || 0, total = p.total_epochs || 1;
  const pct = Math.round(epoch / total * 100);
  document.getElementById('t-epoch-lbl').textContent = `Epoch ${epoch}/${total}`;
  document.getElementById('t-pct').textContent = pct + '%';
  document.getElementById('t-prog').style.width = pct + '%';
  if(p.loss !== null && p.loss !== undefined) {
    document.getElementById('t-loss').textContent = typeof p.loss === 'number' ? p.loss.toFixed(4) : p.loss;
    if(!S.trainHistory.loss.length || S.trainHistory.loss[S.trainHistory.loss.length-1] !== p.loss) {
      if(epoch > (S.trainHistory.epochs[S.trainHistory.epochs.length-1]||0)) {
        S.trainHistory.loss.push(p.loss);
        S.trainHistory.val.push(p.val_loss || p.loss);
        S.trainHistory.epochs.push(epoch);
        drawLossChart();
      }
    }
  }
  if(p.val_loss !== null && p.val_loss !== undefined)
    document.getElementById('t-vloss').textContent = typeof p.val_loss === 'number' ? p.val_loss.toFixed(4) : p.val_loss;
  if(p.lr !== null && p.lr !== undefined)
    document.getElementById('t-lr-cur').textContent = typeof p.lr === 'number' ? p.lr.toExponential(2) : p.lr;
  if(p.grad_norm !== null && p.grad_norm !== undefined)
    document.getElementById('t-gnorm').textContent = typeof p.grad_norm === 'number' ? p.grad_norm.toFixed(3) : p.grad_norm;
  updateTrainCLI();
}

function updateTrainCLI() {
  const cli = `python core.py --mode train --epochs ${document.getElementById('t-ep')?.value||10} --batch-size ${document.getElementById('t-bs')?.value||16} --lr ${document.getElementById('t-lr')?.value||'3e-5'}`;
  const el = document.getElementById('t-cli'); if(el) el.textContent = cli;
}

async function saveModel() {
  const path = document.getElementById('ck-path').value;
  const d = await api('POST', '/api/save', {path});
  document.getElementById('ck-result').textContent = d.ok ? `‚úÖ Saved ‚Üí ${path}` : '‚úï Save failed';
  document.getElementById('ck-result').style.color = d.ok ? 'var(--green)' : 'var(--danger)';
}
async function loadModel() {
  const path = document.getElementById('ck-path').value;
  const d = await api('POST', '/api/load', {path});
  document.getElementById('ck-result').textContent = d.ok ? `‚úÖ Loaded ‚Üê ${path}` : '‚úï Load failed';
  document.getElementById('ck-result').style.color = d.ok ? 'var(--green)' : 'var(--danger)';
}

// ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkChart(canvas, options) {
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 600;
  const H = canvas.height || 150;
  canvas.width = W;
  ctx.clearRect(0,0,W,H);
  return {ctx, W, H};
}

function drawLine(ctx, points, color, W, H, padL=40, padB=25, padR=20, padT=10) {
  if(!points.length) return;
  const minV = Math.min(...points);
  const maxV = Math.max(...points);
  const range = maxV - minV || 1;
  const scaleX = (W - padL - padR) / (points.length - 1 || 1);
  const scaleY = (H - padT - padB) / range;
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  points.forEach((v, i) => {
    const x = padL + i * scaleX;
    const y = H - padB - (v - minV) * scaleY;
    if(!i) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  // Gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, H - padB);
  grad.addColorStop(0, color + '44'); grad.addColorStop(1, color + '00');
  ctx.beginPath();
  ctx.fillStyle = grad;
  points.forEach((v, i) => {
    const x = padL + i * scaleX;
    const y = H - padB - (v - minV) * scaleY;
    if(!i) ctx.moveTo(x, H-padB);
    ctx.lineTo(x, y);
  });
  ctx.lineTo(padL + (points.length-1)*scaleX, H-padB);
  ctx.closePath();
  ctx.fill();
  // Axis
  ctx.strokeStyle = '#1e2535'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();
  ctx.fillStyle = '#64748b'; ctx.font = '9px monospace';
  ctx.fillText(maxV.toFixed(3), 2, padT+8);
  ctx.fillText(minV.toFixed(3), 2, H-padB);
}

function drawLossChart() {
  const canvas = document.getElementById('loss-chart');
  if(!canvas) return;
  const {ctx, W, H} = mkChart(canvas, {});
  ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
  if(S.trainHistory.loss.length > 1) {
    drawLine(ctx, S.trainHistory.loss, '#00d4ff', W, H);
    drawLine(ctx, S.trainHistory.val, '#7c3aed', W, H);
    // Legend
    ctx.fillStyle = '#00d4ff'; ctx.fillRect(W-100, 5, 12, 3);
    ctx.fillStyle = '#94a3b8'; ctx.font = '9px monospace'; ctx.fillText('train', W-85, 10);
    ctx.fillStyle = '#7c3aed'; ctx.fillRect(W-40, 5, 12, 3);
    ctx.fillStyle = '#94a3b8'; ctx.fillText('val', W-25, 10);
  } else {
    ctx.fillStyle = '#64748b'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Start training to see loss chart', W/2, H/2);
  }
}

function drawGradChart() {
  const canvas = document.getElementById('grad-chart');
  if(!canvas) return;
  const {ctx, W, H} = mkChart(canvas, {});
  ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
  if(S.gradHistory.length > 1) {
    drawLine(ctx, S.gradHistory.map(g => g.grad_norm), '#f59e0b', W, H);
  } else {
    ctx.fillStyle = '#64748b'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Enable log_grad_norms and train', W/2, H/2);
  }
}

function drawStepLossChart() {
  const canvas = document.getElementById('step-loss-chart');
  if(!canvas) return;
  const {ctx, W, H} = mkChart(canvas, {});
  ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
  if(S.stepLossHistory.length > 1) {
    drawLine(ctx, S.stepLossHistory.map(s => s.loss), '#10b981', W, H, 40, 20, 20, 8);
  } else {
    ctx.fillStyle = '#64748b'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Step loss will appear during training', W/2, H/2);
  }
}

function drawHealthChart() {
  const canvas = document.getElementById('health-chart');
  if(!canvas) return;
  const {ctx, W, H} = mkChart(canvas, {});
  ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
  if(S.healthHistory.length > 1) {
    drawLine(ctx, S.healthHistory, '#10b981', W, H);
  } else {
    ctx.fillStyle = '#64748b'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Health history will appear here', W/2, H/2);
  }
}

function drawBenchChart() {
  const canvas = document.getElementById('bench-chart');
  if(!canvas) return;
  const {ctx, W, H} = mkChart(canvas, {});
  ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
  const data = S.benchData?.latency_series || [];
  if(data.length > 1) {
    drawLine(ctx, data, '#00d4ff', W, H);
    // Mean line
    const mean = S.benchData.mean_ms;
    const minV = Math.min(...data), maxV = Math.max(...data), range = maxV-minV||1;
    const y = H - 25 - (mean - minV) / range * (H - 35);
    ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 1; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(W-20, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#ef4444'; ctx.font = '9px monospace';
    ctx.fillText('mean='+mean+'ms', W-80, y-3);
  } else {
    ctx.fillStyle = '#64748b'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
    ctx.fillText('Run benchmark to see latency chart', W/2, H/2);
  }
}

function drawVQCharts() {
  if(!S.vqData) return;
  const norms = S.vqData.embedding_norms || [];
  const counts = S.vqData.usage_counts || [];

  // Norm distribution (histogram)
  const nc = document.getElementById('vq-norm-chart');
  if(nc && norms.length) {
    const {ctx, W, H} = mkChart(nc, {});
    ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
    const bins = 40;
    const mn = Math.min(...norms), mx = Math.max(...norms);
    const bw2 = (mx - mn) / bins;
    const hist = Array(bins).fill(0);
    norms.forEach(v => { const b = Math.min(bins-1, Math.floor((v-mn)/bw2)); hist[b]++; });
    const maxH = Math.max(...hist);
    const bW = (W-60) / bins;
    hist.forEach((v, i) => {
      const bh = (v / maxH) * (H - 35);
      ctx.fillStyle = '#00d4ff88';
      ctx.fillRect(40 + i*bW, H-25-bh, bW-1, bh);
    });
    ctx.fillStyle = '#64748b'; ctx.font = '9px monospace';
    ctx.fillText('Embedding Norms', 42, 12);
    ctx.fillText(mn.toFixed(2), 40, H-12);
    ctx.fillText(mx.toFixed(2), W-50, H-12);
  }

  // Usage distribution
  const uc = document.getElementById('vq-usage-chart');
  if(uc && counts.length) {
    const {ctx, W, H} = mkChart(uc, {});
    ctx.fillStyle = '#0e1220'; ctx.fillRect(0,0,W,H);
    drawLine(ctx, counts, '#7c3aed', W, H);
    ctx.fillStyle = '#64748b'; ctx.font = '9px monospace';
    ctx.fillText('Usage Counts', 42, 12);
  }
}

// ‚îÄ‚îÄ‚îÄ TEST SUITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEST RUNNER v3.3 ‚Äî test_fixes.py integration
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TS = {
  catalogue: [],      // [{section, tests:[{name,line,doc}]}]
  results: [],        // all test result dicts
  summary: {},        // summary dict
  logFormat: 'full',  // 'full' | 'brief'
  activeTab: 'sections',
  pollTimer: null,
  streaming: false,
  filterSection: '',
  filterStatus: '',
  filterSearch: '',
};

// ‚îÄ‚îÄ Format toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsToggleFormat() {
  TS.logFormat = TS.logFormat === 'full' ? 'brief' : 'full';
  document.getElementById('ts-fmt-btn').textContent =
    TS.logFormat === 'full' ? 'üìã Full Log' : 'üìÑ Brief Log';
}

// ‚îÄ‚îÄ Tab navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsTab(name) {
  TS.activeTab = name;
  ['sections','results','log','failures'].forEach(t => {
    document.getElementById(`ts-pane-${t}`).style.display = t === name ? '' : 'none';
    document.getElementById(`ts-tab-${t}`).classList.toggle('active', t === name);
  });
  if (name === 'results') tsFilterResults();
  if (name === 'log')     tsRenderLog();
  if (name === 'failures') tsRenderFailures();
}

// ‚îÄ‚îÄ Load catalogue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tsRefreshCatalogue() {
  try {
    const d = await api('GET', '/api/tests/catalogue');
    if (d.sections) {
      TS.catalogue = d.sections;
      tsBuildCatalogueUI();
      document.getElementById('ts-sub').textContent =
        `${d.total_tests} tests ¬∑ ${d.total_sections} sections`;
      // Populate section filter dropdown
      const sel = document.getElementById('ts-filter-section');
      sel.innerHTML = '<option value="">All sections</option>';
      d.sections.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.section; opt.textContent = g.section.slice(0,50);
        sel.appendChild(opt);
      });
    }
  } catch(e) { log('ERROR','tests', e.message); }
}

function tsBuildCatalogueUI() {
  const cat = TS.catalogue;
  if (!cat.length) {
    document.getElementById('ts-catalogue').innerHTML =
      '<div style="color:var(--text3);font-size:12px">No catalogue data</div>';
    return;
  }
  // Build status map from existing results
  const statusMap = {};
  TS.results.forEach(r => { statusMap[r.name] = r; });

  let out = '';
  cat.forEach((g, gi) => {
    const secId = `ts-sec-${gi}`;
    const tests = g.tests || [];
    let secPass = 0, secFail = 0, secErr = 0, secSkip = 0;
    tests.forEach(t => {
      const rs = statusMap[t.name];
      if (!rs) return;
      if (rs.status === 'passed') secPass++;
      else if (rs.status === 'failed') secFail++;
      else if (rs.status === 'error') secErr++;
      else if (rs.status === 'skipped') secSkip++;
    });
    const total = tests.length;
    const hasFail = secFail + secErr > 0;
    const allPass = secPass === total && total > 0;

    const badge = secPass + secFail + secErr + secSkip > 0
      ? `<span style="font-size:10px;margin-left:6px">`
        + (secPass > 0 ? `<span style="color:var(--green)">‚úÖ${secPass}</span> ` : '')
        + (secFail > 0 ? `<span style="color:var(--danger)">‚ùå${secFail}</span> ` : '')
        + (secErr > 0 ? `<span style="color:var(--warn)">üí•${secErr}</span> ` : '')
        + `</span>` : '';

    out += `<div class="ts-section-hdr ${hasFail ? 'ts-has-failures' : ''}" onclick="tsToggleSec('${secId}')">
      <span style="font-size:10px;color:var(--text3)">${allPass ? '‚úÖ' : (hasFail ? '‚ùå' : '‚óã')}</span>
      <span style="font-size:12px;font-weight:600;flex:1">${g.section}</span>
      ${badge}
      <span style="font-size:10px;color:var(--text3)">${total} tests</span>
      <button class="ts-run-btn-sec" onclick="event.stopPropagation();tsRunSection('${g.section.replace(/'/g,"\\'")}')">‚ñ∂ Run</button>
    </div>
    <div class="ts-section-body" id="${secId}">`;

    tests.forEach(t => {
      const rs = statusMap[t.name];
      const icon = rs ? {passed:'‚úÖ',failed:'‚ùå',error:'üí•',skipped:'‚è≠',running:'‚è≥'}[rs.status]||'?' : '‚óã';
      const ms = rs ? `${rs.elapsed_ms?.toFixed(0)}ms` : '';
      out += `<div class="ts-test-row" onclick="tsShowTestDetail('${t.name}')">
        <span class="ts-status">${icon}</span>
        <span class="ts-name">${t.name}</span>
        <span style="flex:1;font-size:10px;color:var(--text3);padding:0 4px" title="${t.doc}">${t.doc?.slice(0,60) || ''}</span>
        <span class="ts-ms">${ms}</span>
        <button class="ts-run-btn-sec" onclick="event.stopPropagation();tsRunOne('${t.name}')">‚ñ∂</button>
      </div>`;
    });
    out += '</div>';
  });
  document.getElementById('ts-catalogue').innerHTML = out;
}

function tsToggleSec(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

// ‚îÄ‚îÄ Run controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tsRunAll() {
  await tsStartRun({ names: null, section: null });
}
async function tsRunSection(section) {
  await tsStartRun({ names: null, section });
}
async function tsRunOne(name) {
  try {
    log('INFO','tests', `Running single test: ${name}`);
    const d = await api('POST', '/api/tests/run_single', { name, log_format: TS.logFormat });
    if (d.result) {
      // Upsert into TS.results
      const idx = TS.results.findIndex(r => r.name === name);
      if (idx >= 0) TS.results[idx] = d.result;
      else TS.results.push(d.result);
      tsBuildCatalogueUI();
      tsUpdateKPIs();
      if (TS.activeTab === 'results') tsFilterResults();
      if (TS.activeTab === 'log') tsRenderLog();
    }
  } catch(e) { log('ERROR','tests', e.message); }
}

async function tsStartRun(opts) {
  const btn = document.getElementById('test-run-btn');
  const stopBtn = document.getElementById('ts-stop-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Running‚Ä¶';
  stopBtn.style.display = '';
  document.getElementById('ts-prog-wrap').style.display = '';
  document.getElementById('ts-prog-fill').style.width = '0%';
  document.getElementById('ts-prog-lbl').textContent = 'Starting‚Ä¶';

  TS.results = [];
  TS.summary = {};
  tsUpdateKPIs();

  try {
    const resp = await api('POST', '/api/tests/run', {
      names: opts.names,
      section: opts.section,
      log_format: TS.logFormat,
      stop_on_failure: false,
    });
    if (!resp.ok) { log('ERROR','tests', resp.error||'Failed to start'); return; }
    log('INFO','tests', `Test run started ¬∑ ${resp.total} tests ¬∑ format=${resp.log_format}`);
    tsStartPolling(resp.total);
  } catch(e) {
    log('ERROR','tests', e.message);
    btn.disabled = false;
    btn.innerHTML = '‚ñ∂ Run All';
    stopBtn.style.display = 'none';
  }
}

async function tsStop() {
  try { await api('POST', '/api/tests/stop'); log('INFO','tests','Stop requested'); }
  catch(e) {}
}

// ‚îÄ‚îÄ Polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsStartPolling(total) {
  if (TS.pollTimer) clearInterval(TS.pollTimer);
  TS.pollTimer = setInterval(async () => {
    try {
      const d = await api('GET', `/api/tests/results?format=${TS.logFormat}&limit=0`);
      if (!d.ok) return;
      TS.results = d.results || [];
      TS.summary = d.summary || {};
      const p = d.progress || {};
      const cur = p.current || 0;
      const tot = p.total || total;
      const pct = tot > 0 ? Math.round(cur / tot * 100) : 0;
      document.getElementById('ts-prog-fill').style.width = `${pct}%`;
      document.getElementById('ts-prog-pct').textContent = `${pct}%`;
      document.getElementById('ts-prog-lbl').textContent = p.current_test || '‚Ä¶';
      document.getElementById('ts-live-pass').textContent = p.passed || 0;
      document.getElementById('ts-live-fail').textContent = p.failed || 0;
      document.getElementById('ts-live-err').textContent = p.error || 0;
      document.getElementById('ts-live-skip').textContent = p.skipped || 0;
      document.getElementById('ts-live-cur').textContent = `${cur}/${tot}`;

      tsUpdateKPIs();
      tsBuildCatalogueUI();
      if (TS.activeTab === 'results') tsFilterResults();
      if (TS.activeTab === 'failures') tsRenderFailures();

      if (!p.active && p.done) {
        clearInterval(TS.pollTimer);
        TS.pollTimer = null;
        document.getElementById('ts-prog-fill').style.width = '100%';
        document.getElementById('ts-prog-pct').textContent = '100%';
        document.getElementById('ts-prog-lbl').textContent = 'Complete';
        setTimeout(() => { document.getElementById('ts-prog-wrap').style.display = 'none'; }, 2000);
        const btn = document.getElementById('test-run-btn');
        btn.disabled = false; btn.innerHTML = '‚ñ∂ Run All';
        document.getElementById('ts-stop-btn').style.display = 'none';
        tsRenderLog();
        tsRenderFailures();
        log('INFO','tests', `‚úÖ Run complete ¬∑ ${TS.summary.passed||0} passed ¬∑ ${TS.summary.failed||0} failed`);
      }
    } catch(e) {}
  }, 900);
}

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsUpdateKPIs() {
  const s = TS.summary;
  const run = TS.results.length;
  if (!run) return;
  const pass = s.passed ?? TS.results.filter(r=>r.status==='passed').length;
  const fail = s.failed ?? TS.results.filter(r=>r.status==='failed').length;
  const err = (s.error ?? TS.results.filter(r=>r.status==='error').length)
             + (s.skipped ?? TS.results.filter(r=>r.status==='skipped').length);
  const rate = s.pass_rate ?? (run > 0 ? (pass/run*100).toFixed(1) : 0);
  const ms = s.total_time_ms ?? 0;
  document.getElementById('ts-total').textContent = run;
  document.getElementById('ts-total-m').textContent = `${s.total||run} scheduled`;
  document.getElementById('ts-pass').textContent = pass;
  document.getElementById('ts-pass-rate').textContent = `${rate}% pass rate`;
  const failEl = document.getElementById('ts-fail');
  failEl.textContent = fail;
  failEl.style.color = fail > 0 ? 'var(--danger)' : 'var(--green)';
  document.getElementById('ts-fail-m').textContent = fail > 0 ? `${fail} failures` : 'all pass';
  document.getElementById('ts-errors').textContent = err;
  document.getElementById('ts-time').textContent = ms > 0 ? `${(ms/1000).toFixed(1)}s total` : '‚Äî';
}

// ‚îÄ‚îÄ Results list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsFilterResults() {
  const q = (document.getElementById('ts-search')?.value || '').toLowerCase();
  const st = document.getElementById('ts-filter-status')?.value || '';
  const sec = TS.filterSection;
  let rs = TS.results.filter(r => {
    if (st && r.status !== st) return false;
    if (sec && r.section !== sec) return false;
    if (q && !r.name.toLowerCase().includes(q) && !(r.section||'').toLowerCase().includes(q)) return false;
    return true;
  });
  const el = document.getElementById('ts-results-list');
  if (!rs.length) { el.innerHTML = '<div style="color:var(--text3);font-size:12px">No results match filter</div>'; return; }
  el.innerHTML = rs.map(r => {
    const icon = {passed:'‚úÖ',failed:'‚ùå',error:'üí•',skipped:'‚è≠'}[r.status]||'?';
    const hasDetail = r.error_msg || r.stdout || r.log_full;
    return `<div class="ts-result-card ${r.status}" onclick="this.classList.toggle('expanded')">
      <div class="ts-rc-hdr">
        <span>${icon}</span>
        <span class="ts-rc-name">${r.name}</span>
        <span class="ts-rc-ms">${r.elapsed_ms?.toFixed(0)||0}ms</span>
        ${hasDetail ? '<span style="font-size:10px;color:var(--text3)">‚ñæ</span>' : ''}
      </div>
      <div class="ts-rc-sec">${r.section||''} ¬∑ line ${r.line||0}</div>
      ${r.doc ? `<div style="font-size:10px;color:var(--text3);margin-top:3px">${r.doc}</div>` : ''}
      ${r.error_msg ? `<div class="ts-rc-err">${escHtml(r.error_msg)}</div>` : ''}
      <div class="ts-rc-detail">
        ${r.log_full ? `<div class="ts-log-block">${escHtml(r.log_full)}</div>` :
          r.log_brief ? `<div class="ts-log-block">${escHtml(r.log_brief)}</div>` : ''}
        ${r.traceback ? `<div class="ts-log-block" style="color:var(--warn)">${escHtml(r.traceback)}</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

function tsFilterSection() {
  TS.filterSection = document.getElementById('ts-filter-section')?.value || '';
  if (TS.activeTab === 'results') tsFilterResults();
}

// ‚îÄ‚îÄ Log view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsRenderLog() {
  const fmt = document.getElementById('ts-log-display-fmt')?.value || 'full';
  const show = document.getElementById('ts-log-show')?.value || 'all';
  const pre = document.getElementById('ts-log-pre');
  if (!pre) return;
  let rs = TS.results;
  if (show !== 'all') rs = rs.filter(r => r.status === show);
  if (!rs.length) { pre.textContent = '‚Äî No results yet ‚Äî'; return; }
  pre.innerHTML = rs.map(r => {
    const text = fmt === 'full' ? (r.log_full || r.log_brief || r.name) : (r.log_brief || r.name);
    const color = {passed:'var(--green)',failed:'var(--danger)',error:'var(--warn)',skipped:'var(--text3)'}[r.status]||'var(--text)';
    return `<span style="color:${color}">${escHtml(text)}</span>`;
  }).join('\n');
  pre.scrollTop = pre.scrollHeight;
}

function tsCopyLog() {
  const pre = document.getElementById('ts-log-pre');
  if (pre) { navigator.clipboard.writeText(pre.textContent); log('INFO','tests','Log copied to clipboard'); }
}

// ‚îÄ‚îÄ Failures view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsRenderFailures() {
  const el = document.getElementById('ts-failures-list');
  const rs = TS.results.filter(r => r.status === 'failed' || r.status === 'error');
  if (!rs.length) { el.innerHTML = '<div style="color:var(--green);font-size:12px">‚úÖ No failures</div>'; return; }
  el.innerHTML = rs.map(r => {
    const icon = r.status === 'error' ? 'üí•' : '‚ùå';
    return `<div class="ts-failure-card">
      <div class="ts-fc-name">${icon} ${r.name}</div>
      <div class="ts-fc-sec">${r.section||''} ¬∑ line ${r.line||0} ¬∑ ${r.elapsed_ms?.toFixed(0)||0}ms</div>
      ${r.doc ? `<div style="font-size:10px;color:var(--text3);margin-bottom:6px">${r.doc}</div>` : ''}
      <div class="ts-fc-msg">${escHtml(r.error_msg||'unknown error')}</div>
      ${r.traceback ? `<div class="ts-fc-tb">${escHtml(r.traceback)}</div>` : ''}
      ${r.stdout?.trim() ? `<div style="font-size:10px;color:var(--text3);margin-top:4px;font-family:var(--mono)">${escHtml(r.stdout.slice(0,400))}</div>` : ''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Show single test detail (from catalogue click) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tsShowTestDetail(name) {
  const r = TS.results.find(x => x.name === name);
  if (r) {
    // Switch to results tab, scroll to it
    tsTab('results');
    document.getElementById('ts-search').value = name;
    tsFilterResults();
  }
}

// ‚îÄ‚îÄ WS handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tsHandleWsEvent(msg) {
  if (msg.type === 'test_event') {
    const r = msg.data;
    const idx = TS.results.findIndex(x => x.name === r.name);
    if (idx >= 0) TS.results[idx] = r; else TS.results.push(r);
  }
  if (msg.type === 'test_progress') {
    const p = msg.data;
    if (p.current !== undefined) {
      document.getElementById('ts-live-pass').textContent = p.passed||0;
      document.getElementById('ts-live-fail').textContent = p.failed||0;
    }
  }
}

function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ Legacy stubs (keep old API calls working) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runTests() { tsRunAll(); }
async function refreshTests() { await tsRefreshCatalogue(); }


// ‚îÄ‚îÄ‚îÄ BENCHMARK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runBenchmark() {
  if(!S.modelReady) { log('WARN','bench','Model not initialized'); return; }
  const btn = document.getElementById('bench-run-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Benchmarking...';
  document.getElementById('bench-prog-wrap').style.display = 'block';
  document.getElementById('bench-prog-fill').style.width = '0%';
  const numRuns = parseInt(document.getElementById('b-runs').value);
  try {
    await api('POST', '/api/benchmark', {
      num_runs: numRuns,
      prompt: document.getElementById('b-prompt').value,
      max_length: parseInt(document.getElementById('b-maxlen').value),
      top_k: parseInt(document.getElementById('b-topk').value),
      fast: document.getElementById('b-fast').checked,
    });
    if(S.benchPollInterval) clearInterval(S.benchPollInterval);
    S.benchPollInterval = setInterval(async () => {
      try {
        const d = await api('GET', '/api/benchmark/result');
        const r = d.result || {};
        if(r.progress !== undefined) {
          document.getElementById('bench-prog-pct').textContent = `${r.progress}/${numRuns}`;
          document.getElementById('bench-prog-fill').style.width = `${(r.progress/numRuns)*100}%`;
        }
        if(!r.running && (r.mean_ms !== undefined)) {
          clearInterval(S.benchPollInterval);
          document.getElementById('bench-prog-wrap').style.display = 'none';
          S.benchData = r;
          renderBenchResult(r);
          drawBenchChart();
        }
      } catch(e) {}
    }, 800);
  } catch(e) { log('ERROR','bench',e.message); }
  finally { btn.disabled = false; btn.innerHTML = '‚ö° Run Benchmark'; }
}

async function refreshBenchmark() {
  try {
    const d = await api('GET', '/api/benchmark/result');
    if(d.result?.mean_ms !== undefined) { S.benchData = d.result; renderBenchResult(d.result); drawBenchChart(); }
  } catch(e) {}
}

function renderBenchResult(r) {
  document.getElementById('b-mean').textContent = r.mean_ms ? r.mean_ms.toFixed(1) : '‚Äî';
  document.getElementById('b-p50').textContent = r.median_ms ? r.median_ms.toFixed(1) : '‚Äî';
  document.getElementById('b-p95').textContent = r.p95_ms ? r.p95_ms.toFixed(1) : '‚Äî';
  document.getElementById('b-tput').textContent = r.throughput_rps ? r.throughput_rps.toFixed(2) : '‚Äî';
  document.getElementById('b-stats').innerHTML = [
    ['Mean', r.mean_ms, 'ms'], ['Median (P50)', r.median_ms, 'ms'],
    ['P95', r.p95_ms, 'ms'], ['P99', r.p99_ms, 'ms'],
    ['Min', r.min_ms, 'ms'], ['Max', r.max_ms, 'ms'],
    ['Std Dev', r.stddev_ms, 'ms'],
  ].map(([label, val, unit]) => `
    <div class="bench-bar">
      <span class="bench-label">${label}</span>
      <div class="bench-track"><div class="bench-fill" style="width:${val&&r.max_ms ? (val/r.max_ms*100) : 0}%"></div></div>
      <span class="bench-val">${val?val.toFixed(1):'‚Äî'}${unit}</span>
    </div>`).join('');
  document.getElementById('b-dist').innerHTML = `
    <div style="font-size:11px;color:var(--text2);line-height:1.8">
      <div>Runs: <span style="color:var(--accent)">${r.num_runs}</span></div>
      <div>Device: <span style="color:var(--accent)">${r.device||'‚Äî'}</span></div>
      <div>Params: <span style="color:var(--accent)">${r.params?.toLocaleString()||'‚Äî'}</span></div>
      <div>Throughput: <span style="color:var(--green)">${r.throughput_rps||'‚Äî'} req/s</span></div>
      ${r.errors?.length ? `<div style="color:var(--danger)">Errors: ${r.errors.length}</div>` : ''}
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ VQ CODEBOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadVQ() {
  try {
    const d = await api('GET', '/api/vq/codebook');
    if(!d.available) {
      document.getElementById('vq-size').textContent = 'N/A';
      document.getElementById('vq-util').textContent = 'disabled';
      return;
    }
    S.vqData = d;

    // Core metrics
    document.getElementById('vq-size').textContent = d.num_embeddings?.toLocaleString() || '‚Äî';
    document.getElementById('vq-dim').textContent = d.embedding_dim || '‚Äî';
    document.getElementById('vq-dead').textContent = d.dead_codes ?? '‚Äî';
    const basic = d.basic_stats || {};
    document.getElementById('vq-util').textContent = basic.usage_rate != null ? (basic.usage_rate*100).toFixed(1)+'%' :
                                                     (basic.utilization_ratio ? (basic.utilization_ratio*100).toFixed(1)+'%' : '‚Äî');
    document.getElementById('vq-util-m').textContent = `${basic.used_codes||basic.active_codes||'?'} active / ${d.num_embeddings||'?'} total`;
    document.getElementById('vq-perp').textContent = d.perplexity ?? '‚Äî';

    // Academic metrics
    document.getElementById('vq-entropy').textContent = d.entropy != null ? d.entropy.toFixed(4) : '‚Äî';
    document.getElementById('vq-entropy-sub').textContent = d.max_entropy != null ? `max: ${d.max_entropy.toFixed(4)}` : '‚Äî';
    document.getElementById('vq-nentropy').textContent = d.normalized_entropy != null ? d.normalized_entropy.toFixed(4) : '‚Äî';
    document.getElementById('vq-gini').textContent = d.gini_coefficient != null ? d.gini_coefficient.toFixed(4) : '‚Äî';
    document.getElementById('vq-steps').textContent = d.total_steps != null ? d.total_steps.toLocaleString() : '‚Äî';

    // Collapse risk
    const colEl = document.getElementById('vq-collapse');
    const risk = d.collapse_risk || 'unknown';
    colEl.innerHTML = `<span class="vq-risk-badge ${risk}">${risk}</span>`;

    // Norm statistics
    const ns = d.norm_stats || {};
    document.getElementById('vq-nm-mean').textContent = ns.mean ?? '‚Äî';
    document.getElementById('vq-nm-std').textContent = ns.std ?? '‚Äî';
    document.getElementById('vq-nm-min').textContent = ns.min ?? '‚Äî';
    document.getElementById('vq-nm-max').textContent = ns.max ?? '‚Äî';
    document.getElementById('vq-nm-med').textContent = ns.median ?? '‚Äî';
    document.getElementById('vq-nm-cv').textContent = ns.cv ?? '‚Äî';

    // Cosine similarity
    const cs = d.cosine_stats || {};
    document.getElementById('vq-cs-mean').textContent = cs.mean_similarity ?? '‚Äî';
    document.getElementById('vq-cs-max').textContent = cs.max_similarity ?? '‚Äî';
    document.getElementById('vq-cs-min').textContent = cs.min_similarity ?? '‚Äî';
    document.getElementById('vq-cs-std').textContent = cs.std_similarity ?? '‚Äî';

    // Steps since used
    const ssu = d.steps_since_used || {};
    document.getElementById('vq-ssu-mean').textContent = ssu.mean ?? '‚Äî';
    document.getElementById('vq-ssu-max').textContent = ssu.max ?? '‚Äî';
    document.getElementById('vq-ssu-std').textContent = ssu.std ?? '‚Äî';
    document.getElementById('vq-ssu-min').textContent = ssu.min ?? '‚Äî';
    document.getElementById('vq-ssu-s50').textContent = ssu.pct_stale_50 ?? '‚Äî';
    document.getElementById('vq-ssu-s100').textContent = ssu.pct_stale_100 ?? '‚Äî';

    // Status distribution
    const ss = d.status_summary || {};
    document.getElementById('vq-st-active').textContent = ss.active ?? '‚Äî';
    document.getElementById('vq-st-low').textContent = ss.low ?? '‚Äî';
    document.getElementById('vq-st-rare').textContent = ss.rare ?? '‚Äî';
    document.getElementById('vq-st-dead').textContent = ss.dead ?? '‚Äî';
    const totalStatus = (ss.active||0)+(ss.low||0)+(ss.rare||0)+(ss.dead||0) || 1;
    document.getElementById('vq-sb-active').style.width = ((ss.active||0)/totalStatus*100)+'%';
    document.getElementById('vq-sb-low').style.width = ((ss.low||0)/totalStatus*100)+'%';
    document.getElementById('vq-sb-rare').style.width = ((ss.rare||0)/totalStatus*100)+'%';
    document.getElementById('vq-sb-dead').style.width = ((ss.dead||0)/totalStatus*100)+'%';

    // Top-K used
    const topUsed = d.top_k_used || [];
    const topMax = topUsed.length ? topUsed[0].usage : 1;
    document.getElementById('vq-topk-used').innerHTML = topUsed.map(t =>
      `<div class="vq-topk-row"><span style="width:50px;color:var(--accent)">Code ${t.code}</span><div class="tk-bar"><div class="tk-fill" style="width:${(t.usage/topMax*100).toFixed(1)}%;background:var(--accent)"></div></div><span style="width:60px;text-align:right;color:var(--text2)">${t.usage.toFixed(1)}</span></div>`
    ).join('') || '<span style="color:var(--text3)">‚Äî</span>';

    const codeStatus = d.code_status || [];
    const botUsed = d.bottom_k_unused || [];
    document.getElementById('vq-topk-unused').innerHTML = botUsed.map(t => {
      const clr = codeStatus[t.code] === 'dead' ? 'var(--danger)' : 'var(--warn)';
      return `<div class="vq-topk-row"><span style="width:50px;color:${clr}">Code ${t.code}</span><div class="tk-bar"><div class="tk-fill" style="width:${Math.max(1,(t.usage/topMax*100)).toFixed(1)}%;background:${clr}"></div></div><span style="width:60px;text-align:right;color:var(--text3)">${t.usage.toFixed(2)}</span></div>`;
    }).join('') || '<span style="color:var(--text3)">‚Äî</span>';

    // Hyperparameters
    const hp = d.hyperparams || {};
    document.getElementById('vq-hp-cc').textContent = hp.commitment_cost ?? '‚Äî';
    document.getElementById('vq-hp-decay').textContent = hp.decay ?? '‚Äî';
    document.getElementById('vq-hp-eps').textContent = hp.epsilon ?? '‚Äî';
    document.getElementById('vq-hp-revival').textContent = hp.revival_threshold ?? '‚Äî';
    document.getElementById('vq-hp-split').textContent = hp.split_threshold ?? '‚Äî';
    document.getElementById('vq-hp-ema').textContent = hp.use_ema != null ? (hp.use_ema ? 'true' : 'false') : '‚Äî';

    drawVQCharts();

    // Draw heatmap
    const hm = document.getElementById('vq-heatmap');
    const counts = d.usage_counts || [];
    const n = Math.min(512, d.num_embeddings || 512);
    const maxC = Math.max(...counts.slice(0,n), 1);
    const cols = 32, rows = Math.ceil(n/cols);
    hm.style.display = 'grid';
    hm.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    hm.style.gap = '2px';
    hm.innerHTML = '';
    for(let i=0;i<n;i++) {
      const c = counts[i] || 0;
      const intensity = c / maxC;
      const el = document.createElement('div');
      el.className = 'vq-cell';
      el.style.background = `rgb(${Math.round(intensity*0)},${Math.round(intensity*212)},${Math.round(intensity*255)})`;
      el.style.aspectRatio = '1';
      el.style.borderRadius = '2px';
      const status = codeStatus[i] || (c < 0.1 ? 'dead' : 'active');
      el.title = `Code ${i}: ${c.toFixed(1)} [${status}]`;
      hm.appendChild(el);
    }
  } catch(e) { log('ERROR','vq',e.message); }
}

function exportVQDiag() {
  if (!S.vqData) { log('WARN','vq','No VQ data to export'); return; }
  const blob = new Blob([JSON.stringify(S.vqData, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `vq_diagnostics_${new Date().toISOString().slice(0,19)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  log('INFO','vq','VQ diagnostics exported');
}

// ‚îÄ‚îÄ‚îÄ MONITOR / HEALTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHealth() {
  try {
    const sys = await api('GET', '/api/status/system');
    if(sys.cpu_percent !== undefined) {
      document.getElementById('m-cpu').innerHTML = `
        <div>CPU: <span style="color:var(--accent)">${sys.cpu_percent?.toFixed(0)}%</span> ¬∑ ${sys.cpu_count} cores</div>
        <div>RAM: <span style="color:var(--accent)">${sys.ram_used_gb}/${sys.ram_total_gb} GB</span> (${sys.ram_percent?.toFixed(0)}%)</div>`;
    }
    if(sys.gpu_devices?.length) {
      document.getElementById('m-gpu').innerHTML = sys.gpu_devices.map(g =>
        `<div>${g.name.slice(0,20)}: <span style="color:var(--accent)">${g.allocated_mb}/${g.total_mb} MB</span></div>`
      ).join('');
    } else {
      document.getElementById('m-gpu').textContent = 'No CUDA device';
    }
    if(sys.process_ram_mb !== undefined) {
      document.getElementById('m-proc').innerHTML = `<div>Process RAM: <span style="color:var(--accent)">${sys.process_ram_mb} MB</span></div>
        <div>Model: <span style="color:var(--accent)">${sys.model_params?.toLocaleString()||'‚Äî'} params</span></div>
        <div>Device: <span style="color:var(--accent)">${sys.model_device||'‚Äî'}</span></div>`;
    }
  } catch(e) {}

  if(!S.modelReady) return;
  try {
    const h = await api('GET', '/api/health');
    const score = h.health_score;
    document.getElementById('m-health').textContent = score ? (score*100).toFixed(0)+'%' : '‚Äî';
    document.getElementById('m-health-bar').style.width = (score||0)*100 + '%';
    document.getElementById('m-health-m').textContent = score >= 0.9 ? 'excellent' : score >= 0.7 ? 'good' : score >= 0.5 ? 'degraded' : 'critical';
    S.healthHistory.push(score);
    if(S.healthHistory.length > 60) S.healthHistory.shift();
    drawHealthChart();

    const subsys = h.subsystems || {};
    const ssDiv = document.getElementById('m-subsys');
    ssDiv.innerHTML = Object.entries(subsys).map(([k, v]) => {
      const pct = typeof v === 'number' ? (v*100).toFixed(0) : v;
      const clr = v >= 0.8 ? 'var(--green)' : v >= 0.5 ? 'var(--warn)' : 'var(--danger)';
      return `<div class="ss-item"><div class="ss-dot" style="background:${clr}"></div><div class="ss-name">${k}</div><div class="ss-val">${pct}%</div></div>`;
    }).join('') || '<div style="font-size:11px;color:var(--text3)">No subsystems</div>';
  } catch(e) {}

  try {
    const tg = await api('GET', '/api/tensorguard');
    const r = tg.report || {};
    document.getElementById('m-nan').textContent = r.nan_count || 0;
    document.getElementById('m-inf').textContent = r.inf_count || 0;
    document.getElementById('m-san').textContent = r.sanitize_count || 0;
    document.getElementById('m-recovery').innerHTML = '‚Äî (run inference for recovery stats)';
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ TENSORGUARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadTG() {
  try {
    const d = await api('GET', '/api/tensorguard');
    const r = d.report || {};
    document.getElementById('tg-pol').textContent = r.policy || '‚Äî';
    document.getElementById('tg-nan').textContent = r.nan_count || 0;
    document.getElementById('tg-inf').textContent = r.inf_count || 0;
    document.getElementById('tg-san').textContent = r.sanitize_count || 0;
    const tbody = document.getElementById('tg-tbody');
    const history = r.history || [];
    tbody.innerHTML = history.length
      ? history.map(h => `<tr>
          <td style="color:var(--accent)">${h.context||h[0]||'‚Äî'}</td>
          <td>${JSON.stringify(h.shape||h[1]||'‚Äî')}</td>
          <td style="color:var(--warn)">${h.nan_count||h[2]||0}</td>
          <td style="color:var(--danger)">${h.inf_count||h[3]||0}</td>
        </tr>`).join('')
      : '<tr><td colspan="4" style="color:var(--text3);text-align:center;padding:20px">No NaN/Inf events</td></tr>';
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAudit() {
  try {
    const sub = document.getElementById('au-sub').value;
    const sev = document.getElementById('au-sev').value;
    const d = await api('GET', `/api/audit?subsystem=${sub}&min_severity=${sev}`);
    const entries = d.entries || [];
    S.auditData = entries;

    let inf=0, warn=0, crit=0;
    entries.forEach(e => {
      const s = e.severity || 'info';
      if(s === 'critical') crit++;
      else if(s === 'warning') warn++;
      else inf++;
    });
    document.getElementById('au-total').textContent = entries.length;
    document.getElementById('au-info').textContent = inf;
    document.getElementById('au-warn').textContent = warn;
    document.getElementById('au-crit').textContent = crit;

    const tbody = document.getElementById('au-tbody');
    tbody.innerHTML = entries.slice(-100).reverse().map(e => {
      const sev = e.severity || 'info';
      const cls = sev==='critical' ? 'br' : sev==='warning' ? 'bw' : 'ba';
      return `<tr>
        <td style="color:var(--text3)">${e.time||e.ts||'‚Äî'}</td>
        <td style="color:var(--purple)">${e.subsystem||e.name||'‚Äî'}</td>
        <td><span class="badge ${cls}">${sev}</span></td>
        <td style="color:var(--text2)">${(e.decision||e.msg||'').slice(0,80)}</td>
        <td style="font-size:10px;color:var(--text3)">${e.meta ? JSON.stringify(e.meta).slice(0,40) : ''}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="5" style="color:var(--text3);text-align:center;padding:20px">No audit entries</td></tr>';

    const insights = d.insights || {};
    document.getElementById('au-insights').textContent = Object.keys(insights).length
      ? JSON.stringify(insights, null, 2).slice(0, 400)
      : 'Insufficient data for pattern analysis';
  } catch(e) {}
}

function exportAudit() {
  const text = JSON.stringify(S.auditData, null, 2);
  const a = document.createElement('a');
  a.href = 'data:application/json,' + encodeURIComponent(text);
  a.download = `aeon_audit_${Date.now()}.json`;
  a.click();
}

// ‚îÄ‚îÄ‚îÄ OBSERVABILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadObservability() {
  try {
    // Fetch config
    const cfgR = await fetch(API + '/api/observability/config');
    const cfg = await cfgR.json();
    document.getElementById('obs-sl').textContent = cfg.structured_logging ? 'ON' : 'OFF';
    document.getElementById('obs-am').textContent = cfg.academic_mode ? 'ON' : 'OFF';
    document.getElementById('obs-tel').textContent = cfg.telemetry ? 'ON' : 'OFF';

    // Fetch metrics
    try {
      const metR = await fetch(API + '/api/telemetry/metrics');
      const met = await metR.json();
      if (met.ok) {
        const keys = Object.keys(met.metrics).filter(k => k !== 'counters');
        document.getElementById('obs-mc').textContent = keys.length;
        const tbody = document.getElementById('obs-metrics-tbody');
        if (keys.length) {
          tbody.innerHTML = keys.map(k => {
            const m = met.metrics[k];
            return `<tr><td>${k}</td><td>${m.count}</td><td>${typeof m.mean==='number'?m.mean.toFixed(4):'-'}</td><td>${typeof m.min==='number'?m.min.toFixed(4):'-'}</td><td>${typeof m.max==='number'?m.max.toFixed(4):'-'}</td><td>${typeof m.latest==='number'?m.latest.toFixed(4):'-'}</td></tr>`;
          }).join('');
        }
        // Counters
        const counters = met.metrics.counters || {};
        const cKeys = Object.keys(counters);
        document.getElementById('obs-counters').innerHTML = cKeys.length
          ? cKeys.map(k => `<span style="display:inline-block;margin:2px 6px;padding:2px 8px;background:var(--surface3);border-radius:4px">${k}: <b>${counters[k]}</b></span>`).join('')
          : 'No counters recorded';
      }
    } catch(e) { /* telemetry not available */ }

    // Fetch traces
    try {
      const trR = await fetch(API + '/api/observability/traces?last_n=50');
      const tr = await trR.json();
      if (tr.ok && tr.traces.length) {
        const tbody = document.getElementById('obs-traces-tbody');
        tbody.innerHTML = tr.traces.slice(-50).reverse().map(e => {
          const sevCls = e.severity==='error'||e.severity==='critical' ? 'color:var(--danger)' : e.severity==='warning' ? 'color:var(--warn)' : 'color:var(--text3)';
          return `<tr><td>${typeof e.timestamp==='number'?e.timestamp.toFixed(2):e.timestamp}</td><td>${e.subsystem}</td><td>${e.decision}</td><td style="${sevCls}">${e.severity}</td></tr>`;
        }).join('');
      }
    } catch(e) { /* traces not available */ }
  } catch(e) { log('ERROR','observability',e.message); }
}

function exportTelemetry() {
  fetch(API + '/api/telemetry/metrics').then(r=>r.json()).then(d=>{
    const a = document.createElement('a');
    a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(d, null, 2));
    a.download = `aeon_telemetry_${Date.now()}.json`;
    a.click();
  }).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ SESSION EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportSession() {
  try {
    const r = await fetch(API + '/api/session/export');
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'aeon_session.json'; a.click();
    log('INFO','session','Session exported');
  } catch(e) { log('ERROR','session',e.message); }
}

// ‚îÄ‚îÄ‚îÄ CODE GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genCode() {
  const p = buildInitPayload();
  const flags = Object.entries(p).filter(([k,v])=>k.startsWith('enable_')&&v===true).map(([k])=>`    ${k}=True,`).join('\n');
  document.getElementById('code-init').textContent = `from core import AEONConfig, AEONDeltaV3, set_seed
import torch

set_seed(${p.seed||42})

config = AEONConfig(
    hidden_dim=${p.hidden_dim},
    z_dim=${p.z_dim},
    vq_embedding_dim=${p.vq_embedding_dim},
    vq_num_embeddings=${p.vq_num_embeddings},
    vocab_size=${p.vocab_size},
    seq_length=${p.seq_length},
    encoder_backend="${p.encoder_backend}",
    decoder_backend="${p.decoder_backend}",
    device_str="${p.device_str}",
    max_iterations=${p.max_iterations},
    lipschitz_target=${p.lipschitz_target},
    nan_policy="${p.nan_policy}",
${flags}
)

model = AEONDeltaV3(config)
model.eval()
print(f"Parameters: {model.count_parameters():,}")
print(f"Trainable:  {model.count_trainable_parameters():,}")
print(f"Device:     {model.device}")`;

  document.getElementById('code-infer').textContent = `result = model.generate(
    "What is consciousness?",
    max_length=${p.seq_length},
    temperature=0.8,
    top_k=50,
    sample=True,
)
print(result['text'])
print(f"Status: {result['status']}")

# Raw forward pass
x = torch.randint(0, ${p.vocab_size}, (1, ${p.seq_length}))
with torch.no_grad():
    out = model(x)
print(out.keys())
print(f"Logits: {out['logits'].shape}")
print(f"Safety: {out['safety_score']}")
print(f"Convergence delta: {out.get('convergence_delta', 'N/A')}")`;

  document.getElementById('code-train').textContent = `from core import AEONTrainer
from torch.utils.data import Dataset

class TextDataset(Dataset):
    def __init__(self, ids): self.data = ids
    def __len__(self): return len(self.data)
    def __getitem__(self, i): return {'input_ids': self.data[i], 'labels': self.data[i]}

trainer = AEONTrainer(model=model, config=config,
    train_dataset=TextDataset(train_ids),
    eval_dataset=TextDataset(eval_ids))
trainer.train(num_epochs=10)
model.save_state("./checkpoints/aeon_state")`;

  document.getElementById('code-intro').textContent = `# ‚îÄ‚îÄ‚îÄ Introspection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
summary  = model.get_audit_summary()
recent   = model.get_recent_decisions(10)
warnings = model.audit_log.filter_by(subsystem="safety", min_severity="warning")
insights = model.audit_log.get_pattern_insights()
model.audit_log.export_json("audit.json")

# TensorGuard
model.tensor_guard.print_report()

# Recovery stats
stats = model.error_recovery.get_recovery_stats()
print(stats['by_class'])

# Architecture
model.print_architecture_summary()
print(f"Params:    {model.count_parameters():,}")
print(f"Trainable: {model.count_trainable_parameters():,}")

# VQ codebook
if model.vector_quantizer:
    vq_stats = model.vector_quantizer.get_codebook_usage_stats()
    print(vq_stats)

# Config save/load
config.save("config.json")
config2 = AEONConfig.load("config.json")`;

  document.getElementById('code-cli').textContent = `# Demo
python core.py --mode demo --device auto

# Training
python core.py --mode train --epochs 10 --batch-size 16 --lr 3e-5

# Inference
python core.py --mode infer --prompt "What is consciousness?" --max-length ${p.seq_length}

# Full test suite
python core.py --mode test

# With config file
python core.py --mode train --config aeon_config.json`;

  document.getElementById('code-bench').textContent = `# HTTP Benchmark via dashboard API
import requests, statistics, time

API = "http://localhost:8000"
resp = requests.post(f"{API}/api/benchmark", json={
    "num_runs": 50,
    "prompt": "Benchmark test",
    "max_length": ${p.seq_length},
    "fast": True,
    "top_k": 50,
})
print("Benchmark started:", resp.json())

# Poll for results
import time
while True:
    r = requests.get(f"{API}/api/benchmark/result").json()
    res = r["result"]
    if not res.get("running") and "mean_ms" in res:
        print(f"Mean: {res['mean_ms']:.1f}ms")
        print(f"P95:  {res['p95_ms']:.1f}ms")
        print(f"Tput: {res['throughput_rps']:.2f} req/s")
        break
    print(f"Progress: {res.get('progress', 0)}")
    time.sleep(1)`;

  document.getElementById('code-server').textContent = `# Start AEON Dashboard Server
pip install fastapi uvicorn psutil

python aeon_server.py --host 0.0.0.0 --port 8000

# With auto-reload for development
python aeon_server.py --reload

# All endpoints:
# GET  /api/status           ‚Äî model & server status
# GET  /api/status/system    ‚Äî CPU/RAM/GPU stats
# POST /api/init             ‚Äî initialize model
# POST /api/deinit           ‚Äî release model
# POST /api/config/validate  ‚Äî validate config
# POST /api/infer            ‚Äî generate text
# POST /api/forward          ‚Äî raw forward pass
# POST /api/train/start      ‚Äî start training
# POST /api/train/stop       ‚Äî stop training
# GET  /api/train/progress   ‚Äî training status
# GET  /api/train/gradient_stats ‚Äî grad norms
# POST /api/benchmark        ‚Äî latency profiling
# GET  /api/benchmark/result ‚Äî benchmark results
# POST /api/test/run         ‚Äî run test suite
# GET  /api/test/result      ‚Äî test results
# GET  /api/introspect       ‚Äî full introspection
# GET  /api/introspect/modules ‚Äî module inspector
# GET  /api/audit            ‚Äî audit trail
# GET  /api/tensorguard      ‚Äî TG report
# GET  /api/health           ‚Äî health score
# GET  /api/architecture     ‚Äî arch summary
# GET  /api/vq/codebook      ‚Äî VQ codebook detail
# POST /api/save             ‚Äî save checkpoint
# POST /api/load             ‚Äî load checkpoint
# GET  /api/config           ‚Äî current config
# GET  /api/session/export   ‚Äî export session JSON
# GET  /api/logs             ‚Äî log history
# GET  /api/logs/stream      ‚Äî SSE log stream
# WS   /ws                   ‚Äî WebSocket live feed`;
}

function codeTab(name) {
  document.querySelectorAll('[id^="codetab-"]').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tbar .tbtn').forEach(b => {
    if(b.getAttribute('onclick')?.includes(name)) b.classList.add('active');
    else b.classList.remove('active');
  });
  const panel = document.getElementById('codetab-' + name);
  if(panel) panel.classList.add('active');
}

function cpCode(btn) {
  const pre = btn.nextElementSibling;
  navigator.clipboard?.writeText(pre?.textContent || '');
  btn.textContent = '‚úì'; setTimeout(() => btn.textContent = 'copy', 1500);
}

// ‚îÄ‚îÄ‚îÄ CONFIG TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cTab(name) {
  document.querySelectorAll('[id^="ctab-"]').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('#cfg-tbar .tbtn').forEach(b => {
    if(b.getAttribute('onclick')?.includes(name)) b.classList.add('active');
    else b.classList.remove('active');
  });
  const panel = document.getElementById('ctab-' + name);
  if(panel) panel.classList.add('active');
  if(name === 'json-ed') syncJsonEditor();
}

// ‚îÄ‚îÄ‚îÄ RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => {
  if(S.activePanel === 'training') { drawLossChart(); drawGradChart(); drawStepLossChart(); }
  if(S.activePanel === 'monitor') drawHealthChart();
  if(S.activePanel === 'benchmark') drawBenchChart();
  if(S.activePanel === 'vq') drawVQCharts();
  if(S.activePanel === 'modules') drawModChart([], 1);
});

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
connectWS();
log('INFO','dashboard','AEON Dashboard v3.2.0 initializing ¬∑ connecting to server...');
genCode();
applyPreset('production');
// Fetch initial logs via REST as WS fallback
setTimeout(async () => {
  try {
    const d = await api('GET', '/api/logs?limit=150');
    (d.logs || []).forEach(e => { if(!S.logEntries.find(ex => ex.ts === e.ts)) appendLog(e); });
  } catch(e) {}
}, 2000);
</script>
</body>
</html>
